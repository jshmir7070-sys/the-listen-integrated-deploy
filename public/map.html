<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì§€ë„ - The Listen</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
<style>
  :root{--brand:#007bff;--ok:#10b981;--muted:#6b7280;--border:#e5e7eb;--danger:#ef4444;--bg:#f7f9fc}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:10px;font-weight:800}
  #map{width:100%;height:90vh}
  .btn{border:none;border-radius:10px;padding:10px 14px;color:#fff;font-weight:700;cursor:pointer;margin:4px}
  .btn.blue{background:var(--brand)} .btn.gray{background:#6b7280} .btn.green{background:var(--ok)} .btn.red{background:var(--danger)}
  .muted{color:var(--muted)} .flex{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  /* í•˜ë‹¨ ìƒì„¸ì¹´ë“œ (ì§€ë„ì—ì„œë§Œ) */
  #detail{position:fixed;left:0;bottom:0;width:100%;background:#fff;border-radius:16px 16px 0 0;
          box-shadow:0 -4px 16px rgba(0,0,0,.25);transform:translateY(100%);transition:transform .3s;z-index:4}
  #detail.active{transform:translateY(0)}
  .inner{padding:14px}
  .title{font-weight:900;margin-bottom:6px;text-align:center}
  .kv{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:center}
  .list{max-height:36vh;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px}
  .wb{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px 10px;margin-bottom:6px;cursor:pointer}
  .badge{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;border-radius:50%;background:#007bff;color:#fff;font-weight:900}
  .my-location{width:12px;height:12px;background:rgba(0,123,255,.95);border-radius:50%;border:2px solid #fff}
  /* ëª¨ë‹¬ (í™”ë¬¼ì¶”ì ) */
  #trace{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:5}
  .sheet{background:#fff;max-width:520px;width:92%;border-radius:14px;padding:14px}
  .row{display:flex;gap:8px} .col{flex:1}
  img.thumb{width:100%;height:160px;object-fit:cover;border:1px solid #ddd;border-radius:10px}
</style>
</head>
<body>
<header>ğŸ—º ì§€ë„ - The Listen</header>
<div id="map"></div>

<!-- ìƒì„¸ ê³ ê°ì¹´ë“œ (ì§€ë„ ì „ìš©) -->
<div id="detail">
  <div class="inner">
    <div id="dTitle" class="title">ê³ ê° ìƒì„¸</div>
    <div id="dAddr" class="muted" style="text-align:center;margin-bottom:6px"></div>

    <div class="kv">
      <label><input type="checkbox" id="faceChk"> ëŒ€ë©´ë°°ì†¡(ì‚¬ì§„ ì—†ì´ ì™„ë£Œ)</label>
      <label><input type="checkbox" id="storeChk"> ë³´ê´€ì¥ì†Œ(ì‚¬ì§„ í•„ìˆ˜)</label>
      <select id="placeSel" style="padding:8px;border:1px solid var(--border);border-radius:8px">
        <option>ë¬¸ì•</option><option>íƒë°°ë³´ê´€í•¨</option><option>ê²½ë¹„ì‹¤</option><option>ê³ ê°ìš”ì²­ì¥ì†Œ</option>
      </select>
    </div>

    <div class="flex" style="margin-top:8px">
      <button class="btn blue" id="btnPhoto">ğŸ“¸ ì‚¬ì§„ì´¬ì˜</button>
      <button class="btn green" id="btnDone" disabled>âœ… ë°°ì†¡ì™„ë£Œ</button>
      <button class="btn gray" id="btnClose">ë‹«ê¸°</button>
    </div>

    <div class="title" style="margin-top:10px">ìš´ì†¡ì¥ ëª©ë¡</div>
    <div id="wbList" class="list"></div>
  </div>
</div>

<!-- ìš´ì†¡ì¥ í™”ë¬¼ì¶”ì  ëª¨ë‹¬ -->
<div id="trace">
  <div class="sheet">
    <h3 style="margin:4px 0" id="tWb"></h3>
    <div class="muted" id="tStatus" style="margin-bottom:8px"></div>
    <div class="row">
      <div class="col">
        <b>ë°œì†¡ì¸</b><div id="tShipper" class="muted"></div>
      </div>
      <div class="col">
        <b>ìˆ˜ì·¨ì¸</b><div id="tRecv" class="muted"></div>
      </div>
    </div>
    <div style="margin-top:8px"><b>ì œí’ˆ</b> <span id="tProd" class="muted"></span></div>
    <div style="margin:8px 0"><b>ê²½ë¡œ</b> <div class="muted" id="tRoute">ì§‘í•˜â†’ í—ˆë¸Œ â†’ ë°°ë‹¬ì¶œë°œ</div></div>
    <div class="row" style="gap:10px;margin-top:8px">
      <img id="tImg0" class="thumb" alt="ìµœê·¼ì‚¬ì§„">
      <img id="tImg1" class="thumb" alt="ì§ì „ì‚¬ì§„">
    </div>
    <div class="flex"><button class="btn gray" onclick="hideTrace()">ë‹«ê¸°</button></div>
  </div>
</div>

<script>
/* ---------- ë°ì´í„° ---------- */
const FINAL_KEY='deliveriesJSON';
const COMPLETED_KEY='completed';
const PH_WB = code => `photos_wb_${code}`; // ìš´ì†¡ì¥ë³„ ì‚¬ì§„
let deliveries=[];
try{ deliveries = JSON.parse(localStorage.getItem(FINAL_KEY)||'[]'); }catch{ deliveries=[]; }

/* ---------- ì§€ë„ ---------- */
const map=new kakao.maps.Map(document.getElementById('map'),{center:new kakao.maps.LatLng(37.3795,126.806),level:5});
const bounds = new kakao.maps.LatLngBounds();
const markerByCid = {}; // ê³ ê°(ì¹´ë“œ) ë‹¨ìœ„

// ë‚´ ìœ„ì¹˜ ì 
let myDot=null;
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    const p=new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
    if(!myDot) myDot=new kakao.maps.CustomOverlay({map,position:p,content:'<div class="my-location"></div>'});
    else myDot.setPosition(p);
  },()=>{}, {enableHighAccuracy:true});
}

// ê³ ê° ID ë¶€ì—¬(ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì´ë¦„+ì „í™” í•´ì‹œ)
function cidOf(c){ return c.id || `${c.name||''}|${c.phone||''}|${c.address||''}`; }

// ë§ˆì»¤ ìƒì„±
deliveries.forEach((c,i)=>{
  const el=document.createElement('div');
  el.style.cssText=`width:30px;height:30px;background:#007bff;color:#fff;border-radius:50%;
    display:flex;align-items:center;justify-content:center;font-weight:900;border:2px solid #fff;cursor:pointer`;
  el.textContent=c.order || (i+1);
  const mk=new kakao.maps.CustomOverlay({map,position:new kakao.maps.LatLng(c.lat||37.3795,c.lng||126.806),content:el});
  markerByCid[cidOf(c)] = mk;
  bounds.extend(new kakao.maps.LatLng(c.lat||37.3795,c.lng||126.806));
  el.onclick=()=>openDetail(c);
});
if(!bounds.isEmpty()) map.setBounds(bounds);

/* ---------- ìƒì„¸ì¹´ë“œ (map ì „ìš©) ---------- */
const detail = document.getElementById('detail');
const dTitle = document.getElementById('dTitle');
const dAddr  = document.getElementById('dAddr');
const wbList = document.getElementById('wbList');
const faceChk= document.getElementById('faceChk');
const storeChk=document.getElementById('storeChk');
const placeSel= document.getElementById('placeSel');
const btnPhoto= document.getElementById('btnPhoto');
const btnDone = document.getElementById('btnDone');
const btnClose= document.getElementById('btnClose');

let SEL=null;           // í˜„ì¬ ê³ ê°
let photoOK=false;      // ë³´ê´€ì¥ì†Œ ì„ íƒì‹œ ì‚¬ì§„ ì—¬ë¶€

function openDetail(c){
  SEL=c; photoOK=false; btnDone.disabled=true;
  dTitle.textContent = `${c.name||'ê³ ê°'} Â· ğŸ“¦ ${(c.waybills||[]).length}ê°œ`;
  dAddr.textContent  = c.address || '';

  faceChk.checked=false; storeChk.checked=false; placeSel.value='ë¬¸ì•';
  renderWBList();
  applyButtonsState();
  detail.classList.add('active');
}
btnClose.onclick=()=>detail.classList.remove('active');

// ìš´ì†¡ì¥ ë¦¬ìŠ¤íŠ¸(í´ë¦­ â†’ ì¶”ì ëª¨ë‹¬)
function renderWBList(){
  const arr = SEL?.waybills || [];
  wbList.innerHTML = arr.map(w=>`
    <div class="wb" data-code="${w.code}">
      <div><span class="badge">#</span> ${w.code}</div>
      <div class="muted">${w.productName||''} ${w.fragile?'Â· ì·¨ê¸‰ì£¼ì˜':''}</div>
    </div>
  `).join('') || '<div class="muted">ìš´ì†¡ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

  wbList.querySelectorAll('.wb').forEach(el=>{
    el.onclick = ()=> showTrace(el.getAttribute('data-code'));
  });
}

/* ìƒíƒœ ê·œì¹™
  - ëŒ€ë©´ë°°ì†¡ ì²´í¬ì‹œ: ì‚¬ì§„ ì—†ì´ ì™„ë£Œ ê°€ëŠ¥(ì™„ë£Œ ë²„íŠ¼ í™œì„±)
  - ë³´ê´€ì¥ì†Œ ì²´í¬ì‹œ: ì‚¬ì§„ í•„ìˆ˜(ì‚¬ì§„ ì—…ë¡œë“œ ì´í›„ ì™„ë£Œ ë²„íŠ¼ í™œì„±)
  - ë‘˜ ë‹¤ ë¯¸ì²´í¬: ê¸°ë³¸ ë¬¸ì• â†’ ììœ (ì‚¬ì§„ ì—†ì´ë„ ê°€ëŠ¥í•˜ë„ë¡ ìœ ì§€)
*/
function applyButtonsState(){
  if(faceChk.checked){
    btnPhoto.disabled = true;
    btnDone.disabled  = false; // ì‚¬ì§„ ì—†ì´ ê°€ëŠ¥
  }else if(storeChk.checked){
    btnPhoto.disabled = false;
    btnDone.disabled  = !photoOK; // ì‚¬ì§„ ì°ì–´ì•¼ ê°€ëŠ¥
  }else{
    // ê¸°ë³¸ ë¬¸ì•: ì‚¬ì§„ ì—†ì–´ë„ ì™„ë£Œ ê°€ëŠ¥(ìš”ì²­ì— ëª…ì‹œ ì—†ìœ¼ë¯€ë¡œ ìœ ì—° ì²˜ë¦¬)
    btnPhoto.disabled = false;
    btnDone.disabled  = false;
  }
}
faceChk.onchange=()=>{ if(faceChk.checked) storeChk.checked=false; applyButtonsState(); };
storeChk.onchange=()=>{ if(storeChk.checked) faceChk.checked=false; applyButtonsState(); };

/* ì‚¬ì§„ì´¬ì˜ â†’ ìš´ì†¡ì¥ ë‹¨ìœ„ë¡œ ìµœì‹  2ì¥ê¹Œì§€ ëª¨ì•„ë‘ê¸°(ëŒ€í‘œ ìš´ì†¡ì¥ì— ê¸°ë¡) */
btnPhoto.onclick=()=>{
  if(!SEL || !(SEL.waybills||[]).length) return alert('ìš´ì†¡ì¥ì´ ì—†ìŠµë‹ˆë‹¤.');
  const targetCode = SEL.waybills[0].code; // ëŒ€í‘œ ìš´ì†¡ì¥(ì²«ë²ˆì§¸)ì— ì €ì¥
  const inp=document.createElement('input');
  inp.type='file'; inp.accept='image/*'; inp.capture='environment';
  inp.onchange=e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const rd=new FileReader();
    rd.onload=()=>{
      const key=PH_WB(targetCode);
      const arr = JSON.parse(localStorage.getItem(key)||'[]');
      arr.unshift({ts:Date.now(),data:rd.result});
      localStorage.setItem(key, JSON.stringify(arr.slice(0,10)));
      photoOK=true; applyButtonsState();
      alert('ğŸ“¸ ì‚¬ì§„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };
    rd.readAsDataURL(f);
  };
  inp.click();
};

/* ë°°ì†¡ì™„ë£Œ â†’ ê³ ê° ë‹¨ìœ„ ì™„ë£Œ(ëª¨ë“  ìš´ì†¡ì¥ ê¸°ë¡) + ë§ˆì»¤ ë°˜íˆ¬ëª… */
btnDone.onclick=()=>{
  if(!SEL) return;
  if(storeChk.checked && !photoOK) return alert('ë³´ê´€ì¥ì†Œ ì„ íƒ ì‹œ ì‚¬ì§„ì´ í•„ìš”í•©ë‹ˆë‹¤.');

  const comp = JSON.parse(localStorage.getItem(COMPLETED_KEY)||'[]');
  const codes = (SEL.waybills||[]).map(w=>w.code);
  codes.forEach(code=>comp.push({id:code,date:new Date().toISOString(),addr:SEL.address}));
  localStorage.setItem(COMPLETED_KEY, JSON.stringify(comp));

  const mk = markerByCid[cidOf(SEL)];
  if(mk) mk.getContent().style.opacity='0.4';

  alert(`âœ… ë°°ì†¡ì™„ë£Œ ì²˜ë¦¬: ${codes.length}ê±´`);
  detail.classList.remove('active');
};

/* ---------- í™”ë¬¼ì¶”ì  ëª¨ë‹¬ ---------- */
const trace = document.getElementById('trace');
const tWb = document.getElementById('tWb');
const tStatus = document.getElementById('tStatus');
const tShipper = document.getElementById('tShipper');
const tRecv = document.getElementById('tRecv');
const tProd = document.getElementById('tProd');
const tImg0 = document.getElementById('tImg0');
const tImg1 = document.getElementById('tImg1');

function showTrace(code){
  // ì„ íƒ ì½”ë“œì— í•´ë‹¹í•˜ëŠ” ìš´ì†¡ì¥ ì°¾ê¸°
  const wb = (SEL?.waybills||[]).find(w=>w.code===code);
  if(!wb) return;

  tWb.textContent   = `ìš´ì†¡ì¥ ${wb.code}`;
  tStatus.textContent = `ìƒíƒœ: ${wb.status || 'ì´ë™ì¤‘'}`;
  tShipper.textContent = wb.shipper || '-';
  tRecv.textContent    = wb.recipient || (SEL?.name||'-');
  tProd.textContent    = `${wb.productName||'-'}${wb.fragile?' (ì·¨ê¸‰ì£¼ì˜)':''}`;

  // ìš´ì†¡ì¥ ë‹¨ìœ„ ì‚¬ì§„ ë‘ ì¥(ìµœê·¼/ì§ì „)
  const key = PH_WB(wb.code);
  const arr = JSON.parse(localStorage.getItem(key)||'[]');
  tImg0.src = arr[0]?.data || ''; tImg0.alt = arr[0]?'ìµœê·¼ì‚¬ì§„':'ìµœê·¼ì‚¬ì§„ ì—†ìŒ';
  tImg1.src = arr[1]?.data || ''; tImg1.alt = arr[1]?'ì§ì „ì‚¬ì§„':'ì§ì „ì‚¬ì§„ ì—†ìŒ';

  trace.style.display='flex';
}
function hideTrace(){ trace.style.display='none'; }

window.hideTrace = hideTrace;
</script>
</body>
</html>
