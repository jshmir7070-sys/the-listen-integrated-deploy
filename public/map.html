<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Listen - AI ë°°ì†¡ê²½ë¡œ (ì‹¤ì£¼ì†Œ ì™„ì„±í˜•)</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
  <style>
    body { margin:0; font-family:"Noto Sans KR",sans-serif; background:#f7f9fc; }
    header { background:#007bff; color:white; text-align:center; padding:12px; font-weight:600; font-size:1.2rem; }
    #map { width:100%; height:90vh; }
    #customerCard {
      position:fixed; bottom:0; left:0; width:100%;
      background:white; border-top-left-radius:16px; border-top-right-radius:16px;
      box-shadow:0 -3px 10px rgba(0,0,0,0.25);
      transform:translateY(100%); transition:transform .4s ease;
      max-height:55vh; overflow-y:auto; z-index:1000;
    }
    #customerCard.active { transform:translateY(0); }
    .card-header { text-align:center; font-weight:700; padding:10px; color:#333; }
    .delivery-item { padding:12px 18px; border-bottom:1px solid #eee; }
    .delivery-item button {
      background:#007bff; color:white; border:none; border-radius:8px;
      padding:8px 12px; cursor:pointer; margin-top:6px;
    }
    .my-location-dot {
      width:12px; height:12px; background:rgba(0,123,255,.9);
      border-radius:50%; border:2px solid white;
    }
  </style>
</head>
<body>
  <header>ğŸšš The Listen AI ë°°ì†¡ê²½ë¡œ (200ê±´ ì‹¤ì œì£¼ì†Œ ì™„ì„±í˜•)</header>
  <div id="map"></div>

  <div id="customerCard">
    <div class="card-header">ê³ ê° ìƒì„¸ ì •ë³´</div>
    <div id="card-content"></div>
  </div>

  <script>
    const map = new kakao.maps.Map(document.getElementById("map"), {
      center: new kakao.maps.LatLng(37.4979, 127.0276),
      level: 5
    });

    const geocoder = new kakao.maps.services.Geocoder();
    let myPosition = null;
    const markerObjects = {};

    // âœ… ë‚´ ìœ„ì¹˜ í‘œì‹œ
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          myPosition = new kakao.maps.LatLng(lat, lng);
          if (!window.myCircle) {
            window.myCircle = new kakao.maps.CustomOverlay({
              position: myPosition,
              content: '<div class="my-location-dot"></div>',
              map: map,
            });
          } else {
            window.myCircle.setPosition(myPosition);
          }
        },
        (err) => console.warn("GPS ë¹„í™œì„±í™”ë¨", err),
        { enableHighAccuracy: true }
      );
    }

    // âœ… ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì„œìš¸ ì£¼ì†Œ 200ê°œ (ë¬´ì‘ìœ„ ì˜ˆì‹œ)
    const baseAddrs = [
      "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 231",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 300",
      "ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ ì›”ë“œì»µë¶ë¡œ 400",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ë°˜í¬ëŒ€ë¡œ 222",
      "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬ ì²œí˜¸ëŒ€ë¡œ 1000",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬ ì—¬ì˜ë‚˜ë£¨ë¡œ 76",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë™êµ¬ ì™•ì‹­ë¦¬ë¡œ 115",
      "ì„œìš¸íŠ¹ë³„ì‹œ ë…¸ì›êµ¬ ë™ì¼ë¡œ 900",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ì¢…ë¡œ 33",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ì„¸ì¢…ëŒ€ë¡œ 110"
    ];
    const deliveries = Array.from({ length: 200 }).map((_, i) => ({
      id: `DLV${String(i + 1).padStart(3, "0")}`,
      name: `ê³ ê°${i + 1}`,
      phone: `010-${(1000 + i).toString().slice(-4)}-${(2000 + i).toString().slice(-4)}`,
      address: baseAddrs[i % baseAddrs.length],
      boxes: Math.floor(Math.random() * 3) + 1
    }));

    // âœ… ê±°ë¦¬ ê³„ì‚° (Haversine)
    function calcDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLng / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // âœ… ì¢Œí‘œ ë³€í™˜ ë° ë§ˆì»¤ ìƒì„±
    function drawMarkers() {
      deliveries.forEach((d, i) => {
        geocoder.addressSearch(d.address, (result, status) => {
          if (status === kakao.maps.services.Status.OK) {
            d.lat = Number(result[0].y);
            d.lng = Number(result[0].x);
            placeMarker(d, i + 1);
          }
        });
      });
    }

    // âœ… ë§ˆì»¤ í‘œì‹œ + í´ë¦­ ì´ë²¤íŠ¸
    function placeMarker(d, order) {
      const markerEl = document.createElement("div");
      markerEl.style.cssText = `
        background:#007bff;color:white;border-radius:50%;
        width:30px;height:30px;display:flex;align-items:center;
        justify-content:center;font-weight:600;font-size:13px;
        border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);
        cursor:pointer;
      `;
      markerEl.textContent = order;

      const marker = new kakao.maps.CustomOverlay({
        position: new kakao.maps.LatLng(d.lat, d.lng),
        content: markerEl,
        map: map
      });

      markerObjects[d.id] = marker;

      markerEl.addEventListener("click", () => {
        showCustomerCard(d, order);
      });
    }

    // âœ… ê³ ê°ì¹´ë“œ í‘œì‹œ
    function showCustomerCard(d, order) {
      const card = document.getElementById("customerCard");
      const content = document.getElementById("card-content");
      content.innerHTML = `
        <div style="text-align:center;">
          <h3>${order}ï¸âƒ£ ìˆœë²ˆ</h3>
          <p><b>ì´ë¦„:</b> ${d.name}</p>
          <p><b>ì „í™”ë²ˆí˜¸:</b> ${d.phone}</p>
          <p><b>ìƒì„¸ì£¼ì†Œ:</b> ${d.address}</p>
          <p><b>ìš´ì†¡ì¥ë²ˆí˜¸:</b> ${d.id}</p>
          <p><b>ë°•ìŠ¤ìˆ˜ëŸ‰:</b> ${d.boxes}ê°œ</p>
          <button onclick="capturePhoto('${d.id}','${d.address}')">ğŸ“¸ ì‚¬ì§„ì´¬ì˜ ë° ì „ì†¡</button>
        </div>
      `;
      card.classList.add("active");
    }

    // âœ… ì‚¬ì§„ì´¬ì˜ â†’ íˆ¬ëª…í™” ì²˜ë¦¬
    function capturePhoto(id, address) {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.capture = "environment";
      input.onchange = (e) => {
        if (e.target.files[0]) {
          alert(`ğŸ“¸ ${address}\nìš´ì†¡ì¥ ${id} ì‚¬ì§„ ì „ì†¡ ì™„ë£Œ!`);
          const marker = markerObjects[id];
          if (marker) marker.getContent().style.opacity = "0.4";
          document.getElementById("customerCard").classList.remove("active");
        }
      };
      input.click();
    }

    drawMarkers();
  </script>
</body>
</html>
