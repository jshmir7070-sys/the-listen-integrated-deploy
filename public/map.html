<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>í˜„ì¬ ì§€ë„ - The Listen</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
<style>
  body{margin:0;font-family:"Noto Sans KR",sans-serif;background:#f7f9fc}
  header{background:#007bff;color:#fff;text-align:center;padding:10px;font-weight:800}
  #map{width:100%;height:90vh;position:relative}
  /* í•˜ë‹¨ ì¹´ë“œ */
  #card{position:fixed;left:0;bottom:0;width:100%;background:#fff;border-radius:16px 16px 0 0;
        box-shadow:0 -4px 14px rgba(0,0,0,.2);transform:translateY(100%);transition:transform .35s;z-index:3}
  #card.active{transform:translateY(0)}
  .card-inner{padding:14px 14px 8px}
  .title{font-weight:900;margin-bottom:6px;text-align:center}
  .muted{color:#6b7280}
  .btn{border:none;padding:10px 14px;border-radius:10px;margin:6px;color:#fff;background:#007bff;font-weight:700;cursor:pointer}
  .btn.gray{background:#6b7280}
  .btn.red{background:#ef4444}
  .btn.green{background:#10b981}
  .btn.row{width:calc(50% - 8px)}
  .flex{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .list{max-height:42vh;overflow:auto;border:1px solid #eef2f7;border-radius:12px;padding:8px}
  .item{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-bottom:8px}
  .item .line1{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .badge{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;border-radius:999px;
         color:#fff;font-weight:900;border:2px solid #fff;font-size:13px}
  .tel{color:#007bff;text-decoration:none}
  .section-title{font-weight:900;margin:6px 0 4px}
  /* ë‚´ ìœ„ì¹˜ */
  .my-location{width:12px;height:12px;background:rgba(0,123,255,.95);border-radius:50%;border:2px solid #fff}
  /* ì‚¬ì§„ ê¸°ë¡ ì¸ë„¤ì¼ */
  .thumbs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .thumbs img{width:88px;height:88px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb}
</style>
</head>
<body>
<header>ğŸ—º ì‹¤ì‹œê°„ ì§€ë„ - The Listen</header>
<div id="map"></div>

<!-- í•˜ë‹¨ ì¹´ë“œ -->
<div id="card">
  <div class="card-inner">
    <div id="cardHead" class="title">ê³ ê° ìƒì„¸ ì •ë³´</div>
    <div id="cardAddr" class="muted" style="text-align:center"></div>

    <div class="section-title">ë™ ë‚´ ê³ ê° (ê³ ì¸µ â†’ ì €ì¸µ)</div>
    <div id="groupList" class="list"></div>

    <div class="section-title">ì‚¬ì§„ ê¸°ë¡</div>
    <div id="photoArea" class="thumbs"></div>

    <div class="flex">
      <button class="btn" onclick="triggerPhoto()">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜/ì „ì†¡</button>
      <button class="btn green" onclick="completeDelivery()">âœ… ë°°ë‹¬ì™„ë£Œ</button>
      <button class="btn gray" onclick="closeCard()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
/** ============ ì§€ë„ ì´ˆê¸°í™” ============ **/
const map = new kakao.maps.Map(document.getElementById("map"),{
  center: new kakao.maps.LatLng(37.3795,126.806), level:5
});
const geocoder = new kakao.maps.services.Geocoder();

/** ============ ë°ì´í„° ë¡œë“œ ============ **/
let deliveries = []; 
try { deliveries = JSON.parse(localStorage.getItem('deliveriesJSON')||'[]'); } catch(e) { deliveries = []; }
if (!deliveries.length) {
  deliveries = [{ id:"TEST-101-202", name:"í…ŒìŠ¤íŠ¸ê³ ê°", phone:"010-0000-0000",
    address:"ê²½ê¸°ë„ ì‹œí¥ì‹œ ìˆ˜í’€ì•ˆê¸¸ 19-30 101ë™ 202í˜¸", boxes:1, lat:37.3798, lng:126.8062, order:1 }];
}

/** ============ ë‚´ ìœ„ì¹˜ í‘œì‹œ ============ **/
let myCircle=null;
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos=>{
    const now = new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
    if (!myCircle) {
      myCircle = new kakao.maps.CustomOverlay({ map, position: now, content:'<div class="my-location"></div>' });
    } else {
      myCircle.setPosition(now);
    }
  },()=>{}, {enableHighAccuracy:true});
}

/** ============ ë³´ì¡° ìœ í‹¸ ============ **/
// ì£¼ì†Œì—ì„œ "ë™"ê³¼ "í˜¸"ë¥¼ íŒŒì‹± (ë„ì–´ì“°ê¸°/í•˜ì´í”ˆ/ì½¤ë¹„ ëŒ€ì‘)
function parseDongHo(address="") {
  // ì˜ˆ) "â€¦ 101ë™ 202í˜¸", "â€¦ 1701-1505", "â€¦ 1701ë™-1505í˜¸", "â€¦ 101 ë™ 202 í˜¸"
  const normalized = address.replace(/\s+/g,' ').trim();
  // 1) ëª…ì‹œì  'ë™/í˜¸' íŒ¨í„´ ìš°ì„ 
  let m = normalized.match(/(\d+)\s*ë™[^0-9]*(\d+)\s*í˜¸/);
  if (m) return { dong: m[1], ho: parseInt(m[2],10) || 0 };
  // 2) í•˜ì´í”ˆ/ë„ì–´ì“°ê¸° ì½¤ë¹„ (ì˜ˆ: "1701-1505", "101 - 202")
  m = normalized.match(/(\d{3,4})\s*[-\~]\s*(\d{1,4})/);
  if (m) return { dong: m[1], ho: parseInt(m[2],10) || 0 };
  // 3) ë§ˆì§€ë§‰ìœ¼ë¡œ ìˆ«ì 2ê°œ ì—°ì† ë“±ì¥ ì‹œ ì¶”ì •
  const nums = (normalized.match(/(\d{1,4})/g)||[]).map(n=>parseInt(n,10));
  if (nums.length>=2) return { dong: String(nums[nums.length-2]), ho: nums[nums.length-1] };
  return { dong: '0', ho: 0 };
}

// ë™ â†’ ìƒ‰ìƒ (ë™ë§ˆë‹¤ ë™ì¼ ìƒ‰ ìœ ì§€)
const dongColorMap = new Map();
const palette = ["#007bff","#10b981","#f59e0b","#6b7280","#8b5cf6","#ef4444","#14b8a6","#f97316"];
function colorForDong(dong) {
  if (!dongColorMap.has(dong)) {
    const idx = (parseInt(dong,10) || dong.length) % palette.length;
    dongColorMap.set(dong, palette[idx]);
  }
  return dongColorMap.get(dong);
}

// ë¡œì»¬ í¬í†  ìŠ¤í† ë¦¬ì§€ í‚¤
const photoKey = id => `photos_${id}`;

/** ============ ë§ˆì»¤ ìƒì„± ============ **/
const markerById = {};
const bounds = new kakao.maps.LatLngBounds();

deliveries.forEach((d,i)=>{
  if (!d.order) d.order = i+1;
  const { dong } = parseDongHo(d.address||"");
  const color = colorForDong(dong);

  const el = document.createElement('div');
  el.style.cssText = `
    width:30px;height:30px;background:${color};border-radius:50%;
    color:#fff;display:flex;align-items:center;justify-content:center;
    font-weight:900;cursor:pointer;border:2px solid #fff;font-size:13px;`;
  el.textContent = d.order;

  const marker = new kakao.maps.CustomOverlay({
    map, position: new kakao.maps.LatLng(d.lat, d.lng), content: el
  });
  markerById[d.id] = marker;
  bounds.extend(new kakao.maps.LatLng(d.lat,d.lng));

  el.addEventListener('click', ()=> openCardForDong(d));
});

if (!bounds.isEmpty()) map.setBounds(bounds);

/** ============ ì¹´ë“œ(ë™ ë‹¨ìœ„ ê·¸ë£¹) ============ **/
const card = document.getElementById('card');
const cardHead = document.getElementById('cardHead');
const cardAddr = document.getElementById('cardAddr');
const groupList = document.getElementById('groupList');
const photoArea = document.getElementById('photoArea');

// í˜„ì¬ ì„ íƒ ì»¨í…ìŠ¤íŠ¸
let currentDong = null;
let currentMain = null; // ëŒ€í‘œ(í´ë¦­í•œ) ê³ ê°
let currentGroup = [];  // í•´ë‹¹ ë™ì˜ ê³ ê°ë“¤

function openCardForDong(d){
  const { dong } = parseDongHo(d.address||"");
  currentDong = dong;
  currentMain = d;
  // ê°™ì€ "ë™" ê³ ê°ë§Œ ëª¨ìœ¼ê¸°
  const sameDong = deliveries
    .filter(x => parseDongHo(x.address||"").dong === dong)
    // ê³ ì¸µâ†’ì €ì¸µ: ho ë‚´ë¦¼ì°¨ìˆœ
    .sort((a,b)=>parseDongHo(b.address||"").ho - parseDongHo(a.address||"").ho);

  currentGroup = sameDong;
  // í—¤ë”/ì£¼ì†Œ
  cardHead.textContent = `${dong}ë™ ê³ ê° (${sameDong.length}ê±´)`;
  // ëŒ€í‘œ ì£¼ì†Œ(ë‹¨ì§€/ë™ë§Œ ê°„ê²°íˆ)
  cardAddr.textContent = d.address || '';

  // ë¦¬ìŠ¤íŠ¸ ë Œë”
  groupList.innerHTML = sameDong.map(x=>{
    const p = parseDongHo(x.address||"");
    const col = colorForDong(String(p.dong));
    const phoneMask = x.phone ? (x.phone.slice(0,3)+'-****-'+x.phone.slice(-4)) : '';
    return `
      <div class="item" data-id="${x.id}">
        <div class="line1">
          <span class="badge" style="background:${col}">${x.order||'-'}</span>
          <div style="flex:1">
            <div><b>${x.name||'ê³ ê°'}</b> Â· ${p.dong}ë™ ${p.ho||'-'}í˜¸</div>
            <div class="muted">ğŸ“¦ ${x.id||''} Â· ${phoneMask}</div>
            <div>${x.address||''}</div>
          </div>
          ${x.phone?`<a class="tel" href="tel:${x.phone}" title="ì „í™”">ğŸ“</a>`:''}
        </div>
      </div>
    `;
  }).join('');

  // ì‚¬ì§„ì˜ì—­ ìµœì‹  ìƒíƒœ
  renderPhotoStrip(currentMain.id);

  // í™œì„±í™”
  card.classList.add('active');
}

function closeCard(){ card.classList.remove('active'); }

/** ============ ì‚¬ì§„ ì´¬ì˜/ê¸°ë¡/ì™„ë£Œ ============ **/
function triggerPhoto(){
  if (!currentMain) return;
  const input = document.createElement('input');
  input.type='file'; input.accept='image/*'; input.capture='environment';
  input.onchange = e=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const fr = new FileReader();
    fr.onload = () => {
      const key = photoKey(currentMain.id);
      const arr = JSON.parse(localStorage.getItem(key)||'[]');
      arr.unshift({ ts: Date.now(), data: fr.result }); // ìµœì‹ ì´ ì•
      localStorage.setItem(key, JSON.stringify(arr));
      alert('ğŸ“¸ ì‚¬ì§„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      renderPhotoStrip(currentMain.id);
    };
    fr.readAsDataURL(f);
  };
  input.click();
}

function renderPhotoStrip(id){
  const key = photoKey(id);
  const arr = JSON.parse(localStorage.getItem(key)||'[]');
  if (!arr.length){
    photoArea.innerHTML = `<div class="muted">ì‚¬ì§„ ê¸°ë¡ ì—†ìŒ</div>`;
    return;
  }
  // ê¸ˆì¼/ì§ì „ ë¼ë²¨ í‘œê¸°
  const today = new Date().toISOString().slice(0,10);
  const thumbs = arr.map((it,idx)=>{
    const d = new Date(it.ts);
    const stamp = d.toLocaleString();
    const isToday = d.toISOString().slice(0,10) === today;
    const label = idx===0 ? (isToday?'ê¸ˆì¼':'ì§ì „') : (isToday?'ê¸ˆì¼':'');
    return `
      <div style="text-align:center">
        <img src="${it.data}" alt="photo${idx}">
        <div class="muted" style="font-size:.8rem">${label||'ê¸°ë¡'}<br>${stamp}</div>
      </div>`;
  }).join('');
  photoArea.innerHTML = thumbs;
}

function completeDelivery(){
  if (!currentMain) return;
  // ìµœì†Œ 1ì¥ ì¡´ì¬ ì—¬ë¶€ ì•ˆë‚´(ê°•ì œëŠ” ì•„ë‹˜)
  const hasPhoto = (JSON.parse(localStorage.getItem(photoKey(currentMain.id))||'[]').length>0);
  if (!hasPhoto && !confirm('ì‚¬ì§„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?')) return;

  // ë§ˆì»¤ ë°˜íˆ¬ëª… ì²˜ë¦¬
  const mk = markerById[currentMain.id];
  if (mk) mk.getContent().style.opacity='0.4';

  // ì™„ë£Œ ëª©ë¡ ê¸°ë¡
  const comp = JSON.parse(localStorage.getItem('completed')||'[]');
  comp.push({ id: currentMain.id, date: new Date().toISOString(), address: currentMain.address });
  localStorage.setItem('completed', JSON.stringify(comp));

  alert('âœ… ë°°ë‹¬ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  closeCard();
}

/** ============ ë„¤ë¹„ê²Œì´ì…˜ ë§í¬(í•„ìš” ì‹œ ì‚¬ìš©) ============ **/
function navTo(addr,lat,lng){
  // ì•± ìš°ì„  â†’ 1ì´ˆ í›„ ì›¹ í´ë°±
  const appURL=`kakaomap://route?ep=${lat},${lng}&by=CAR`;
  const webURL=`https://map.kakao.com/link/to/${encodeURIComponent(addr)},${lat},${lng}`;
  location.href=appURL; setTimeout(()=>location.href=webURL, 1000);
}

// ì „ì—­ ë…¸ì¶œ
window.closeCard = closeCard;
window.triggerPhoto = triggerPhoto;
window.completeDelivery = completeDelivery;
window.navTo = navTo;
</script>
</body>
</html>
