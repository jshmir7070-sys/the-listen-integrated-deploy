<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>The Listen - ì§€ë„</title>
<!-- Kakao SDK (ë„¤íŠ¸ì›Œí¬/í‚¤ ë¬¸ì œë¡œ ë¹„í™œì„±í™”ë  ìˆ˜ ìˆì–´ ì•ˆë‚´ë„ í¬í•¨) -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
<style>
  body{margin:0;font-family:"Noto Sans KR",sans-serif;background:#f7f9fc}
  header{background:#007bff;color:#fff;text-align:center;padding:10px;font-weight:800}
  #map{width:100%;height:90vh;position:relative}
  #customerCard{
    position:fixed;left:0;bottom:0;width:100%;background:#fff;
    border-top-left-radius:16px;border-top-right-radius:16px;
    box-shadow:0 -6px 20px rgba(0,0,0,.25);
    transform:translateY(100%);transition:transform .3s;z-index:9999;
  }
  #customerCard.active{transform:translateY(0)}
  .delivery-item{padding:16px;text-align:center}
  .btn{border:none;border-radius:10px;padding:10px 14px;color:#fff;background:#007bff;cursor:pointer;font-weight:700;margin:4px}
  .btn.gray{background:#6b7280}
  .my-location-dot{width:12px;height:12px;background:rgba(0,123,255,.95);border-radius:50%;border:2px solid #fff}
  .overlay-warn{position:absolute;inset:0;background:rgba(255,255,255,.95);display:none;align-items:center;justify-content:center;text-align:center;padding:16px}
  .overlay-warn.active{display:flex}
</style>
</head>
<body>
<header>ğŸ—º The Listen - ì‹¤ì‹œê°„ ì§€ë„</header>
<div id="map">
  <div id="warn" class="overlay-warn">
    <div>
      <h3>ì¹´ì¹´ì˜¤ ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</h3>
      <p>ë„¤íŠ¸ì›Œí¬ ìƒíƒœ, ì•±í‚¤, ë˜ëŠ” ì°¨ë‹¨í™˜ê²½ì„ í™•ì¸ í›„ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</p>
    </div>
  </div>
</div>
<div id="customerCard"><div id="card-content"></div></div>

<script>
(function safeBoot(){
  if(!(window.kakao && kakao.maps && kakao.maps.Map)){
    document.getElementById('warn').classList.add('active');
    return;
  }
  main();
})();

function main(){
  const map=new kakao.maps.Map(document.getElementById("map"),{center:new kakao.maps.LatLng(37.379,126.805),level:5});
  const geocoder=new kakao.maps.services.Geocoder();

  // depart ì—°ë™
  let deliveries=[]; try{ deliveries=JSON.parse(localStorage.getItem('deliveriesJSON')||'[]'); }catch{ deliveries=[]; }
  if(!deliveries.length){
    deliveries=[{id:"TEST1",name:"í…ŒìŠ¤íŠ¸",phone:"010-0000-0000",address:"ê²½ê¸°ë„ ì‹œí¥ì‹œ ìˆ˜í’€ì•ˆê¸¸ 19-30 101ë™ 202í˜¸",boxes:1}];
  }

  // GPS í‘œì‹œ
  let myPos=null;
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(p=>{
      myPos=new kakao.maps.LatLng(p.coords.latitude,p.coords.longitude);
      if(!window.myCircle){ window.myCircle=new kakao.maps.CustomOverlay({position:myPos,content:'<div class="my-location-dot"></div>',map}); }
      else window.myCircle.setPosition(myPos);
    },()=>{}, {enableHighAccuracy:true});
  }

  // ë§ˆì»¤ ìƒì„±
  const markerById={};
  const bounds=new kakao.maps.LatLngBounds();

  // order ë¶€ì—¬ê°€ ì—†ë‹¤ë©´ index ê¸°ë°˜ìœ¼ë¡œ ë³´ì´ê²Œ
  deliveries.forEach((d,i)=>{ if(d.order==null) d.order=i+1; });

  let done=0, need=deliveries.length;
  deliveries.forEach((d,i)=>{
    if(d.lat && d.lng){ placeMarker(d); finish(); }
    else{
      geocoder.addressSearch(d.address,(r,s)=>{
        if(s===kakao.maps.services.Status.OK && r[0]){ d.lat=+r[0].y; d.lng=+r[0].x; placeMarker(d); }
        finish();
      });
    }
  });

  function finish(){ done++; if(done>=need){ map.setBounds(bounds); } }

  function placeMarker(d){
    const dong=(d.address.match(/(\d+)ë™/)||[])[1]||"0";
    const color = dong.endsWith("1")?"#007bff" : dong.endsWith("3")?"#10b981" : dong.endsWith("5")?"#f59e0b" : "#6b7280";
    const el=document.createElement('div');
    el.style.cssText=`background:${color};color:#fff;border-radius:50%;width:34px;height:34px;
      display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;border:2px solid #fff;cursor:pointer;`;
    el.textContent=d.order||'?';

    const ov=new kakao.maps.CustomOverlay({
      position:new kakao.maps.LatLng(d.lat,d.lng),
      content:el,
      map
    });
    markerById[d.id]=ov;
    bounds.extend(new kakao.maps.LatLng(d.lat,d.lng));

    el.addEventListener('click',()=>openCard(d));
  }

  // ê³ ê° ì¹´ë“œ
  function openCard(d){
    const card=document.getElementById('customerCard');
    const box=document.getElementById('card-content');
    box.innerHTML=`
      <div class="delivery-item">
        <h3>${d.order}ï¸âƒ£ ${d.name}</h3>
        <p>${d.address}</p>
        <p>ğŸ“ ${d.phone}</p>
        <p>ğŸ“¦ ${d.boxes}ê°œ</p>
        <p>ìš´ì†¡ì¥: ${d.id}</p>
        <button class="btn" onclick="startNavi(${d.lat},${d.lng},'${encodeURIComponent(d.address)}')">ğŸš˜ ê¸¸ì•ˆë‚´</button>
        <button class="btn" onclick="photo('${d.id}')">ğŸ“¸ ì‚¬ì§„ ì „ì†¡</button>
        <button class="btn gray" onclick="closeCard()">ë‹«ê¸°</button>
      </div>`;
    card.classList.add('active');
  }
  window.closeCard=()=>document.getElementById('customerCard').classList.remove('active');

  // ì‚¬ì§„ ì „ì†¡ â†’ ë§ˆì»¤ ë°˜íˆ¬ëª…
  window.photo=(id)=>{
    const i=document.createElement('input'); i.type='file'; i.accept='image/*'; i.capture='environment';
    i.onchange=e=>{
      if(!e.target.files[0]) return;
      alert('ğŸ“¸ ì „ì†¡ ì™„ë£Œ');
      const mk=markerById[id]; if(mk) mk.getContent().style.opacity='0.4';
      window.closeCard();
      // ì™„ë£Œ ê¸°ë¡(ì„ íƒ)
      const arr=JSON.parse(localStorage.getItem('completed')||'[]');
      arr.push({id,date:new Date().toISOString(),photo:true,address:deliveries.find(x=>x.id===id)?.address||''});
      localStorage.setItem('completed', JSON.stringify(arr));
    };
    i.click();
  };

  // âœ… ì¹´ì¹´ì˜¤ ë„¤ë¹„: ì•± ìš°ì„  â†’ ì‹¤íŒ¨ ì‹œ ì›¹ í´ë°± (ë¹„í™œì„±í™” í™˜ê²½ ëŒ€ë¹„)
  window.startNavi=(lat,lng,name)=>{
    const appURL=`kakaomap://route?ep=${lat},${lng}&by=CAR`;
    const webURL=`https://map.kakao.com/link/to/${name},${lat},${lng}`;
    // ì•± ì‹œë„
    location.href=appURL;
    // 1ì´ˆ ë‚´ ì´ë™ ì‹¤íŒ¨ ì‹œ ì›¹ìœ¼ë¡œ
    setTimeout(()=>{ location.href=webURL; }, 1000);
  };
}
</script>
</body>
</html>
