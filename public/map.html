<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>The Listen - ì§€ë„</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
<style>
  body{margin:0;font-family:"Noto Sans KR",sans-serif;background:#f7f9fc}
  header{background:#007bff;color:#fff;text-align:center;padding:10px;font-weight:800}
  #map{width:100%;height:90vh}
  #customerCard{
    position:fixed;left:0;bottom:0;width:100%;background:#fff;
    border-top-left-radius:16px;border-top-right-radius:16px;
    box-shadow:0 -6px 20px rgba(0,0,0,.25);
    transform:translateY(100%);transition:transform .3s;z-index:999;
  }
  #customerCard.active{transform:translateY(0)}
  .delivery-item{padding:16px;text-align:center}
  .btn{border:none;border-radius:10px;padding:10px 14px;color:#fff;background:#007bff;cursor:pointer;font-weight:700;margin:4px}
  .btn.gray{background:#6b7280}
  .my-location-dot{width:12px;height:12px;background:rgba(0,123,255,.95);border-radius:50%;border:2px solid #fff}
</style>
</head>
<body>
<header>ğŸ—º The Listen - ì‹¤ì‹œê°„ ì§€ë„</header>
<div id="map"></div>
<div id="customerCard"><div id="card-content"></div></div>

<script>
const map=new kakao.maps.Map(document.getElementById("map"),{center:new kakao.maps.LatLng(37.379,126.805),level:5});
const geocoder=new kakao.maps.services.Geocoder();
let deliveries=[];try{deliveries=JSON.parse(localStorage.getItem('deliveriesJSON')||'[]');}catch{deliveries=[];}
if(!deliveries.length){deliveries=[{id:"TEST1",name:"í…ŒìŠ¤íŠ¸",phone:"010-0000-0000",address:"ê²½ê¸°ë„ ì‹œí¥ì‹œ ìˆ˜í’€ì•ˆê¸¸ 19-30 101ë™ 202í˜¸",boxes:1}];}

// GPS í‘œì‹œ
let myPos=null;if(navigator.geolocation){
  navigator.geolocation.watchPosition(p=>{
    myPos=new kakao.maps.LatLng(p.coords.latitude,p.coords.longitude);
    if(!window.myCircle){
      window.myCircle=new kakao.maps.CustomOverlay({position:myPos,content:'<div class="my-location-dot"></div>',map});
    }else window.myCircle.setPosition(myPos);
  },()=>{}, {enableHighAccuracy:true});
}

// ë§ˆì»¤
const markerById={};const bounds=new kakao.maps.LatLngBounds();
deliveries.forEach((d,i)=>{
  if(d.lat&&d.lng){placeMarker(d,i+1);}else{
    geocoder.addressSearch(d.address,(r,s)=>{
      if(s===kakao.maps.services.Status.OK&&r[0]){d.lat=+r[0].y;d.lng=+r[0].x;placeMarker(d,i+1);}
    });
  }
});

function placeMarker(d,o){
  const dong=d.address.match(/(\d+)ë™/)?.[1]||"0";
  const color=dong.endsWith("1")?"#007bff":dong.endsWith("3")?"#10b981":"#f59e0b";
  const el=document.createElement('div');
  el.style.cssText=`background:${color};color:#fff;border-radius:50%;width:32px;height:32px;
  display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;
  border:2px solid #fff;cursor:pointer;`;
  el.textContent=o;
  const ov=new kakao.maps.CustomOverlay({position:new kakao.maps.LatLng(d.lat,d.lng),content:el,map});
  markerById[d.id]=ov;bounds.extend(new kakao.maps.LatLng(d.lat,d.lng));map.setBounds(bounds);
  el.addEventListener('click',()=>openCard(d,o));
}

function openCard(d,o){
  const card=document.getElementById('customerCard');const box=document.getElementById('card-content');
  box.innerHTML=`
  <div class="delivery-item">
    <h3>${o}ï¸âƒ£ ${d.name}</h3>
    <p>${d.address}</p>
    <p>ğŸ“ ${d.phone}</p>
    <p>ğŸ“¦ ${d.boxes}ê°œ</p>
    <p>ìš´ì†¡ì¥: ${d.id}</p>
    <button class="btn" onclick="startNavi(${d.lat},${d.lng},'${encodeURIComponent(d.address)}')">ğŸš˜ ê¸¸ì•ˆë‚´</button>
    <button class="btn" onclick="photo('${d.id}')">ğŸ“¸ ì‚¬ì§„ ì „ì†¡</button>
    <button class="btn gray" onclick="closeCard()">ë‹«ê¸°</button>
  </div>`;
  card.classList.add('active');
}
function closeCard(){document.getElementById('customerCard').classList.remove('active');}
function photo(id){
  const i=document.createElement('input');i.type='file';i.accept='image/*';i.capture='environment';
  i.onchange=e=>{
    if(!e.target.files[0])return;alert('ğŸ“¸ ì „ì†¡ ì™„ë£Œ');
    markerById[id]?.getContent().style.opacity='0.4';closeCard();
  };i.click();
}
// âœ… ì¹´ì¹´ì˜¤ ë„¤ë¹„ ì—°ë™ ìˆ˜ì • (ì•±/ì›¹ ë‘˜ë‹¤ í˜¸í™˜)
function startNavi(lat,lng,name){
  const kakaoUrl=`kakaomap://route?ep=${lat},${lng}&by=CAR`;
  const webUrl=`https://map.kakao.com/link/to/${name},${lat},${lng}`;
  // ì•± ìš°ì„ , ì‹¤íŒ¨ ì‹œ ì›¹
  document.location.href=kakaoUrl;
  setTimeout(()=>{document.location.href=webUrl;},1000);
}
</script>
</body>
</html>
