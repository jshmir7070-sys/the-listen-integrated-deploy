<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>í˜„ì¬ ì§€ë„ - The Listen</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
<style>
  :root{--brand:#007bff;--muted:#6b7280;--ok:#10b981;--danger:#ef4444;--border:#e5e7eb;--card:#fff;--bg:#f7f9fc;}
  body{margin:0;font-family:"Noto Sans KR",sans-serif;background:var(--bg)}
  header{background:var(--brand);color:#fff;text-align:center;padding:10px;font-weight:800}
  #map{width:100%;height:90vh}

  /* í•˜ë‹¨ ê·¸ë£¹ ì‹œíŠ¸ */
  #sheet{position:fixed;left:0;bottom:0;width:100%;background:var(--card);border-radius:16px 16px 0 0;box-shadow:0 -4px 16px rgba(0,0,0,.25);transform:translateY(100%);transition:transform .3s;z-index:4}
  #sheet.active{transform:translateY(0)}
  .sheet-in{padding:12px}
  .title{text-align:center;font-weight:900}
  .list{max-height:40vh;overflow:auto;border:1px solid var(--border);border-radius:12px;margin-top:8px;padding:8px}
  .item{border:1px solid var(--border);border-radius:12px;padding:8px;margin-bottom:8px;display:flex;gap:10px;align-items:center;cursor:pointer}
  .badge{min-width:28px;height:28px;border-radius:999px;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900}
  .icons{display:flex;gap:10px}
  .icon-btn{border:none;background:transparent;font-size:20px;cursor:pointer}

  /* ìƒì„¸ ëª¨ë‹¬ */
  #detail{position:fixed;left:0;bottom:0;width:100%;background:var(--card);border-radius:16px 16px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,.3);transform:translateY(100%);transition:transform .3s;z-index:5}
  #detail.active{transform:translateY(0)}
  .inner{padding:12px}
  .section{margin:8px 0}
  .row{display:flex;gap:8px}
  .col{flex:1}
  label{font-weight:700}
  input,textarea,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
  .thumbs{display:flex;gap:8px}
  .thumbs img{width:50%;height:180px;object-fit:cover;border:1px solid var(--border);border-radius:12px}
  .btn{border:none;padding:10px 14px;border-radius:10px;margin:6px;color:#fff;background:var(--brand);font-weight:700;cursor:pointer}
  .btn.green{background:var(--ok)} .btn.gray{background:#6b7280} .muted{color:var(--muted)}
  .my-location{width:12px;height:12px;background:rgba(0,123,255,.95);border-radius:50%;border:2px solid #fff}
</style>
</head>
<body>
<header>ğŸ—º ì‹¤ì‹œê°„ ì§€ë„ - The Listen</header>
<div id="map"></div>

<!-- í•˜ë‹¨ ê·¸ë£¹ ì‹œíŠ¸ (ë™ ê¸°ì¤€ 3~4ê°œ ë¯¸ë‹ˆì¹´ë“œ) -->
<div id="sheet">
  <div class="sheet-in">
    <div class="title" id="sheetTitle">ë™ ê·¸ë£¹</div>
    <div class="list" id="miniList"></div>
    <div style="text-align:center"><button class="btn gray" onclick="closeSheet()">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- ìƒì„¸ ì „ì²´ì°½: ë°°ì†¡ ì™„ë£Œ í™•ì¸ -->
<div id="detail">
  <div class="inner">
    <div class="title" id="detailTitle">ë°°ì†¡ ì™„ë£Œ í™•ì¸</div>
    <div class="muted" id="detailAddr"></div>

    <div class="thumbs section">
      <img id="imgToday" alt="ì˜¤ëŠ˜ ì‚¬ì§„">
      <img id="imgPrev"  alt="ì´ì „ ì‚¬ì§„">
    </div>

    <div class="row section">
      <div class="col">
        <label>ê³µë™í˜„ê´€ ë¹„ë°€ë²ˆí˜¸</label>
        <input id="entCode" readonly value="*1234#" />
      </div>
      <div class="col">
        <label>ê³ ê°ìš”ì²­(ì½ê¸°ì „ìš©)</label>
        <input id="reqNote" readonly value="ë¬¸ì• ë°°ì†¡ ìš”ì²­" />
      </div>
    </div>

    <div class="section">
      <label>ê¸°ì‚¬ë‹˜ ê³µë™ë¹„ë°€ë²ˆí˜¸ ë“±ë¡ ìš”ì²­</label>
      <input id="driverReq" placeholder="ë¹„ë°€ë²ˆí˜¸ ë“±ë¡ ìš”ì²­/í˜„ì¥ ë©”ëª¨" />
    </div>

    <div class="row section">
      <div class="col">
        <label>ë°°ì†¡í˜•ì‹</label>
        <select id="delType">
          <option value="face">ê³ ê° ì§ì ‘ ìˆ˜ë ¹(ëŒ€ë©´)</option>
          <option value="door" selected>ë¹„ëŒ€ë©´(ë¬¸ì•)</option>
          <option value="box">ë¹„ëŒ€ë©´(íƒë°°í•¨)</option>
          <option value="storage">ë¹„ëŒ€ë©´(ë³´ê´€ì†Œ)</option>
          <option value="guard">ë¹„ëŒ€ë©´(ê²½ë¹„ì‹¤/ê´€ë¦¬ì‹¤)</option>
          <option value="req">ë¹„ëŒ€ë©´(ê³ ê°ìš”ì²­ì¥ì†Œ)</option>
          <option value="etc">ë¹„ëŒ€ë©´(ê¸°íƒ€)</option>
        </select>
      </div>
      <div class="col">
        <label>ê¸°íƒ€/ìš”ì²­ì¥ì†Œ ë©”ëª¨</label>
        <input id="placeMemo" placeholder="ê¸°íƒ€ ì„ íƒ ì‹œ ìƒì„¸ ë©”ëª¨" />
      </div>
    </div>

    <div class="section" id="wbArea">
      <label>ìš´ì†¡ì¥(ê°œë³„ ì™„ë£Œ ê°€ëŠ¥)</label>
      <div id="wbList"></div>
    </div>

    <div class="section" style="text-align:center">
      <button class="btn" onclick="triggerPhoto()">ğŸ“¸ ì‚¬ì§„ ì „ì†¡</button>
      <button class="btn green" id="btnDone" onclick="completeDelivery()">âœ… ë°°ì†¡ì™„ë£Œ</button>
      <button class="btn gray" onclick="closeDetail()">ë’¤ë¡œ</button>
    </div>
  </div>
</div>

<script>
/* ================= ì§€ë„ & ë°ì´í„° ================= */
const map = new kakao.maps.Map(document.getElementById("map"),{center:new kakao.maps.LatLng(37.3795,126.806),level:5});
const deliveries = JSON.parse(localStorage.getItem("deliveriesJSON")||"[]"); // ìµœì†Œ ì •ë³´
const waybillDetails = JSON.parse(localStorage.getItem("waybillDetails")||"{}"); // ìƒì„¸ DTO ëª¨ìŒ
const bounds = new kakao.maps.LatLngBounds();
const markerById = {};
let sel = null;          // ìƒì„¸ ê³ ê°
let curGroup = [];       // í˜„ì¬ ë™ ê·¸ë£¹
let curDongKey = "";     // í˜„ì¬ ë™ key

/* ================= ë‚´ ìœ„ì¹˜ ì  ================= */
let myCircle=null;
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    const p=new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
    if(!myCircle) myCircle=new kakao.maps.CustomOverlay({map,position:p,content:'<div class="my-location"></div>'});
    else myCircle.setPosition(p);
  },()=>{}, {enableHighAccuracy:true});
}

/* ================= ë™/í˜¸ íŒŒì„œ & ë§ˆì»¤ ì˜¤í”„ì…‹ ================= */
// 1001ë™/1001-, 101ë™/101-, Aë™/ê°€ë™/ë‚˜ë™ ë“±ë„ "ë™ í‚¤"ë¡œ í†µì¼
function extractDongKey(addr=""){
  addr = (addr||"").replace(/\s+/g,' ');
  // ìš°ì„ ìˆœìœ„ 1: nnnnë™
  let m = addr.match(/(\d{3,4})\s*ë™/);
  if(m) return m[1];
  // ìš°ì„ ìˆœìœ„ 2: nnnn-xxxx (í•˜ì´í”ˆ)
  m = addr.match(/(\d{3,4})\s*-/);
  if(m) return m[1];
  // ìš°ì„ ìˆœìœ„ 3: 3ìë¦¬/4ìë¦¬ ìˆ«ì ì—°ì† ë“±ì¥ â†’ ë™ìœ¼ë¡œ ì¶”ì •
  m = addr.match(/(\d{3,4})/);
  if(m) return m[1];
  // ìš°ì„ ìˆœìœ„ 4: í•œê¸€ ë™(Aë™/ê°€ë™/ë‚˜ë™ ë“±) â†’ ì´ˆì„± ê¸°ë°˜ í‚¤
  m = addr.match(/([A-Za-zê°€-í£])\s*ë™/);
  if(m) return m[1]; // 'A' or 'ê°€' ë“±
  return "UNK";
}
// í˜¸ìˆ˜ ì¶”ì¶œ(ë§ˆì§€ë§‰ ìˆ«ì ë¸”ë¡)
function extractHo(addr=""){
  const nums=(addr.match(/(\d{1,4})/g)||[]).map(n=>parseInt(n,10));
  return nums.length? nums[nums.length-1] : 0;
}
// ì†Œìˆ˜ì  ë¯¸ì„¸ ì˜¤í”„ì…‹: ë™/í˜¸ ë’¤ ë‘ìë¦¬ ì‚¬ìš©
function microOffset(lat,lng,dongKey,ho){
  const dNum = parseInt(String(dongKey).slice(-2) || "0",10);
  const hNum = parseInt(String(ho).slice(-2) || "0",10);
  const dOff = ((dNum%10)-5)*0.00008; // ì•½ 8~10m ìˆ˜ì¤€
  const hOff = ((hNum%10)-5)*0.00008;
  return [lat + dOff, lng + hOff];
}

/* ================= ë§ˆì»¤ìƒì„± ================= */
deliveries.forEach((d,i)=>{
  const dongKey = extractDongKey(d.address||"");
  const ho = extractHo(d.address||"");
  const [lat,lng] = microOffset(d.lat||37.3795, d.lng||126.806, dongKey, ho);
  const el = document.createElement('div');
  el.style.cssText=`width:30px;height:30px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;border:2px solid #fff;cursor:pointer`;
  el.textContent = d.order || (i+1);
  const mk = new kakao.maps.CustomOverlay({map,position:new kakao.maps.LatLng(lat,lng),content:el});
  markerById[d.id]=mk;
  bounds.extend(new kakao.maps.LatLng(lat,lng));
  el.onclick = ()=> openDongSheet(dongKey, d);
});
if(!bounds.isEmpty()) map.setBounds(bounds);

/* ================= ë™ ê·¸ë£¹ ì‹œíŠ¸ ================= */
const sheet=document.getElementById('sheet');
const miniList=document.getElementById('miniList');
const sheetTitle=document.getElementById('sheetTitle');

function openDongSheet(dongKey, tapped){
  curDongKey = dongKey;
  // ê°™ì€ ë™ì˜ ê³ ê°ë§Œ ì„ ë³„
  let group = deliveries.filter(x=>extractDongKey(x.address||"")===dongKey);
  // ì™„ë£Œ ìš°ì„ ìˆœìœ„: ë¯¸ì™„ë£Œ(ìƒë‹¨) â†’ ì™„ë£Œ(í•˜ë‹¨)
  const completed = JSON.parse(localStorage.getItem('completed')||'[]');
  const isDone = id => completed.some(k=>k.id===id);
  // ì•„ë˜ì¸µâ†’ê³ ì¸µ (í˜¸ìˆ˜ ì˜¤ë¦„ì°¨ìˆœ)
  group.sort((a,b)=>extractHo(a.address)-extractHo(b.address));
  // ì™„ë£ŒëŠ” ë§ˆì§€ë§‰ìœ¼ë¡œ
  group = group.sort((a,b)=> (isDone(a.id)?1:0) - (isDone(b.id)?1:0));
  curGroup = group;

  sheetTitle.textContent = `${dongKey}ë™ ê·¼ì²˜ ê³ ê° (${group.length})`;
  // í•˜ë‹¨ ë°˜ ì‹œíŠ¸: 3~4ê°œ ì¹´ë“œ ë¯¸ë‹ˆ ëª©ë¡
  const items = group.slice(0,4).map(g=>{
    const telIcon = `<button class="icon-btn" title="ì „í™”" onclick="callCustomer('${g.phone||''}');event.stopPropagation()">ğŸ“</button>`;
    const naviIcon= `<button class="icon-btn" title="ë„¤ë¹„" onclick="goNavi('${encodeURIComponent(g.address||"")}',${g.lat||0},${g.lng||0});event.stopPropagation()">ğŸ§­</button>`;
    const done = isDone(g.id) ? 'opacity:.45;' : '';
    return `
      <div class="item" style="${done}" onclick="openDetail('${g.id}')">
        <div class="badge">${g.order||'-'}</div>
        <div style="flex:1">
          <div><b>${g.name||'ê³ ê°'}</b> â€” ${g.address||''}</div>
          <div class="muted">ğŸ“¦ ${g.boxes||1}ë°•ìŠ¤</div>
        </div>
        <div class="icons">${naviIcon}${telIcon}</div>
      </div>`;
  }).join('');
  miniList.innerHTML = items || `<div class="muted">í•´ë‹¹ ë™ì— ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  sheet.classList.add('active');
}
function closeSheet(){ sheet.classList.remove('active'); }

/* ================= ìƒì„¸ ì „ì²´ì°½ ================= */
const detail=document.getElementById('detail');
const dTitle=document.getElementById('detailTitle');
const dAddr=document.getElementById('detailAddr');
const imgToday=document.getElementById('imgToday');
const imgPrev =document.getElementById('imgPrev');
const delType=document.getElementById('delType');
const placeMemo=document.getElementById('placeMemo');
const wbArea=document.getElementById('wbArea');
const wbListDiv=document.getElementById('wbList');
const btnDone=document.getElementById('btnDone');

function openDetail(id){
  sel = deliveries.find(v=>v.id===id);
  if(!sel) return;
  dTitle.textContent = `${sel.name||'ê³ ê°'} â€” ë°°ì†¡ ì™„ë£Œ í™•ì¸`;
  dAddr.textContent  = `${sel.address||''}`;
  // ì‚¬ì§„ ë¡œë”©
  const arr = loadPhotos(id);
  imgToday.src = arr[0]?.data || '';
  imgPrev.src  = arr[1]?.data || '';

  // ìš´ì†¡ì¥ ì„¸ë¶€(ê°™ì€ ê³ ê° ë³‘í•© ìš´ì†¡ì¥ ì‹œë‚˜ë¦¬ì˜¤: ìµœì†Œì •ë³´ë¼ id í•˜ë‚˜ë§Œ ìˆì„ ìˆ˜ ìˆìŒ)
  // ìƒì„¸ DTOê°€ ìˆë‹¤ë©´ ë…¸ì¶œ
  const wbArray = collectWaybillsForCustomer(sel);
  wbListDiv.innerHTML = wbArray.map((w,i)=>`<div><input type="checkbox" id="wb_${i}" checked> ${w}</div>`).join('') || `<div class="muted">ìš´ì†¡ì¥ ì •ë³´ ì—†ìŒ</div>`;

  updateDoneState();
  detail.classList.add('active');
  sheet.classList.remove('active');
}

function closeDetail(){ detail.classList.remove('active'); }

// ìš´ì†¡ì¥ ìˆ˜ì§‘: ë™ì¼ ì´ë¦„/ì „í™”/ì£¼ì†Œ(2ê°œ ì´ìƒ ì¼ì¹˜)í•œ ìƒì„¸ DTOì˜ waybillë“¤ì„ ë¬¶ìŒ
function collectWaybillsForCustomer(cust){
  const allWb = Object.keys(waybillDetails);
  const arr = [];
  allWb.forEach(w=>{
    const d = waybillDetails[w]?.receiver || {};
    let s=0;
    if(d.name && cust.name && d.name===cust.name) s++;
    if(d.phone&& cust.phone&&d.phone===cust.phone) s++;
    if(d.address&&cust.address&&d.address===cust.address) s++;
    if(s>=2) arr.push(w);
  });
  // ìµœì†Œ 1ê°œ ë³´ì¥
  if(!arr.length && cust.id) arr.push(cust.id);
  return arr;
}

/* ================= ì‚¬ì§„ ì „ì†¡ ================= */
function triggerPhoto(){
  const input=document.createElement('input');
  input.type='file'; input.accept='image/*'; input.capture='environment';
  input.onchange=e=>{
    const f=e.target.files&&e.target.files[0]; if(!f) return;
    const fr=new FileReader();
    fr.onload=()=>{
      const arr=loadPhotos(sel.id); arr.unshift({ts:Date.now(),data:fr.result});
      savePhotos(sel.id,arr);
      imgPrev.src  = arr[1]?.data || '';
      imgToday.src = arr[0]?.data || '';
      alert('ğŸ“¸ ì‚¬ì§„ ì „ì†¡ ì™„ë£Œ');
      updateDoneState();
    };
    fr.readAsDataURL(f);
  };
  input.click();
}

/* ================= ì™„ë£Œ ì¡°ê±´/ì²˜ë¦¬ ================= */
// ëŒ€ë©´ë°°ì†¡: ì‚¬ì§„ ì—†ì´ ì™„ë£Œ ê°€ëŠ¥
// ë¹„ëŒ€ë©´(ë¬¸ì•/ë³´ê´€ ë“±): ì‚¬ì§„ ì—†ìœ¼ë©´ ì™„ë£Œ ë²„íŠ¼ ë¹„í™œì„±í™”
function updateDoneState(){
  const type=delType.value;
  const hasPhoto = !!(loadPhotos(sel?.id||'')[0]);
  btnDone.disabled = (type!=='face' && !hasPhoto);
}
delType.onchange = updateDoneState;

function completeDelivery(){
  // ì–´ë–¤ ìš´ì†¡ì¥ì„ ì™„ë£Œ ì²˜ë¦¬í• ì§€
  const checks = [...(wbListDiv.querySelectorAll('input[type="checkbox"]')||[])];
  let selected = checks.filter(ch=>ch.checked).map(ch=>ch.nextSibling.textContent.trim());
  if(!selected.length){ // ë¯¸ì„ íƒì´ë©´ ì „ì²´ ì™„ë£Œ
    selected = collectWaybillsForCustomer(sel);
  }
  // ì™„ë£Œ ë¡œê·¸
  const comp = JSON.parse(localStorage.getItem('completed')||'[]');
  comp.push({ id: sel.id, date: new Date().toISOString(), address: sel.address, waybills: selected, type: delType.value, memo: placeMemo.value||'' });
  localStorage.setItem('completed', JSON.stringify(comp));
  // ë§ˆì»¤ ë°˜íˆ¬ëª…
  const mk = markerById[sel.id];
  if(mk) mk.getContent().style.opacity='0.4';
  alert('âœ… ë°°ì†¡ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  // ë‹¤ì‹œ ë™ ê·¸ë£¹ì„ ì—´ì–´ ì™„ë£Œ ì •ë ¬ ë°˜ì˜
  if(curDongKey) openDongSheet(curDongKey, sel);
  closeDetail();
}

/* ================= ì‚¬ì§„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ================= */
function loadPhotos(id){ try{return JSON.parse(localStorage.getItem('photos_'+id)||'[]');}catch(e){return [];} }
function savePhotos(id,arr){ localStorage.setItem('photos_'+id, JSON.stringify(arr||[])); }

/* ================= ì „í™” & ë„¤ë¹„ ================= */
function callCustomer(tel){
  if(!tel){ alert('ì „í™”ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  location.href = `tel:${tel}`;
}
function goNavi(addr,lat,lng){
  const app = `kakaomap://route?ep=${lat},${lng}&by=CAR`;
  const web = `https://map.kakao.com/link/to/${addr},${lat},${lng}`;
  location.href=app; setTimeout(()=>location.href=web, 800);
}

/* ì „ì—­ */
window.openDetail = openDetail;
window.closeDetail= closeDetail;
window.closeSheet = closeSheet;
window.callCustomer = callCustomer;
window.goNavi = goNavi;
</script>
</body>
</html>
