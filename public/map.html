<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ğŸšš The Listen - AIÂ·GPS ë°°ì†¡ì™„ë£Œ ì‹œìŠ¤í…œ v2</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f5f5f5;
    }

    header {
      background-color: #007bff; color: white;
      text-align: center; padding: 14px 0;
      font-size: 1.4rem; font-weight: 600;
    }

    #map { width: 100%; height: 55%; }

    #gps-toggle {
      position: absolute; bottom: 20px; right: 20px;
      width: 54px; height: 54px; border-radius: 50%;
      background-color: white; border: 2px solid #007bff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 20; transition: 0.3s;
    }
    #gps-toggle.active { background-color: #007bff; }
    #gps-toggle svg { width: 26px; height: 26px; fill: #007bff; transition: 0.3s; }
    #gps-toggle.active svg { fill: white; }

    #delivery-list {
      position: absolute; bottom: 0; width: 100%; height: 45%;
      background: white; border-top-left-radius: 12px; border-top-right-radius: 12px;
      overflow-y: auto; box-shadow: 0 -3px 8px rgba(0,0,0,0.2);
      padding: 10px;
    }

    .address-group {
      border: 2px solid #007bff; border-radius: 10px;
      padding: 8px 10px; margin-bottom: 8px;
      background: #f8fbff;
    }

    .address-group h4 {
      margin: 0; font-size: 14px; color: #007bff;
      display: flex; justify-content: space-between; align-items: center;
    }

    .customer {
      background: #fff; border: 1px solid #ddd; border-radius: 8px;
      padding: 6px 8px; margin-top: 6px;
      font-size: 13px; cursor: pointer;
    }

    .customer:hover { background-color: #eaf4ff; }

    .photo-preview {
      margin-top: 6px; border-radius: 8px; max-width: 100%; display: none;
    }

    #result-info {
      font-size: 12px; text-align: center; color: #666;
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <header>ğŸš› The Listen AIÂ·GPS ë°°ì†¡ì™„ë£Œ ì‹œìŠ¤í…œ</header>
  <div id="map"></div>

  <!-- GPS ë²„íŠ¼ -->
  <div id="gps-toggle" title="GPS ìœ„ì¹˜ ì¶”ì  í† ê¸€">
    <svg viewBox="0 0 24 24">
      <path d="M12 8a4 4 0 100 8 4 4 0 000-8zm9 3h-1.07a7.002 7.002 0 00-5.93-5.93V4a1 1 0 10-2 0v1.07a7.002 7.002 0 00-5.93 5.93H3a1 1 0 100 2h1.07a7.002 7.002 0 005.93 5.93V20a1 1 0 102 0v-1.07a7.002 7.002 0 005.93-5.93H21a1 1 0 100-2zm-9 5a5 5 0 110-10 5 5 0 010 10z"/>
    </svg>
  </div>

  <!-- ë°°ì†¡ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
  <div id="delivery-list">
    <div id="result-info">ğŸ“ ì§€ë„ ë§ˆì»¤ í´ë¦­ ì‹œ ì£¼ì†Œë³„ ê³ ê° ëª©ë¡ í™•ì¸ / ì‚¬ì§„ ì´¬ì˜ ì‹œ ë°°ì†¡ì™„ë£Œ ì²˜ë¦¬</div>
    <div id="card-container"></div>
  </div>

  <!-- Kakao Map SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03"></script>
  <script>
    const deliveryPoints = [
      { waybill: "A001", name: "ê¹€ì² ìˆ˜", phone: "010-1111-2222", address: "ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 201", detail: "101ë™ 301í˜¸", lat: 37.4979, lng: 127.0276 },
      { waybill: "A002", name: "ì´ì˜í¬", phone: "010-2222-3333", address: "ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 201", detail: "101ë™ 302í˜¸", lat: 37.4979, lng: 127.0276 },
      { waybill: "A003", name: "ë°•ë¯¼ìˆ˜", phone: "010-3333-4444", address: "ì„œìš¸ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 326", detail: "301ë™ 1002í˜¸", lat: 37.5145, lng: 127.1059 },
      { waybill: "A004", name: "í™ê¸¸ë™", phone: "010-4444-5555", address: "ì„œìš¸ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 326", detail: "301ë™ 1003í˜¸", lat: 37.5145, lng: 127.1059 },
      { waybill: "A005", name: "ì •í•˜ëŠ˜", phone: "010-5555-6666", address: "ì„œìš¸ êµ¬ë¡œêµ¬ ë””ì§€í„¸ë¡œ 32", detail: "202í˜¸", lat: 37.4843, lng: 126.9011 }
    ];

    let map, gpsWatchId = null, userCircle = null;
    const activeMarkers = [];

    function groupByAddress(list) {
      const groups = {};
      list.forEach(item => {
        if (!groups[item.address]) groups[item.address] = [];
        groups[item.address].push(item);
      });
      return groups;
    }

    function showGroupedCards(addressGroup) {
      const container = document.getElementById("card-container");
      container.innerHTML = "";
      const groups = groupByAddress(addressGroup);

      for (const address in groups) {
        const customers = groups[address];
        const groupDiv = document.createElement("div");
        groupDiv.className = "address-group";

        const header = document.createElement("h4");
        header.innerHTML = `
          ${address} <span>ğŸ“¦ ì”ì—¬ ${customers.length}ê±´</span>
        `;
        groupDiv.appendChild(header);

        customers.forEach(c => {
          const custDiv = document.createElement("div");
          custDiv.className = "customer";
          custDiv.innerHTML = `
            <b>${c.name}</b> (${c.detail})<br>
            <small>ìš´ì†¡ì¥: ${c.waybill}</small><br>
            <small>${c.phone}</small>
            <img class="photo-preview" id="photo-${c.waybill}">
            <input type="file" accept="image/*" capture="camera" id="file-${c.waybill}" style="display:none">
          `;
          custDiv.onclick = () => handlePhoto(c);
          groupDiv.appendChild(custDiv);
        });

        container.appendChild(groupDiv);
      }
    }

    function handlePhoto(cust) {
      const input = document.getElementById(`file-${cust.waybill}`);
      const preview = document.getElementById(`photo-${cust.waybill}`);
      input.click();
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            preview.src = ev.target.result;
            preview.style.display = "block";
            alert(`ğŸ“¸ ${cust.name}(${cust.detail}) ì‚¬ì§„ ì „ì†¡ ì™„ë£Œ`);
            preview.parentElement.style.background = "#d1f5d3";
            removeMarker(cust);
          };
          reader.readAsDataURL(file);
        }
      };
    }

    function removeMarker(cust) {
      const marker = activeMarkers.find(m => m.address === cust.address);
      if (marker) {
        const group = deliveryPoints.filter(p => p.address === cust.address && p.waybill !== cust.waybill);
        if (group.length === 0) {
          marker.marker.setMap(null);
        }
      }
    }

    window.onload = function() {
      const mapContainer = document.getElementById("map");
      map = new kakao.maps.Map(mapContainer, { center: new kakao.maps.LatLng(37.4979, 127.0276), level: 7 });

      const gpsBtn = document.getElementById("gps-toggle");
      const info = document.getElementById("result-info");

      // ì£¼ì†Œë³„ë¡œ ëŒ€í‘œ ë§ˆì»¤ í•˜ë‚˜ì”©
      const grouped = groupByAddress(deliveryPoints);
      for (const addr in grouped) {
        const first = grouped[addr][0];
        const pos = new kakao.maps.LatLng(first.lat, first.lng);
        const marker = new kakao.maps.Marker({ map, position: pos });
        activeMarkers.push({ address: addr, marker });

        kakao.maps.event.addListener(marker, "click", () => {
          showGroupedCards(grouped[addr]);
        });
      }

      gpsBtn.addEventListener("click", () => {
        if (gpsBtn.classList.contains("active")) {
          gpsBtn.classList.remove("active");
          if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
          if (userCircle) userCircle.setMap(null);
          userCircle = null;
          info.textContent = "ğŸ“ GPS ì¤‘ì§€ë¨";
        } else {
          gpsBtn.classList.add("active");
          if (navigator.geolocation) {
            gpsWatchId = navigator.geolocation.watchPosition((pos) => {
              const myLat = pos.coords.latitude;
              const myLng = pos.coords.longitude;
              const loc = new kakao.maps.LatLng(myLat, myLng);
              if (!userCircle) {
                userCircle = new kakao.maps.Circle({
                  center: loc, radius: 8, strokeWeight: 0,
                  fillColor: "#1E90FF", fillOpacity: 1
                });
                userCircle.setMap(map);
              } else {
                userCircle.setPosition(loc);
              }
              map.setCenter(loc);
              info.textContent = "ğŸš› GPS í™œì„±í™”ë¨ - ê±°ë¦¬ ê³„ì‚°ì¤‘...";
            });
          } else alert("GPS ì§€ì›ë˜ì§€ ì•ŠìŒ");
        }
      });
    };
  </script>
</body>
</html>
