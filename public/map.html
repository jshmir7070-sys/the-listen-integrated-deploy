<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>The Listen - ì§€ë„ ì—°ë™ í…ŒìŠ¤íŠ¸ (depart ì—°ê²° + ì•„íŒŒíŠ¸ ë™ë³„ ë§ˆì»¤)</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
<style>
  body{margin:0;font-family:"Noto Sans KR",sans-serif;background:#f7f9fc}
  header{background:#007bff;color:#fff;text-align:center;padding:10px;font-weight:800}
  #map{width:100%;height:90vh}
  #customerCard{
    position:fixed;left:0;bottom:0;width:100%;background:#fff;
    border-top-left-radius:16px;border-top-right-radius:16px;
    box-shadow:0 -6px 20px rgba(0,0,0,.25);
    transform:translateY(100%);
    transition:transform .35s ease;max-height:60vh;overflow-y:auto;z-index:9999;
  }
  #customerCard.active{transform:translateY(0)}
  .card-header{text-align:center;padding:12px;font-weight:900}
  .delivery-item{padding:12px 18px;border-top:1px solid #eee}
  .btn-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .btn{border:none;border-radius:10px;padding:10px 14px;color:#fff;background:#007bff;cursor:pointer;font-weight:700}
  .btn.gray{background:#6b7280}
  .tag{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;background:#eef4ff;color:#3563ff;font-size:.8rem}
  .my-location-dot{width:12px;height:12px;background:rgba(0,123,255,.95);border-radius:50%;border:2px solid #fff}
</style>
</head>
<body>
<header>ğŸ“ The Listen - ì‹¤ì‹œê°„ ì§€ë„ ì—°ë™ (depart â†’ map)</header>
<div id="map"></div>

<div id="customerCard">
  <div class="card-header">ê³ ê° ìƒì„¸ ì •ë³´</div>
  <div id="card-content"></div>
</div>

<script>
/* ===========================
   1ï¸âƒ£ ì§€ë„ ì´ˆê¸°í™”
=========================== */
const map = new kakao.maps.Map(document.getElementById("map"), {
  center: new kakao.maps.LatLng(37.3791, 126.8055),
  level: 4
});
const geocoder = new kakao.maps.services.Geocoder();

/* ===========================
   2ï¸âƒ£ depart.html ì—°ë™ ë°ì´í„° ë¡œë“œ
=========================== */
let deliveries = [];
try {
  const data = localStorage.getItem('deliveriesJSON');
  if (data) deliveries = JSON.parse(data);
} catch(e){ console.warn('JSON Parse ì‹¤íŒ¨:', e); }

const defaultBase = "ê²½ê¸°ë„ ì‹œí¥ì‹œ ìˆ˜í’€ì•ˆê¸¸ 19-30 í˜¸ë°˜ë² ë¥´ë””ì›€ë”í´ë˜ìŠ¤ì•„íŒŒíŠ¸";
if (!deliveries || deliveries.length === 0) {
  deliveries = [
    {id:"HOVA101-202", name:"ê³ ê°A", phone:"010-1111-2222", address:`${defaultBase} 101ë™ 202í˜¸`, boxes:1},
    {id:"HOVA103-303", name:"ê³ ê°B", phone:"010-2222-3333", address:`${defaultBase} 103ë™ 303í˜¸`, boxes:2}
  ];
}

/* ===========================
   3ï¸âƒ£ GPS ì„¤ì • ë° ë‚´ ìœ„ì¹˜ í‘œì‹œ
=========================== */
let myPosition = null;
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    myPosition = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
    if (!window.myCircle) {
      window.myCircle = new kakao.maps.CustomOverlay({
        position: myPosition,
        content: '<div class="my-location-dot"></div>',
        map
      });
    } else {
      window.myCircle.setPosition(myPosition);
    }
  }, err => console.warn('GPS error:', err), {enableHighAccuracy:true});
}

/* ===========================
   4ï¸âƒ£ Haversine ê±°ë¦¬ ê³„ì‚°
=========================== */
function distKm(a,b,c,d){
  const R=6371, dLat=(c-a)*Math.PI/180, dLng=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
}

/* ===========================
   5ï¸âƒ£ ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜ í›„ ë§ˆì»¤ í‘œì‹œ
=========================== */
let resolved = [];
let done = 0;
deliveries.forEach(d=>{
  if (d.lat && d.lng) { resolved.push(d); done++; if(done===deliveries.length) drawMarkers(); return; }
  geocoder.addressSearch(d.address,(res,status)=>{
    done++;
    if(status===kakao.maps.services.Status.OK && res[0]){
      d.lat=+res[0].y; d.lng=+res[0].x; resolved.push(d);
    }
    if(done===deliveries.length) drawMarkers();
  });
});

function drawMarkers(){
  if (resolved.length===0) return;

  // GPS ê±°ë¦¬ìˆœ ì •ë ¬
  const optimize = localStorage.getItem('optimizeByGPS') === '1';
  if (myPosition && optimize) {
    const myLat=myPosition.getLat(), myLng=myPosition.getLng();
    resolved.sort((a,b)=>distKm(myLat,myLng,a.lat,a.lng)-distKm(myLat,myLng,b.lat,b.lng));
  }

  const bounds = new kakao.maps.LatLngBounds();
  resolved.forEach((d,i)=>{
    d.order = i+1;
    bounds.extend(new kakao.maps.LatLng(d.lat, d.lng));
    placeMarker(d);
  });
  map.setBounds(bounds);
}

/* ===========================
   6ï¸âƒ£ ë§ˆì»¤ í‘œì‹œ (ì•„íŒŒíŠ¸ ë™ë³„ ìƒ‰ìƒ êµ¬ë¶„)
=========================== */
const markerById = {};
function placeMarker(d){
  const dong = d.address.match(/(\d+)ë™/)?.[1] || "0";
  const color = dong.endsWith("1") ? "#007bff"
               : dong.endsWith("3") ? "#10b981"
               : dong.endsWith("5") ? "#f59e0b"
               : "#6b7280";

  const el = document.createElement('div');
  el.style.cssText=`
    background:${color};
    color:#fff;border-radius:50%;
    width:32px;height:32px;
    display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:13px;border:2px solid #fff;
    box-shadow:0 2px 6px rgba(0,0,0,.3);
    cursor:pointer;`;
  el.textContent=d.order||'?';

  const overlay = new kakao.maps.CustomOverlay({
    position:new kakao.maps.LatLng(d.lat,d.lng),
    content:el,map
  });
  markerById[d.id]=overlay;
  el.addEventListener('click',()=>openCard(d));
}

/* ===========================
   7ï¸âƒ£ ê³ ê° ì¹´ë“œ (í•˜ë‹¨ ìŠ¬ë¼ì´ë“œ)
=========================== */
function openCard(d){
  const card=document.getElementById('customerCard');
  const box=document.getElementById('card-content');
  box.innerHTML=`
    <div class="delivery-item" style="text-align:center;">
      <div style="font-size:1.1rem;font-weight:900;">${d.order}ï¸âƒ£ ìˆœë²ˆ 
        <span class="tag">${d.address.match(/(\d+ë™\s?\d+í˜¸)/)?.[1]||''}</span>
      </div>
      <p><b>ê³ ê°</b>: ${d.name}</p>
      <p><b>ì „í™”ë²ˆí˜¸</b>: ${d.phone}</p>
      <p><b>ì£¼ì†Œ</b>: ${d.address}</p>
      <p><b>ìš´ì†¡ì¥</b>: ${d.id}</p>
      <p><b>ë°•ìŠ¤ìˆ˜ëŸ‰</b>: ${d.boxes}ê°œ</p>
      <div class="btn-row">
        <button class="btn" onclick="startNavi(${d.lat},${d.lng},'${encodeURIComponent(d.address)}')">ğŸš˜ ê¸¸ì•ˆë‚´</button>
        <button class="btn" onclick="capturePhoto('${d.id}','${d.address}')">ğŸ“¸ ì‚¬ì§„ ì „ì†¡</button>
        <button class="btn gray" onclick="closeCard()">ë‹«ê¸°</button>
      </div>
    </div>`;
  card.classList.add('active');
}
function closeCard(){ document.getElementById('customerCard').classList.remove('active'); }

/* ===========================
   8ï¸âƒ£ ì‚¬ì§„ ì „ì†¡
=========================== */
function capturePhoto(id,address){
  const input=document.createElement('input');
  input.type='file'; input.accept='image/*'; input.capture='environment';
  input.onchange=e=>{
    const f=e.target.files&&e.target.files[0]; if(!f) return;
    alert(`ğŸ“¸ ì „ì†¡ ì™„ë£Œ\nì£¼ì†Œ:${address}\nìš´ì†¡ì¥:${id}`);
    const completed=JSON.parse(localStorage.getItem('completed')||'[]');
    completed.push({id,address,date:new Date().toISOString(),photo:true});
    localStorage.setItem('completed', JSON.stringify(completed));
    const mk=markerById[id]; if(mk) mk.getContent().style.opacity='0.4';
    closeCard();
  };
  input.click();
}

/* ===========================
   9ï¸âƒ£ ë„¤ë¹„ ì—°ê²°
=========================== */
function startNavi(lat,lng,encodedName){
  location.href=`https://map.kakao.com/link/to/${encodedName},${lat},${lng}`;
}

/* ===========================
   ğŸ”Ÿ ì „ì—­ ì°¸ì¡°
=========================== */
window.capturePhoto=capturePhoto;
window.startNavi=startNavi;
window.closeCard=closeCard;
</script>
</body>
</html>
