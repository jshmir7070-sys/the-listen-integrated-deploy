<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>í˜„ì¬ ì§€ë„ - The Listen</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
<style>
  :root{
    --brand:#007bff;--muted:#6b7280;--ok:#10b981;--danger:#ef4444;
    --card:#fff;--bg:#f7f9fc;--border:#e5e7eb;
  }
  body{margin:0;font-family:"Noto Sans KR",sans-serif;background:var(--bg)}
  header{background:var(--brand);color:#fff;text-align:center;padding:10px;font-weight:800}
  #map{width:100%;height:90vh;position:relative}
  .btn{border:none;padding:10px 14px;border-radius:10px;margin:6px;color:#fff;background:var(--brand);font-weight:700;cursor:pointer}
  .btn.gray{background:#6b7280}
  .btn.green{background:var(--ok)}
  .btn.red{background:var(--danger)}
  .muted{color:var(--muted)}
  .flex{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  /* ë™ ê·¸ë£¹ ì¹´ë“œ */
  #card{position:fixed;left:0;bottom:0;width:100%;background:var(--card);border-radius:16px 16px 0 0;
        box-shadow:0 -4px 14px rgba(0,0,0,.2);transform:translateY(100%);transition:transform .35s;z-index:3}
  #card.active{transform:translateY(0)}
  .card-inner{padding:14px 14px 8px}
  .title{font-weight:900;margin-bottom:6px;text-align:center}
  .list{max-height:40vh;overflow:auto;border:1px solid #eef2f7;border-radius:12px;padding:8px;background:#fff}
  .item{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px;cursor:pointer}
  .item .line1{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .badge{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;border-radius:999px;
         color:#fff;font-weight:900;border:2px solid #fff;font-size:13px}
  .tel{color:var(--brand);text-decoration:none}
  /* ìƒì„¸ ì „ì²´ ì°½ */
  #detail{position:fixed;left:0;top:0;width:100%;height:100%;background:var(--card);
          box-shadow:0 -4px 16px rgba(0,0,0,.25);transform:translateY(100%);transition:transform .35s;z-index:4;overflow-y:auto}
  #detail.active{transform:translateY(0)}
  .detail-inner{padding:16px}
  textarea,input[type="text"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px}
  textarea:disabled,input:disabled{background:#f3f4f6;color:#6b7280}
  .section-title{font-weight:900;margin:10px 0 4px}
  /* ì‚¬ì§„ ë¹„êµ (ì¢Œìš° ëŒ€ì¹­) */
  .thumbs{display:flex;justify-content:space-around;align-items:flex-start;gap:10px;margin:10px 0}
  .thumb-box{width:48%;text-align:center}
  .thumb-box img{width:100%;max-width:240px;height:160px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
  .thumb-label{font-weight:700;margin:4px 0 2px}
  /* ë‚´ ìœ„ì¹˜ */
  .my-location{width:12px;height:12px;background:rgba(0,123,255,.95);border-radius:50%;border:2px solid #fff}
</style>
</head>
<body>
<header>ğŸ—º ì‹¤ì‹œê°„ ì§€ë„ - The Listen</header>
<div id="map"></div>

<!-- ê·¸ë£¹ ì¹´ë“œ -->
<div id="card">
  <div class="card-inner">
    <div id="cardHead" class="title">ê³ ê° ìƒì„¸ ì •ë³´</div>
    <div id="cardAddr" class="muted" style="text-align:center"></div>
    <div class="section-title">ë™ ë‚´ ê³ ê° (ê³ ì¸µâ†’ì €ì¸µ, ì™„ë£Œ í•˜ë‹¨)</div>
    <div id="groupList" class="list"></div>
    <div class="flex"><button class="btn gray" onclick="closeCard()">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- ìƒì„¸ ì¹´ë“œ -->
<div id="detail">
  <div class="detail-inner">
    <h2 id="detailTitle" style="text-align:center;margin-bottom:10px">ê³ ê° ìƒì„¸</h2>
    <div id="detailAddr" class="muted" style="text-align:center;margin-bottom:10px"></div>

    <!-- ì‚¬ì§„ ë¹„êµ UI -->
    <div class="section-title">ğŸ“¸ ì‚¬ì§„ ë¹„êµ (ê¸ˆì¼ / ì§ì „)</div>
    <div class="thumbs">
      <div class="thumb-box"><div class="thumb-label">ê¸ˆì¼</div><img id="imgToday" alt="ê¸ˆì¼ ì—†ìŒ"></div>
      <div class="thumb-box"><div class="thumb-label">ì§ì „</div><img id="imgPrev" alt="ì§ì „ ì—†ìŒ"></div>
    </div>

    <!-- ì •ë³´ ì…ë ¥ -->
    <div class="section-title">ê³µë™í˜„ê´€ ë¹„ë°€ë²ˆí˜¸</div>
    <input id="entCode" type="text" disabled placeholder="ê³ ê° ì œê³µ ë¹„ë°€ë²ˆí˜¸ (ì½ê¸° ì „ìš©)" />

    <div class="section-title">ë°°ì†¡ìš”ì²­ ë©”ëª¨</div>
    <textarea id="reqNote" rows="2" disabled placeholder="ê³ ê° ìš”ì²­ì‚¬í•­ (ì½ê¸° ì „ìš©)"></textarea>

    <div class="section-title">ê¸°ì‚¬ë‹˜ ê³µë™ë¹„ë°€ë²ˆí˜¸ ë“±ë¡ ìš”ì²­</div>
    <input id="driverReq" type="text" placeholder="ê³µë™í˜„ê´€ ë¹„ë°€ë²ˆí˜¸ ë“±ë¡ í•„ìš” ì‹œ ì…ë ¥" />

    <div class="section-title">ê¸°ì‚¬ ëŒ€ì‘ ë©”ëª¨</div>
    <textarea id="driverNote" rows="3" placeholder="í˜„ì¥ ëŒ€ì‘ ë©”ëª¨ (ì…ë ¥ ì‹œ ì €ì¥ë¨)"></textarea>

    <div class="flex" style="margin-top:8px">
      <button class="btn" onclick="triggerPhoto()">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜/ì „ì†¡</button>
      <button class="btn green" onclick="completeDelivery()">âœ… ë°°ë‹¬ì™„ë£Œ</button>
      <button class="btn gray" onclick="closeDetail()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
/* ===== Kakao Map Init ===== */
const map = new kakao.maps.Map(document.getElementById("map"),{
  center:new kakao.maps.LatLng(37.3795,126.806),level:5
});
let deliveries = JSON.parse(localStorage.getItem('deliveriesJSON')||'[]');
if(!deliveries.length){
  const baseLat=37.3795, baseLng=126.806;
  deliveries = Array.from({length:10}).map((_,i)=>{
    const d=100+i, ho=1000+i;
    return {id:`TEST-${d}-${ho}`,name:`í…ŒìŠ¤íŠ¸${i+1}`,
    phone:`0101234${1000+i}`,address:`ê²½ê¸°ë„ ì‹œí¥ì‹œ ìˆ˜í’€ì•ˆê¸¸19-30 ${d}ë™ ${ho}í˜¸`,
    boxes:1+(i%3),lat:baseLat+(Math.random()-0.5)*0.01,lng:baseLng+(Math.random()-0.5)*0.01,order:i+1};
  });
}

/* ===== ë‚´ ìœ„ì¹˜ í‘œì‹œ ===== */
let myCircle=null;
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    const now=new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
    if(!myCircle) myCircle=new kakao.maps.CustomOverlay({map,position:now,content:'<div class="my-location"></div>'});
    else myCircle.setPosition(now);
  });
}

/* ===== Address Parser ===== */
function parseDongHo(addr=""){
  const n=addr.replace(/\s+/g,' ');
  // 1) ìˆ«ìí˜• ë™/í˜¸
  let m=n.match(/(\d{1,4})\s*ë™[^0-9]*(\d{1,4})\s*í˜¸/);
  if(m) return {dong:m[1],ho:+m[2]};
  // 2) í•˜ì´í”ˆ êµ¬ë¶„ (101-1505)
  m=n.match(/(\d{3,4})\s*[-]\s*(\d{1,4})/);
  if(m) return {dong:m[1],ho:+m[2]};
  // 3) ë¬¸ìí˜• Aë™ / ê°€ë™ ë“±
  m=n.match(/([A-Zê°€-í£]+)\s*ë™/);
  if(m) return {dong:m[1],ho:0};
  // 4) ëŒ€ì²´
  const nums=(n.match(/(\d{2,4})/g)||[]); if(nums.length>=2) return {dong:nums.at(-2),ho:+nums.at(-1)};
  return {dong:'0',ho:0};
}
const colorMap=new Map(),palette=["#007bff","#10b981","#f59e0b","#8b5cf6","#ef4444","#14b8a6","#f97316"];
function colorForDong(d){if(!colorMap.has(d))colorMap.set(d,palette[(d.charCodeAt(0)%palette.length)]);return colorMap.get(d);}
const keyPhotos=id=>`photos_${id}`,keyNotes=id=>`notes_${id}`,keyComp='completed';
const load=p=>JSON.parse(localStorage.getItem(p)||'[]');const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ===== ë§ˆì»¤ í‘œì‹œ ===== */
const mkById={},bounds=new kakao.maps.LatLngBounds();
deliveries.forEach(d=>{
  const {dong}=parseDongHo(d.address);const col=colorForDong(dong);
  const el=document.createElement('div');
  el.style.cssText=`width:30px;height:30px;background:${col};color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;border:2px solid #fff;cursor:pointer`;
  el.textContent=d.order;
  const mk=new kakao.maps.CustomOverlay({map,position:new kakao.maps.LatLng(d.lat,d.lng),content:el});
  mkById[d.id]=mk;bounds.extend(new kakao.maps.LatLng(d.lat,d.lng));
  const done=load(keyComp).some(x=>x.id===d.id);if(done)el.style.opacity='0.4';
  el.onclick=()=>openCardForDong(d);
});
if(!bounds.isEmpty())map.setBounds(bounds);

/* ===== ê·¸ë£¹ ì¹´ë“œ ===== */
const card=document.getElementById('card'),cardHead=document.getElementById('cardHead'),cardAddr=document.getElementById('cardAddr'),groupList=document.getElementById('groupList');
let currentDong=null,currentMain=null,currentGroup=[];
function openCardForDong(d){
  const {dong}=parseDongHo(d.address);currentDong=dong;currentMain=d;
  let grp=deliveries.filter(v=>parseDongHo(v.address).dong===dong);
  const done=load(keyComp).map(x=>x.id);
  grp.sort((a,b)=>{
    const ha=parseDongHo(a.address).ho,hb=parseDongHo(b.address).ho;
    if(done.includes(a.id)&&!done.includes(b.id))return 1;
    if(!done.includes(a.id)&&done.includes(b.id))return -1;
    return hb-ha;
  });
  currentGroup=grp;
  cardHead.textContent=`${dong}ë™ ê³ ê° (${grp.length}ê±´)`;cardAddr.textContent=d.address;
  groupList.innerHTML=grp.map(x=>{
    const p=parseDongHo(x.address),col=colorForDong(p.dong);
    const ph=x.phone?x.phone.slice(0,3)+'-****-'+x.phone.slice(-4):'';
    const op=done.includes(x.id)?'opacity:.5;':'';
    return `<div class="item" data-id="${x.id}" style="${op}">
      <div class="line1"><span class="badge" style="background:${col}">${x.order}</span>
      <div style="flex:1"><b>${x.name}</b> Â· ${p.dong}ë™ ${p.ho}í˜¸<br><span class="muted">ğŸ“¦${x.id} Â· ${ph}</span></div>
      ${x.phone?`<a class="tel" href="tel:${x.phone}">ğŸ“</a>`:''}</div></div>`;
  }).join('');
  groupList.querySelectorAll('.item').forEach(el=>{
    el.onclick=()=>{const id=el.dataset.id;const t=currentGroup.find(v=>v.id===id);if(t)openDetail(t);};
  });
  card.classList.add('active');
}
function closeCard(){card.classList.remove('active');}

/* ===== ìƒì„¸ì°½ ===== */
const detail=document.getElementById('detail'),imgToday=document.getElementById('imgToday'),imgPrev=document.getElementById('imgPrev');
const entCode=document.getElementById('entCode'),reqNote=document.getElementById('reqNote'),driverReq=document.getElementById('driverReq'),driverNote=document.getElementById('driverNote');
let sel=null;
function openDetail(c){
  sel=c;
  document.getElementById('detailTitle').textContent=`${c.name} (${c.id})`;
  document.getElementById('detailAddr').textContent=c.address;
  const n=JSON.parse(localStorage.getItem(keyNotes(c.id))||'{}');
  entCode.value=n.entCode||'';reqNote.value=n.reqNote||'';driverReq.value=n.driverReq||'';driverNote.value=n.driverNote||'';
  [driverReq,driverNote].forEach(el=>{
    el.oninput=()=>localStorage.setItem(keyNotes(c.id),JSON.stringify({
      entCode:entCode.value,reqNote:reqNote.value,driverReq:driverReq.value,driverNote:driverNote.value
    }));
  });
  const ph=load(keyPhotos(c.id));
  imgToday.src=ph[0]?.data||'';imgPrev.src=ph[1]?.data||'';
  detail.classList.add('active');
}
function closeDetail(){detail.classList.remove('active');}

/* ===== ì‚¬ì§„ ===== */
function triggerPhoto(){
  if(!sel)return;
  const i=document.createElement('input');i.type='file';i.accept='image/*';i.capture='environment';
  i.onchange=e=>{
    const f=e.target.files?.[0];if(!f)return;
    const r=new FileReader();
    r.onload=()=>{
      const p=load(keyPhotos(sel.id));p.unshift({ts:Date.now(),data:r.result});
      save(keyPhotos(sel.id),p);
      imgToday.src=p[0]?.data||'';imgPrev.src=p[1]?.data||'';
      alert('ì‚¬ì§„ ì €ì¥ ì™„ë£Œ');
    };
    r.readAsDataURL(f);
  };
  i.click();
}

/* ===== ì™„ë£Œ ì²˜ë¦¬ ===== */
function completeDelivery(){
  if(!sel)return;
  const m=mkById[sel.id];if(m)m.getContent().style.opacity='0.4';
  const comp=load(keyComp);comp.push({id:sel.id,date:new Date().toISOString(),address:sel.address});
  save(keyComp,comp);
  alert('âœ… ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  closeDetail();
  if(currentMain)openCardForDong(currentMain);
}
</script>
</body>
</html>
