<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>The Listen - ì•„íŒŒíŠ¸ ë°°ì†¡ ì§€ë„</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
<style>
  body{margin:0;font-family:"Noto Sans KR",sans-serif;background:#f7f9fc}
  header{background:#007bff;color:#fff;text-align:center;padding:10px;font-weight:700}
  #map{width:100%;height:90vh}
  #customerCard{
    position:fixed;left:0;bottom:0;width:100%;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;
    box-shadow:0 -6px 20px rgba(0,0,0,.25);transform:translateY(100%);transition:transform .35s ease;max-height:60vh;overflow-y:auto;z-index:9999;
  }
  #customerCard.active{transform:translateY(0)}
  .card-header{text-align:center;padding:12px;font-weight:900}
  .delivery-item{padding:12px 18px;border-top:1px solid #eee}
  .btn-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .btn{border:none;border-radius:10px;padding:10px 14px;color:#fff;background:#007bff;cursor:pointer;font-weight:700}
  .btn.gray{background:#6b7280}
  .tag{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;background:#eef4ff;color:#3563ff;font-size:.8rem}
  .my-location-dot{width:12px;height:12px;background:rgba(0,123,255,.95);border-radius:50%;border:2px solid #fff}
</style>
</head>
<body>
<header>ğŸ“ ì•„íŒŒíŠ¸ ë‹¨ì§€ ë‚´ ë™ë³„ ë°°ì†¡ (The Listen)</header>
<div id="map"></div>

<div id="customerCard">
  <div class="card-header">ê³ ê° ìƒì„¸ ì •ë³´</div>
  <div id="card-content"></div>
</div>

<script>
const map = new kakao.maps.Map(document.getElementById("map"), {
  center: new kakao.maps.LatLng(37.5165,127.1053), // ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 300 ì¼ëŒ€
  level: 5
});
const geocoder = new kakao.maps.services.Geocoder();
let myPosition=null;
const markerById={};
let resolvedList=[];
let markersDrawn=false;

// ë‚´ ìœ„ì¹˜ íŒŒë€ ì 
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    myPosition=new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
    if(!window.myCircle){
      window.myCircle=new kakao.maps.CustomOverlay({
        position:myPosition,
        content:'<div class="my-location-dot"></div>',
        map
      });
    }else window.myCircle.setPosition(myPosition);
  },err=>console.warn('GPS ë¹„í™œì„±í™”',err),{enableHighAccuracy:true});
}

// 4ê°€êµ¬ í…ŒìŠ¤íŠ¸ ë°ì´í„° (ì‹¤ì œ ìœ„ì¹˜ ê¸°ë°˜)
const deliveries=[
  {id:"DLV101",name:"ê³ ê°A",phone:"010-1111-2222",address:"ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 300 (101ë™ 202í˜¸)",boxes:2},
  {id:"DLV104",name:"ê³ ê°B",phone:"010-2222-3333",address:"ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 300 (104ë™ 303í˜¸)",boxes:1},
  {id:"DLV106A",name:"ê³ ê°C",phone:"010-3333-4444",address:"ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 300 (106ë™ 1001í˜¸)",boxes:3},
  {id:"DLV106B",name:"ê³ ê°D",phone:"010-4444-5555",address:"ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 300 (106ë™ 202í˜¸)",boxes:2}
];

// ê±°ë¦¬ê³„ì‚°
function distKm(a,b,c,d){
  const R=6371,dLat=(c-a)*Math.PI/180,dLng=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

// ì£¼ì†Œâ†’ì¢Œí‘œ
let geocodeDone=0;
deliveries.forEach(d=>{
  geocoder.addressSearch(d.address,(res,status)=>{
    geocodeDone++;
    if(status===kakao.maps.services.Status.OK&&res[0]){
      d.lat=Number(res[0].y);d.lng=Number(res[0].x);
      resolvedList.push(d);
    }
    if(geocodeDone===deliveries.length) drawMarkersSorted();
  });
});

// ë‚´ ìœ„ì¹˜ ê¸°ì¤€ ì •ë ¬ í›„ ë§ˆì»¤ ìƒì„±
function drawMarkersSorted(){
  if(markersDrawn||resolvedList.length===0)return;
  let list=[...resolvedList];
  if(myPosition){
    const myLat=myPosition.getLat(),myLng=myPosition.getLng();
    list.sort((a,b)=>distKm(myLat,myLng,a.lat,a.lng)-distKm(myLat,myLng,b.lat,b.lng));
  }
  list.forEach((d,i)=>placeMarker(d,i+1));
  markersDrawn=true;
}

function placeMarker(d,order){
  const el=document.createElement('div');
  el.style.cssText=`background:#007bff;color:#fff;border-radius:50%;
    width:30px;height:30px;display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:13px;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.3);cursor:pointer;`;
  el.textContent=order;
  const overlay=new kakao.maps.CustomOverlay({
    position:new kakao.maps.LatLng(d.lat,d.lng),
    content:el,
    map
  });
  markerById[d.id]=overlay;
  el.addEventListener('click',()=>openCard(d,order));
}

// ê³ ê°ì¹´ë“œ
function openCard(d,order){
  const card=document.getElementById('customerCard');
  const box=document.getElementById('card-content');
  box.innerHTML=`
    <div class="delivery-item" style="text-align:center;">
      <div style="font-size:1.05rem;font-weight:900;">${order}ï¸âƒ£ ìˆœë²ˆ <span class="tag">${d.address.match(/\((.*?)\)/)[1]}</span></div>
      <p><b>ê³ ê°</b>: ${d.name}</p>
      <p><b>ì „í™”ë²ˆí˜¸</b>: ${d.phone}</p>
      <p><b>ì£¼ì†Œ</b>: ${d.address}</p>
      <p><b>ìš´ì†¡ì¥</b>: ${d.id}</p>
      <p><b>ë°•ìŠ¤ìˆ˜ëŸ‰</b>: ${d.boxes}ê°œ</p>
      <div class="btn-row">
        <button class="btn" onclick="startNavi(${d.lat},${d.lng}, '${encodeURIComponent(d.address)}')">ğŸš˜ ë„¤ë¹„ ì—°ê²°</button>
        <button class="btn" onclick="capturePhoto('${d.id}','${d.address}')">ğŸ“¸ ì‚¬ì§„ ì „ì†¡</button>
        <button class="btn gray" onclick="closeCard()">ë‹«ê¸°</button>
      </div>
    </div>`;
  card.classList.add('active');
}
function closeCard(){document.getElementById('customerCard').classList.remove('active');}

// ì‚¬ì§„ì´¬ì˜ í›„ ë§ˆì»¤ íˆ¬ëª…í™”
function capturePhoto(id,address){
  const input=document.createElement('input');
  input.type='file';input.accept='image/*';input.capture='environment';
  input.onchange=e=>{
    const f=e.target.files&&e.target.files[0];if(!f)return;
    alert(`ğŸ“¸ ì „ì†¡ ì™„ë£Œ\nì£¼ì†Œ:${address}\nìš´ì†¡ì¥:${id}`);
    const mk=markerById[id];if(mk)mk.getContent().style.opacity='0.4';
    closeCard();
  };
  input.click();
}

// ì¹´ì¹´ì˜¤ë„¤ë¹„ ì—°ë™
function startNavi(lat,lng,encodedName){
  location.href=`https://map.kakao.com/link/to/${encodedName},${lat},${lng}`;
}
window.capturePhoto=capturePhoto;
window.closeCard=closeCard;
window.startNavi=startNavi;
</script>
</body>
</html>
