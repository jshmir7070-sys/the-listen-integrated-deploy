<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>í˜„ì¬ ì§€ë„ë³´ê¸° - The Listen</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
<style>
  body{margin:0;font-family:"Noto Sans KR",sans-serif;background:#f7f9fc}
  header{background:#007bff;color:#fff;text-align:center;padding:10px;font-weight:700}
  #map{width:100%;height:90vh}
  #customerCard{
    position:fixed;left:0;bottom:0;width:100%;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;
    box-shadow:0 -6px 20px rgba(0,0,0,.25);transform:translateY(100%);transition:transform .35s ease;max-height:60vh;overflow-y:auto;z-index:9999;
  }
  #customerCard.active{transform:translateY(0)}
  .card-header{text-align:center;padding:12px;font-weight:900}
  .delivery-item{padding:12px 18px;border-top:1px solid #eee}
  .btn-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .btn{border:none;border-radius:10px;padding:10px 14px;color:#fff;background:#007bff;cursor:pointer;font-weight:700}
  .btn.gray{background:#6b7280}
  .tag{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;background:#eef4ff;color:#3563ff;font-size:.8rem}
  .my-location-dot{width:12px;height:12px;background:rgba(0,123,255,.95);border-radius:50%;border:2px solid #fff}
</style>
</head>
<body>
<header>í˜„ì¬ ì§€ë„ë³´ê¸° (ì‹¤ì£¼ì†Œ/ê³ ê°ì¹´ë“œ/ì‚¬ì§„ì „ì†¡/ë„¤ë¹„ ì—°ë™)</header>
<div id="map"></div>

<div id="customerCard">
  <div class="card-header">ê³ ê° ìƒì„¸ ì •ë³´</div>
  <div id="card-content"></div>
</div>

<script>
const map = new kakao.maps.Map(document.getElementById("map"), {
  center:new kakao.maps.LatLng(37.4979,127.0276), level:5
});
const geocoder = new kakao.maps.services.Geocoder();
let myPosition=null;
const markerById={};
let resolvedList=[];
let markersDrawn=false;

// ë‚´ ìœ„ì¹˜(íŒŒë€ ì )
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    myPosition=new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
    if(!window.myCircle){
      window.myCircle=new kakao.maps.CustomOverlay({position:myPosition,content:'<div class="my-location-dot"></div>',map});
    }else{ window.myCircle.setPosition(myPosition); }
    if(resolvedList.length>0 && !markersDrawn) drawMarkersSorted();
  },err=>console.warn('GPS:',err),{enableHighAccuracy:true});
}

// ì•„íŒŒíŠ¸ ë‹¨ì§€ + ì¼ë°˜ ì£¼ì†Œ í˜¼í•©(ì‹¤ì¡´ ë„ë¡œëª…) â€” ë‹¤ê°€êµ¬ í…ŒìŠ¤íŠ¸ í¬í•¨
const aptBase = "ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 300";
const deliveriesRaw = [
  // ì•„íŒŒíŠ¸ ë‹¨ì§€ ê°™ì€ ì¢Œí‘œ(ë™/í˜¸ìˆ˜ ë‹¤ë¥¸ ê³ ê°ë“¤) â€” í•œ ìœ„ì¹˜ì— ì—¬ëŸ¬ ì§‘
  {id:"A101-01", name:"ê¹€ì•„íŒŒíŠ¸", phone:"010-1111-2222", address:`${aptBase} (101ë™ 1201í˜¸)`, boxes:2},
  {id:"A101-02", name:"ì´ì•„íŒŒíŠ¸", phone:"010-2222-3333", address:`${aptBase} (101ë™ 605í˜¸)`, boxes:1},
  {id:"A102-01", name:"ë°•ì•„íŒŒíŠ¸", phone:"010-3333-4444", address:`${aptBase} (102ë™ 801í˜¸)`, boxes:3},
  // ì¼ë°˜ ë¶„ì‚° ì£¼ì†Œ
  {id:"DLV001", name:"ê³ ê°1", phone:"010-1000-2000", address:"ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 231", boxes:1},
  {id:"DLV002", name:"ê³ ê°2", phone:"010-1001-2001", address:"ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ë°˜í¬ëŒ€ë¡œ 222", boxes:1},
  {id:"DLV003", name:"ê³ ê°3", phone:"010-1002-2002", address:"ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬ ì—¬ì˜ë‚˜ë£¨ë¡œ 76", boxes:2},
];
// ë‚˜ë¨¸ì§€ëŠ” ëª©ë¡ì„ ëŠ˜ë ¤ 1~200 ì¶©ì¡±(ë°ëª¨)
const baseAddrs = [
  "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 231","ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ ì›”ë“œì»µë¶ë¡œ 400","ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë™êµ¬ ì™•ì‹­ë¦¬ë¡œ 115",
  "ì„œìš¸íŠ¹ë³„ì‹œ ë…¸ì›êµ¬ ë™ì¼ë¡œ 900","ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ì¢…ë¡œ 33","ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ì„¸ì¢…ëŒ€ë¡œ 110","ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬ ì²œí˜¸ëŒ€ë¡œ 1000"
];
while(deliveriesRaw.length<200){
  const i = deliveriesRaw.length+1;
  deliveriesRaw.push({
    id:`DLV${String(i).padStart(3,'0')}`, name:`ê³ ê°${i}`,
    phone:`010-${(1000+i).toString().slice(-4)}-${(2000+i).toString().slice(-4)}`,
    address: baseAddrs[i % baseAddrs.length], boxes: (i%3)+1
  });
}

// ê±°ë¦¬ ê³„ì‚°(Haversine)
function distKm(a,b,c,d){
  const R=6371, dLat=(c-a)*Math.PI/180, dLng=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

// ì£¼ì†Œâ†’ì¢Œí‘œ
let geocodeDone=0;
deliveriesRaw.forEach(d=>{
  geocoder.addressSearch(d.address,(res,status)=>{
    geocodeDone++;
    if(status===kakao.maps.services.Status.OK && res[0]){
      d.lat=Number(res[0].y); d.lng=Number(res[0].x);
      resolvedList.push(d);
    }
    if(geocodeDone===deliveriesRaw.length) drawMarkersSorted();
  });
});

function drawMarkersSorted(){
  if(markersDrawn || resolvedList.length===0) return;
  let list=[...resolvedList];
  if(myPosition){
    const myLat=myPosition.getLat(), myLng=myPosition.getLng();
    list.sort((a,b)=>distKm(myLat,myLng,a.lat,a.lng)-distKm(myLat,myLng,b.lat,b.lng));
  }
  list.forEach((d,idx)=>placeMarker(d,idx+1));
  markersDrawn=true;
  // ì´ ê±´ìˆ˜ ì €ì¥ â†’ ëŒ€ì‹œë³´ë“œ í‘œì‹œìš©
  localStorage.setItem('totalDeliveries', String(list.length));
}

function placeMarker(d, order){
  const el=document.createElement('div');
  el.style.cssText=`
    background:#007bff;color:#fff;border-radius:50%;width:30px;height:30px;
    display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;
    border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.3);cursor:pointer;`;
  el.textContent=order;
  const overlay=new kakao.maps.CustomOverlay({position:new kakao.maps.LatLng(d.lat,d.lng),content:el,map});
  markerById[d.id]=overlay;
  el.addEventListener('click',()=>openCard(d,order));
}

function openCard(d, order){
  const card=document.getElementById('customerCard'), box=document.getElementById('card-content');
  // ë™ì¼ ì£¼ì†Œ ë‹¤ê°€êµ¬(ë™Â·í˜¸) ë¬¶ìŒ í‘œì‹œ: ê°™ì€ address(ê´„í˜¸ ì• ë¶€ë¶„)ê°€ ê°™ì€ ë‹¨ì§€ë¡œ ê°€ì •
  const base = d.address.split(' (')[0];
  const group = resolvedList.filter(x=>x.address.startsWith(base));
  const header = `<div class="delivery-item" style="text-align:center;">
    <div style="font-size:1.05rem;font-weight:900;">${order}ï¸âƒ£ ìˆœë²ˆ <span class="tag">ë¬¶ìŒ ${group.length}ì„¸ëŒ€</span></div>
    <p><b>ë‹¨ì§€ ì£¼ì†Œ</b> : ${base}</p>
    <div class="btn-row">
      <button class="btn" onclick="startNavi(${d.lat},${d.lng}, '${encodeURIComponent(base)}')">ğŸš˜ ì¹´ì¹´ì˜¤ë„¤ë¹„</button>
      <button class="btn gray" onclick="closeCard()">ë‹«ê¸°</button>
    </div>
  </div>`;

  const listHtml = group.map(g=>`
    <div class="delivery-item">
      <p><b>ê³ ê°</b> ${g.name} &nbsp; <b>ìš´ì†¡ì¥</b> ${g.id} &nbsp; <span class="tag">ë°•ìŠ¤ ${g.boxes}ê°œ</span></p>
      <p><b>ìƒì„¸ì£¼ì†Œ</b> : ${g.address}</p>
      <p><b>ì „í™”</b> : ${g.phone}</p>
      <div class="btn-row">
        <button class="btn" onclick="capturePhoto('${g.id}','${g.address.replaceAll("'","")}')">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜Â·ì „ì†¡</button>
      </div>
    </div>`).join('');

  box.innerHTML = header + listHtml;
  card.classList.add('active');
}

function closeCard(){ document.getElementById('customerCard').classList.remove('active'); }

function capturePhoto(id,address){
  const input=document.createElement('input');
  input.type='file'; input.accept='image/*'; input.capture='environment';
  input.onchange=(e)=>{
    const f=e.target.files && e.target.files[0]; if(!f) return;
    alert(`ğŸ“¸ ì „ì†¡ ì™„ë£Œ\nÂ· ì£¼ì†Œ: ${address}\nÂ· ìš´ì†¡ì¥: ${id}`);
    // ì™„ë£Œ ì €ì¥(ë‹¹ì¼)
    const today = new Date().toISOString().slice(0,10);
    const completed = JSON.parse(localStorage.getItem('completed')||'[]');
    completed.push({id,address,date:today,photo:true});
    localStorage.setItem('completed', JSON.stringify(completed));
    // ë§ˆì»¤ ë°˜íˆ¬ëª… ì²˜ë¦¬
    const mk=markerById[id]; if(mk) mk.getContent().style.opacity='0.4';
  };
  input.click();
}

function startNavi(lat,lng,encodedName){
  location.href = `https://map.kakao.com/link/to/${encodedName},${lat},${lng}`;
}

window.closeCard=closeCard;
window.capturePhoto=capturePhoto;
window.startNavi=startNavi;
</script>
</body>
</html>
