<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>í˜„ì¬ ì§€ë„ - The Listen</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
<style>
  :root{
    --brand:#007bff;--muted:#6b7280;--ok:#10b981;--danger:#ef4444;
    --card:#fff;--bg:#f7f9fc;--border:#e5e7eb;
  }
  body{margin:0;font-family:"Noto Sans KR",sans-serif;background:var(--bg)}
  header{background:var(--brand);color:#fff;text-align:center;padding:10px;font-weight:800}
  #map{width:100%;height:90vh;position:relative}

  /* ê³µí†µ ë²„íŠ¼/í…ìŠ¤íŠ¸ */
  .btn{border:none;padding:10px 14px;border-radius:10px;margin:6px;color:#fff;background:var(--brand);font-weight:700;cursor:pointer}
  .btn.gray{background:#6b7280}
  .btn.green{background:var(--ok)}
  .btn.red{background:var(--danger)}
  .muted{color:var(--muted)}
  .flex{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

  /* í•˜ë‹¨ ì¹´ë“œ (ë™ ê·¸ë£¹) */
  #card{position:fixed;left:0;bottom:0;width:100%;background:var(--card);border-radius:16px 16px 0 0;
        box-shadow:0 -4px 14px rgba(0,0,0,.2);transform:translateY(100%);transition:transform .35s;z-index:3}
  #card.active{transform:translateY(0)}
  .card-inner{padding:14px 14px 8px}
  .title{font-weight:900;margin-bottom:6px;text-align:center}
  .list{max-height:40vh;overflow:auto;border:1px solid #eef2f7;border-radius:12px;padding:8px;background:#fff}
  .item{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px;cursor:pointer}
  .item .line1{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .badge{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;border-radius:999px;
         color:#fff;font-weight:900;border:2px solid #fff;font-size:13px}
  .tel{color:var(--brand);text-decoration:none}

  /* ìƒì„¸ ì¹´ë“œ (ê³ ê° ì„¸ë¶€) */
  #detail{position:fixed;left:0;bottom:0;width:100%;background:var(--card);border-radius:16px 16px 0 0;
          box-shadow:0 -4px 16px rgba(0,0,0,.25);transform:translateY(100%);transition:transform .35s;z-index:4}
  #detail.active{transform:translateY(0)}
  .detail-inner{padding:14px 14px 10px}
  .row{display:flex;gap:8px}
  .col{flex:1}
  textarea,input[type="text"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px}
  .kv{display:flex;gap:6px;align-items:center}
  .kv b{min-width:90px}
  .section-title{font-weight:900;margin:8px 0 4px}

  /* ì‚¬ì§„ ì¸ë„¤ì¼ */
  .thumbs{display:flex;gap:8px;flex-wrap:wrap}
  .thumb{width:46%;max-width:240px}
  .thumb img{width:100%;height:160px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
  .thumb .lbl{font-weight:700;margin:4px 0 2px}

  /* ë‚´ ìœ„ì¹˜ */
  .my-location{width:12px;height:12px;background:rgba(0,123,255,.95);border-radius:50%;border:2px solid #fff}
</style>
</head>
<body>
<header>ğŸ—º ì‹¤ì‹œê°„ ì§€ë„ - The Listen</header>
<div id="map"></div>

<!-- ë™ ê·¸ë£¹ ì¹´ë“œ -->
<div id="card">
  <div class="card-inner">
    <div id="cardHead" class="title">ê³ ê° ìƒì„¸ ì •ë³´</div>
    <div id="cardAddr" class="muted" style="text-align:center"></div>

    <div class="section-title">ë™ ë‚´ ê³ ê° (ê³ ì¸µ â†’ ì €ì¸µ)</div>
    <div id="groupList" class="list"></div>

    <div class="flex">
      <button class="btn gray" onclick="closeCard()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ê³ ê° ìƒì„¸ ì¹´ë“œ -->
<div id="detail">
  <div class="detail-inner">
    <div class="title" id="detailTitle">ê³ ê° ìƒì„¸</div>
    <div class="kv muted" id="detailAddr"></div>

    <div class="row">
      <div class="col">
        <div class="section-title">ê³µë™í˜„ê´€ ë¹„ë°€ë²ˆí˜¸</div>
        <input id="entCode" type="text" placeholder="ì˜ˆ) *1234# (ì…ë ¥ ì‹œ ì €ì¥ë¨)" />
      </div>
      <div class="col">
        <div class="section-title">ë°°ì†¡ìš”ì²­ ë©”ëª¨</div>
        <input id="reqNote" type="text" placeholder="ì˜ˆ) ê²½ë¹„ì‹¤ ë§¡ê²¨ì£¼ì„¸ìš” (ì…ë ¥ ì‹œ ì €ì¥ë¨)" />
      </div>
    </div>

    <div class="section-title">ê¸°ì‚¬ ëŒ€ì‘ ë©”ëª¨</div>
    <textarea id="driverNote" rows="3" placeholder="í˜„ì¥ ëŒ€ì‘ ë©”ëª¨ (ì…ë ¥ ì‹œ ì €ì¥ë¨)"></textarea>

    <div class="section-title">ì‚¬ì§„ ë¹„êµ (ë‹¹ì¼ / ì§ì „)</div>
    <div class="thumbs">
      <div class="thumb">
        <div class="lbl">ê¸ˆì¼</div>
        <img id="imgToday" alt="ê¸ˆì¼ ì‚¬ì§„ ì—†ìŒ">
      </div>
      <div class="thumb">
        <div class="lbl">ì§ì „</div>
        <img id="imgPrev" alt="ì§ì „ ì‚¬ì§„ ì—†ìŒ">
      </div>
    </div>

    <div class="flex" style="margin-top:8px">
      <button class="btn" onclick="triggerPhoto()">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜/ì „ì†¡</button>
      <button class="btn green" onclick="completeDelivery()">âœ… ë°°ë‹¬ì™„ë£Œ</button>
      <button class="btn gray" onclick="closeDetail()">ë’¤ë¡œ</button>
    </div>
  </div>
</div>

<script>
/** ============ ì§€ë„ ì´ˆê¸°í™” ============ **/
const map = new kakao.maps.Map(document.getElementById("map"),{
  center: new kakao.maps.LatLng(37.3795,126.806), level:5
});
const geocoder = new kakao.maps.services.Geocoder();

/** ============ ë°ì´í„° ë¡œë“œ/ì‹œë“œ ============ **/
let deliveries = []; 
try { deliveries = JSON.parse(localStorage.getItem('deliveriesJSON')||'[]'); } catch(e) { deliveries = []; }

// ë…ë¦½ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì‹œë“œ (ì—†ìœ¼ë©´ ìë™ 10ê°€êµ¬ ìƒì„±)
if (!deliveries.length) {
  const baseLat=37.3795, baseLng=126.806;
  deliveries = Array.from({length:10}).map((_,i)=>{
    const d = 101 + (i%3)*2;       // 101,103,105 ë™
    const ho = 1100 - i*10;        // 1100,1090...
    return {
      id:`SEED-${d}-${ho}`,
      name:`í…ŒìŠ¤íŠ¸${i+1}`,
      phone:`010-12${i}3-45${i}6`,
      address:`ê²½ê¸°ë„ ì‹œí¥ì‹œ ìˆ˜í’€ì•ˆê¸¸ 19-30 ${d}ë™ ${ho}í˜¸`,
      boxes:1+(i%3),
      lat: baseLat + (Math.random()-0.5)*0.01,
      lng: baseLng + (Math.random()-0.5)*0.01,
      order: i+1
    };
  });
}

/** ============ ë‚´ ìœ„ì¹˜ í‘œì‹œ ============ **/
let myCircle=null;
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos=>{
    const now = new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
    if (!myCircle) {
      myCircle = new kakao.maps.CustomOverlay({ map, position: now, content:'<div class="my-location"></div>' });
    } else {
      myCircle.setPosition(now);
    }
  },()=>{}, {enableHighAccuracy:true});
}

/** ============ ìœ í‹¸ ============ **/
// ì£¼ì†Œì—ì„œ "ë™"ê³¼ "í˜¸"ë¥¼ íŒŒì‹± (ë„ì–´ì“°ê¸°/í•˜ì´í”ˆ/ì½¤ë¹„ ëŒ€ì‘)
function parseDongHo(address="") {
  const normalized = address.replace(/\s+/g,' ').trim();
  let m = normalized.match(/(\d+)\s*ë™[^0-9]*(\d+)\s*í˜¸/);
  if (m) return { dong: m[1], ho: parseInt(m[2],10) || 0 };
  m = normalized.match(/(\d{3,4})\s*[-\~]\s*(\d{1,4})/);
  if (m) return { dong: m[1], ho: parseInt(m[2],10) || 0 };
  const nums = (normalized.match(/(\d{1,4})/g)||[]).map(n=>parseInt(n,10));
  if (nums.length>=2) return { dong: String(nums[nums.length-2]), ho: nums[nums.length-1] };
  return { dong: '0', ho: 0 };
}

// ë™ â†’ ìƒ‰ìƒ (ë™ë§ˆë‹¤ ë™ì¼ ìƒ‰ ìœ ì§€)
const dongColorMap = new Map();
const palette = ["#007bff","#10b981","#f59e0b","#6b7280","#8b5cf6","#ef4444","#14b8a6","#f97316"];
function colorForDong(dong) {
  if (!dongColorMap.has(dong)) {
    const idx = (parseInt(dong,10) || dong.length) % palette.length;
    dongColorMap.set(dong, palette[idx]);
  }
  return dongColorMap.get(dong);
}

// ë¡œì»¬ í‚¤
const photoKey   = id => `photos_${id}`;       // [{ts,data(base64)}, ...]
const noteKey    = id => `notes_${id}`;        // {entCode, reqNote, driverNote}
const completedK = 'completed';                // ì™„ë£Œ ë¡œê·¸ ë°°ì—´ [{id,date,address}]

// ë©”ëª¨ ì½ê¸°/ì“°ê¸°
function loadNotes(id){
  try { return JSON.parse(localStorage.getItem(noteKey(id))||'{}'); } catch(e){ return {}; }
}
function saveNotes(id, obj){
  localStorage.setItem(noteKey(id), JSON.stringify(obj||{}));
}

// ì‚¬ì§„ ì½ê¸°/ì“°ê¸°
function loadPhotos(id){
  try { return JSON.parse(localStorage.getItem(photoKey(id))||'[]'); } catch(e){ return []; }
}
function savePhotos(id, arr){
  localStorage.setItem(photoKey(id), JSON.stringify(arr||[]));
}

/** ============ ë§ˆì»¤ ìƒì„± ============ **/
const markerById = {};
const bounds = new kakao.maps.LatLngBounds();

deliveries.forEach((d,i)=>{
  if (!d.order) d.order = i+1;
  const { dong } = parseDongHo(d.address||"");
  const color = colorForDong(dong);

  const el = document.createElement('div');
  el.style.cssText = `
    width:30px;height:30px;background:${color};border-radius:50%;
    color:#fff;display:flex;align-items:center;justify-content:center;
    font-weight:900;cursor:pointer;border:2px solid #fff;font-size:13px;`;
  el.textContent = d.order;

  const marker = new kakao.maps.CustomOverlay({
    map, position: new kakao.maps.LatLng(d.lat, d.lng), content: el
  });
  markerById[d.id] = marker;
  bounds.extend(new kakao.maps.LatLng(d.lat,d.lng));

  // ì™„ë£Œëœ í•­ëª©ì€ ë°˜íˆ¬ëª…
  const comp = JSON.parse(localStorage.getItem(completedK)||'[]');
  if (comp.some(x=>x.id===d.id)) el.style.opacity='0.4';

  el.addEventListener('click', ()=> openCardForDong(d));
});

if (!bounds.isEmpty()) map.setBounds(bounds);

/** ============ ë™ ê·¸ë£¹ ì¹´ë“œ ============ **/
const card = document.getElementById('card');
const cardHead = document.getElementById('cardHead');
const cardAddr = document.getElementById('cardAddr');
const groupList = document.getElementById('groupList');

// í˜„ì¬ ì„ íƒ ì»¨í…ìŠ¤íŠ¸
let currentDong = null;
let currentMain = null; // ëŒ€í‘œ(í´ë¦­í•œ) ê³ ê°
let currentGroup = [];  // í•´ë‹¹ ë™ì˜ ê³ ê°ë“¤

function openCardForDong(d){
  const { dong } = parseDongHo(d.address||"");
  currentDong = dong;
  currentMain = d;

  // ê°™ì€ "ë™" ê³ ê°ë§Œ ëª¨ìœ¼ê³  â€” ê³ ì¸µâ†’ì €ì¸µ ì •ë ¬
  const sameDong = deliveries
    .filter(x => parseDongHo(x.address||"").dong === dong)
    .sort((a,b)=>parseDongHo(b.address||"").ho - parseDongHo(a.address||"").ho);

  currentGroup = sameDong;
  cardHead.textContent = `${dong}ë™ ê³ ê° (${sameDong.length}ê±´)`;
  cardAddr.textContent = d.address || '';

  // ê·¸ë£¹ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ê° item í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ ì˜¤í”ˆ)
  groupList.innerHTML = sameDong.map(x=>{
    const p = parseDongHo(x.address||"");
    const col = colorForDong(String(p.dong));
    const phoneMask = x.phone ? (x.phone.slice(0,3)+'-****-'+x.phone.slice(-4)) : '';
    const comp = JSON.parse(localStorage.getItem(completedK)||'[]');
    const opaque = comp.some(v=>v.id===x.id) ? 'opacity:.5;' : '';
    return `
      <div class="item" data-id="${x.id}" style="${opaque}">
        <div class="line1">
          <span class="badge" style="background:${col}">${x.order||'-'}</span>
          <div style="flex:1">
            <div><b>${x.name||'ê³ ê°'}</b> Â· ${p.dong}ë™ ${p.ho||'-'}í˜¸</div>
            <div class="muted">ğŸ“¦ ${x.id||''} Â· ${phoneMask}</div>
            <div>${x.address||''}</div>
          </div>
          ${x.phone?`<a class="tel" href="tel:${x.phone}" title="ì „í™”">ğŸ“</a>`:''}
        </div>
      </div>
    `;
  }).join('');

  // ì•„ì´í…œ í´ë¦­ í•¸ë“¤ëŸ¬
  groupList.querySelectorAll('.item').forEach(el=>{
    el.addEventListener('click',()=>{
      const id = el.getAttribute('data-id');
      const target = currentGroup.find(v=>v.id===id);
      if (target) openDetail(target);
    });
  });

  card.classList.add('active');
}
function closeCard(){ card.classList.remove('active'); }

/** ============ ê³ ê° ìƒì„¸ ì¹´ë“œ ============ **/
const detail = document.getElementById('detail');
const detailTitle = document.getElementById('detailTitle');
const detailAddr  = document.getElementById('detailAddr');
const entCodeEl   = document.getElementById('entCode');
const reqNoteEl   = document.getElementById('reqNote');
const driverNoteEl= document.getElementById('driverNote');
const imgTodayEl  = document.getElementById('imgToday');
const imgPrevEl   = document.getElementById('imgPrev');

let sel = null; // í˜„ì¬ ìƒì„¸ì˜ ê³ ê° ê°ì²´

function openDetail(customer){
  sel = customer;
  detailTitle.textContent = `${customer.name} â€” ${customer.id}`;
  detailAddr.textContent  = customer.address || '';

  // ë…¸íŠ¸ ë¡œë“œ
  const notes = loadNotes(customer.id);
  entCodeEl.value    = notes.entCode    || '';
  reqNoteEl.value    = notes.reqNote    || '';
  driverNoteEl.value = notes.driverNote || '';

  // ì‚¬ì§„ ë¹„êµ ë¡œë“œ (0:ìµœì‹ =ê¸ˆì¼, 1:ì§ì „)
  const photos = loadPhotos(customer.id);
  const today = photos[0]; const prev = photos[1];
  imgTodayEl.src = today ? today.data : '';
  imgTodayEl.alt = today ? 'ê¸ˆì¼ ì‚¬ì§„' : 'ê¸ˆì¼ ì‚¬ì§„ ì—†ìŒ';
  imgPrevEl.src  = prev  ? prev.data  : '';
  imgPrevEl.alt  = prev  ? 'ì§ì „ ì‚¬ì§„' : 'ì§ì „ ì‚¬ì§„ ì—†ìŒ';

  // ì…ë ¥ ì¦‰ì‹œ ì €ì¥
  [entCodeEl, reqNoteEl, driverNoteEl].forEach($el=>{
    $el.oninput = ()=>{
      saveNotes(customer.id, {
        entCode: entCodeEl.value.trim(),
        reqNote: reqNoteEl.value.trim(),
        driverNote: driverNoteEl.value.trim()
      });
    };
  });

  detail.classList.add('active');
}
function closeDetail(){ detail.classList.remove('active'); }

/** ============ ì‚¬ì§„ ì´¬ì˜/ì „ì†¡/ë¹„êµ ============ **/
function triggerPhoto(){
  if (!sel) return;
  const input = document.createElement('input');
  input.type='file'; input.accept='image/*'; input.capture='environment';
  input.onchange = e=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const fr = new FileReader();
    fr.onload = () => {
      const arr = loadPhotos(sel.id);
      arr.unshift({ ts: Date.now(), data: fr.result }); // ìµœì‹ ì´ ì•
      savePhotos(sel.id, arr);
      // í™”ë©´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
      imgPrevEl.src  = arr[1]?.data || '';
      imgPrevEl.alt  = arr[1] ? 'ì§ì „ ì‚¬ì§„' : 'ì§ì „ ì‚¬ì§„ ì—†ìŒ';
      imgTodayEl.src = arr[0]?.data || '';
      imgTodayEl.alt = arr[0] ? 'ê¸ˆì¼ ì‚¬ì§„' : 'ê¸ˆì¼ ì‚¬ì§„ ì—†ìŒ';
      alert('ğŸ“¸ ì‚¬ì§„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };
    fr.readAsDataURL(f);
  };
  input.click();
}

/** ============ ì™„ë£Œ ì²˜ë¦¬ ============ **/
function completeDelivery(){
  if (!sel) return;
  // ë§ˆì»¤ ë°˜íˆ¬ëª… ì²˜ë¦¬
  const mk = markerById[sel.id];
  if (mk) mk.getContent().style.opacity='0.4';

  // ì™„ë£Œ ëª©ë¡ ê¸°ë¡
  const comp = JSON.parse(localStorage.getItem(completedK)||'[]');
  comp.push({ id: sel.id, date: new Date().toISOString(), address: sel.address });
  localStorage.setItem(completedK, JSON.stringify(comp));

  alert('âœ… ë°°ë‹¬ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  closeDetail();
  // ê·¸ë£¹ ì¹´ë“œë„ ê°±ì‹ (ì™„ë£Œ í‘œì‹œ ë°˜ì˜)
  if (currentMain) openCardForDong(currentMain);
}

/** ============ ë„¤ë¹„ê²Œì´ì…˜ ë§í¬(ì›í•˜ë©´ ì‚¬ìš©) ============ **/
function navTo(addr,lat,lng){
  const appURL=`kakaomap://route?ep=${lat},${lng}&by=CAR`;
  const webURL=`https://map.kakao.com/link/to/${encodeURIComponent(addr)},${lat},${lng}`;
  location.href=appURL; setTimeout(()=>location.href=webURL, 1000);
}

/** ============ ì „ì—­ ë…¸ì¶œ ============ **/
window.closeCard   = closeCard;
window.closeDetail = closeDetail;
window.triggerPhoto = triggerPhoto;
window.completeDelivery = completeDelivery;
window.navTo = navTo;
</script>
</body>
</html>
