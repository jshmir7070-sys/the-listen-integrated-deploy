<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>ğŸšš The Listen - ì‹¤ì‹œê°„ ë°°ì†¡ ì§€ë„ (v3)</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      font-family: 'Noto Sans KR', sans-serif;
      background: #f4f7fb;
    }

    #map { width: 100%; height: 100%; position: relative; }

    /* ğŸ“± ê³ ê° ì¹´ë“œ íŒ¨ë„ */
    #customer-panel {
      position: absolute;
      bottom: -100%;
      left: 0;
      width: 100%;
      height: 45%;
      background: white;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.25);
      transition: bottom 0.4s ease;
      padding: 10px;
      overflow-y: auto;
      z-index: 100;
    }

    #customer-panel.active {
      bottom: 0;
    }

    .address-header {
      font-weight: 700;
      color: #007bff;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding-bottom: 6px;
      margin-bottom: 6px;
    }

    .customer-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      background: #fff;
      transition: 0.2s;
    }

    .customer-card:hover { background: #f0f8ff; }
    .customer-card.done { background: #e0f9e1; border-color: #28a745; }

    .customer-card strong { color: #007bff; }
    .photo-preview {
      margin-top: 6px; max-width: 100%; border-radius: 8px; display: none;
    }

    .close-btn {
      position: absolute;
      right: 12px; top: 8px;
      font-size: 20px; cursor: pointer;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- í•˜ë‹¨ ìŠ¬ë¼ì´ë“œ UI -->
  <div id="customer-panel">
    <div class="close-btn" onclick="hidePanel()">âœ•</div>
    <div id="panel-content"></div>
  </div>

  <!-- Kakao Map -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03"></script>
  <script>
    const deliveries = [
      { name: "ê¹€ì² ìˆ˜", phone: "010-1111-2222", apt: "í‘¸ë¥´ì§€ì˜¤", dong: "101ë™", detail: "302í˜¸", address: "ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 201", lat: 37.4979, lng: 127.0276 },
      { name: "ì´ì˜í¬", phone: "010-2222-3333", apt: "í‘¸ë¥´ì§€ì˜¤", dong: "101ë™", detail: "401í˜¸", address: "ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 201", lat: 37.4979, lng: 127.0276 },
      { name: "ë°•ë¯¼ìˆ˜", phone: "010-3333-4444", apt: "í‘¸ë¥´ì§€ì˜¤", dong: "102ë™", detail: "602í˜¸", address: "ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 201", lat: 37.4984, lng: 127.0268 },
      { name: "ì •í•˜ëŠ˜", phone: "010-4444-5555", apt: "ë˜ë¯¸ì•ˆ", dong: "201ë™", detail: "903í˜¸", address: "ì„œìš¸ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 326", lat: 37.5145, lng: 127.1059 },
      { name: "í™ê¸¸ë™", phone: "010-5555-6666", apt: "ë˜ë¯¸ì•ˆ", dong: "202ë™", detail: "304í˜¸", address: "ì„œìš¸ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 326", lat: 37.5150, lng: 127.1065 }
    ];

    const map = new kakao.maps.Map(document.getElementById("map"), {
      center: new kakao.maps.LatLng(37.4979, 127.0276),
      level: 6
    });

    // ğŸ¢ ë™ë³„ ê·¸ë£¹í•‘
    const grouped = {};
    deliveries.forEach(d => {
      const key = `${d.apt}-${d.dong}`;
      if (!grouped[key]) grouped[key] = [];
      grouped[key].push(d);
    });

    const markers = {};

    for (const key in grouped) {
      const group = grouped[key];
      const first = group[0];
      const pos = new kakao.maps.LatLng(first.lat, first.lng);
      const marker = new kakao.maps.Marker({
        map,
        position: pos,
        title: `${first.apt} ${first.dong}`
      });

      markers[key] = { marker, group };

      kakao.maps.event.addListener(marker, "click", () => showPanel(key));
    }

    function showPanel(groupKey) {
      const panel = document.getElementById("customer-panel");
      const content = document.getElementById("panel-content");
      const data = grouped[groupKey];
      if (!data || data.length === 0) return;

      let html = `
        <div class="address-header">
          ${data[0].apt} ${data[0].dong}
          <span id="remain-${groupKey}">ğŸ“¦ ì”ì—¬ ${data.length}ê±´</span>
        </div>
      `;

      data.forEach((cust, i) => {
        html += `
          <div class="customer-card" id="cust-${groupKey}-${i}">
            <strong>${cust.name}</strong> (${cust.detail})<br>
            <small>${cust.phone}</small><br>
            <button onclick="openCamera('${groupKey}', ${i})">ğŸ“¸ ë°°ì†¡ì™„ë£Œ</button>
            <input type="file" id="file-${groupKey}-${i}" accept="image/*" capture="camera" style="display:none">
            <img id="preview-${groupKey}-${i}" class="photo-preview">
          </div>
        `;
      });

      content.innerHTML = html;
      panel.classList.add("active"); // ì™„ì „íˆ ì˜¬ë¼ì˜¨ ìƒíƒœ ìœ ì§€
    }

    function hidePanel() {
      const panel = document.getElementById("customer-panel");
      panel.classList.remove("active");
    }

    function openCamera(groupKey, idx) {
      const input = document.getElementById(`file-${groupKey}-${idx}`);
      input.click();

      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          const preview = document.getElementById(`preview-${groupKey}-${idx}`);
          const card = document.getElementById(`cust-${groupKey}-${idx}`);
          preview.src = ev.target.result;
          preview.style.display = "block";
          card.classList.add("done");
          card.querySelector("button").disabled = true;

          // ê·¸ë£¹ ë‚´ ê³ ê° ì œê±°
          grouped[groupKey].splice(idx, 1);

          // ì”ì—¬ ìˆ˜ ì—…ë°ì´íŠ¸
          const remain = document.getElementById(`remain-${groupKey}`);
          remain.textContent = `ğŸ“¦ ì”ì—¬ ${grouped[groupKey].length}ê±´`;

          alert(`âœ… ${card.querySelector("strong").innerText} ë°°ì†¡ì™„ë£Œ!`);

          // ëª¨ë“  ê³ ê° ì™„ë£Œ ì‹œ í•€ ì‚­ì œ ë° ìŠ¬ë¼ì´ë“œ ë‹«ê¸°
          if (grouped[groupKey].length === 0) {
            markers[groupKey].marker.setMap(null);
            hidePanel();
          } else {
            // ì¼ë¶€ ë‚¨ì•„ ìˆìœ¼ë©´ ìë™ ë‹«ê¸°
            hidePanel();
          }
        };
        reader.readAsDataURL(file);
      };
    }
  </script>
</body>
</html>
