<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Listen - AI ë°°ì†¡ê²½ë¡œ (ë„¤ë¹„ ì—°ë™ í¬í•¨ ìµœì¢…)</title>
  <!-- ì¹´ì¹´ì˜¤ ì§€ë„ SDK (ì„œë¹„ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=301ef23f56e23f0dee3eaf47fe734b03&libraries=services"></script>
  <style>
    body { margin:0; font-family:"Noto Sans KR",sans-serif; background:#f5f7fa; }
    header { background:#007bff; color:#fff; text-align:center; padding:12px; font-weight:600; font-size:1.1rem; }
    #map { width:100%; height:90vh; }

    /* í•˜ë‹¨ ê³ ê° ì¹´ë“œ */
    #customerCard{
      position:fixed; left:0; bottom:0; width:100%;
      background:#fff; border-top-left-radius:16px; border-top-right-radius:16px;
      box-shadow:0 -6px 20px rgba(0,0,0,.25);
      transform:translateY(100%); transition:transform .35s ease;
      max-height:60vh; overflow-y:auto; z-index:9999;
    }
    #customerCard.active{ transform:translateY(0); }
    .card-header{ padding:12px 16px; font-weight:700; text-align:center; }
    .delivery-item{ padding:12px 18px; border-top:1px solid #f0f0f0; font-size:.95rem; }
    .delivery-item p{ margin:4px 0; }
    .btn-row{ display:flex; gap:8px; margin-top:10px; justify-content:center; flex-wrap:wrap; }
    .btn{
      border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600;
      background:#007bff; color:#fff;
    }
    .btn.gray{ background:#6c757d; }
    .btn.green{ background:#22c55e; }
    .tag{ display:inline-block; padding:2px 8px; border-radius:999px; background:#eef4ff; color:#3563ff; font-size:.8rem; margin-left:6px; }

    /* ë‚´ ìœ„ì¹˜ íŒŒë€ ì  */
    .my-location-dot{
      width:12px; height:12px; background:rgba(0,123,255,.95);
      border-radius:50%; border:2px solid #fff;
    }
  </style>
</head>
<body>
  <header>ğŸšš The Listen Â· AI ê²½ë¡œ Â· 200ê±´ Â· ì¹´ì¹´ì˜¤ë„¤ë¹„ ì—°ë™</header>
  <div id="map"></div>

  <!-- ê³ ê° ì¹´ë“œ -->
  <div id="customerCard">
    <div class="card-header">ê³ ê° ìƒì„¸ ì •ë³´</div>
    <div id="card-content"></div>
  </div>

  <script>
    /* =========================
       0) ê³µí†µ/ì „ì—­
    ==========================*/
    const map = new kakao.maps.Map(document.getElementById("map"), {
      center: new kakao.maps.LatLng(37.4979, 127.0276),
      level: 5
    });
    const geocoder = new kakao.maps.services.Geocoder();

    let myPosition = null;           // í˜„ì¬ ìœ„ì¹˜ kakao.maps.LatLng
    const markerById = {};           // { [waybillId]: CustomOverlay }
    let resolvedList = [];           // ì§€ì˜¤ì½”ë”© ì™„ë£Œëœ ë°°ì†¡ì§€ ë°°ì—´
    let markersDrawn = false;        // ì¤‘ë³µ ë“œë¡œì‰ ë°©ì§€

    /* =========================
       1) ë‚´ ìœ„ì¹˜ (ì‹¤ì‹œê°„)
    ==========================*/
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          myPosition = new kakao.maps.LatLng(lat, lng);

          if (!window.myCircle) {
            window.myCircle = new kakao.maps.CustomOverlay({
              position: myPosition,
              content: '<div class="my-location-dot"></div>',
              map
            });
          } else {
            window.myCircle.setPosition(myPosition);
          }

          // ì²« GPS í™•ë³´ í›„ í•œ ë²ˆë§Œ ë§ˆì»¤ ì •ë ¬ ê°±ì‹ 
          if (resolvedList.length > 0 && !markersDrawn) {
            drawMarkersSorted();
          }
        },
        (err) => console.warn("GPS ë¹„í™œì„±í™” ë˜ëŠ” ê¶Œí•œ ê±°ë¶€:", err),
        { enableHighAccuracy: true }
      );
    }

    /* =========================
       2) ì‹¤ì œ 'ìœ íš¨' ì„œìš¸ ì£¼ì†Œ 10ê°œ Ã— 20íšŒ = 200ê±´
          (ë§µ-ì£¼ì†Œ 100% ì¼ì¹˜, í…ŒìŠ¤íŠ¸ìš©)
    ==========================*/
    const baseAddrs = [
      "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 231",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 300",
      "ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ ì›”ë“œì»µë¶ë¡œ 400",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ë°˜í¬ëŒ€ë¡œ 222",
      "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬ ì²œí˜¸ëŒ€ë¡œ 1000",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬ ì—¬ì˜ë‚˜ë£¨ë¡œ 76",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë™êµ¬ ì™•ì‹­ë¦¬ë¡œ 115",
      "ì„œìš¸íŠ¹ë³„ì‹œ ë…¸ì›êµ¬ ë™ì¼ë¡œ 900",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ì¢…ë¡œ 33",
      "ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ì„¸ì¢…ëŒ€ë¡œ 110"
    ];

    const deliveries = Array.from({ length: 200 }).map((_, i) => ({
      id: `DLV${String(i+1).padStart(3,"0")}`,     // ìš´ì†¡ì¥
      name: `ê³ ê°${i+1}`,
      phone: `010-${(1000+i).toString().slice(-4)}-${(2000+i).toString().slice(-4)}`,
      address: baseAddrs[i % baseAddrs.length],
      boxes: (i % 3) + 1, // 1~3
      lat: null,
      lng: null
    }));

    /* =========================
       3) ê±°ë¦¬(Haversine)
    ==========================*/
    function distKm(lat1,lng1,lat2,lng2){
      const R=6371;
      const dLat=(lat2-lat1)*Math.PI/180;
      const dLng=(lng2-lng1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    /* =========================
       4) ì£¼ì†Œâ†’ì¢Œí‘œ(ë¹„ë™ê¸°) â†’ ëª¨ë‘ ëë‚˜ë©´ ì •ë ¬/ë“œë¡œìš°
    ==========================*/
    let geocodeDone = 0;
    deliveries.forEach(d => {
      geocoder.addressSearch(d.address, (res, status) => {
        geocodeDone++;
        if (status === kakao.maps.services.Status.OK && res && res[0]) {
          d.lat = Number(res[0].y);
          d.lng = Number(res[0].x);
          resolvedList.push(d);
        }
        // ì „ë¶€ ì²˜ë¦¬ë˜ë©´ ê·¸ë•Œ ì •ë ¬ ë° ë§ˆì»¤ í‘œì‹œ
        if (geocodeDone === deliveries.length) {
          drawMarkersSorted();
        }
      });
    });

    /* =========================
       5) GPS ê¸°ì¤€ ì •ë ¬ â†’ ìˆœë²ˆ ë§ˆì»¤ ìƒì„±
    ==========================*/
    function drawMarkersSorted(){
      if (markersDrawn) return;
      if (resolvedList.length === 0) return;

      const list = [...resolvedList];
      // GPS ì—†ìœ¼ë©´ ì›ë³¸ ìˆœì„œ, ìˆìœ¼ë©´ ê±°ë¦¬ ì •ë ¬
      if (myPosition) {
        const myLat = myPosition.getLat();
        const myLng = myPosition.getLng();
        list.sort((a,b) => distKm(myLat,myLng,a.lat,a.lng) - distKm(myLat,myLng,b.lat,b.lng));
      }

      list.forEach((d, idx) => placeMarker(d, idx+1));
      markersDrawn = true;
    }

    function placeMarker(d, order){
      const el = document.createElement("div");
      el.style.cssText = `
        background:#007bff; color:#fff; border-radius:50%;
        width:30px; height:30px; display:flex; align-items:center; justify-content:center;
        font-weight:700; font-size:13px; border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.3);
        cursor:pointer;
      `;
      el.textContent = order;

      const overlay = new kakao.maps.CustomOverlay({
        position: new kakao.maps.LatLng(d.lat, d.lng),
        content: el,
        map
      });
      markerById[d.id] = overlay;

      // ğŸ”µ ë§ˆì»¤ í´ë¦­ â†’ ê³ ê°ì¹´ë“œ ì—´ê¸°
      el.addEventListener("click", () => openCustomerCard(d, order));
    }

    /* =========================
       6) ê³ ê° ì¹´ë“œ (í™œì„±í™”, ë‹«ê¸°)
    ==========================*/
    function openCustomerCard(d, order){
      const card = document.getElementById("customerCard");
      const box = document.getElementById("card-content");
      box.innerHTML = `
        <div class="delivery-item" style="text-align:center;">
          <div style="font-size:1.05rem; font-weight:700;">${order}ï¸âƒ£ ìˆœë²ˆ <span class="tag">ë°•ìŠ¤ ${d.boxes}ê°œ</span></div>
          <p><b>ê³ ê°ëª…</b> : ${d.name}</p>
          <p><b>ì „í™”ë²ˆí˜¸</b> : ${d.phone}</p>
          <p><b>ìƒì„¸ì£¼ì†Œ</b> : ${d.address}</p>
          <p><b>ìš´ì†¡ì¥ë²ˆí˜¸</b> : ${d.id}</p>
          <div class="btn-row">
            <button class="btn green" onclick="startKakaoNavi(${d.lat},${d.lng}, '${encodeURIComponent(d.address)}')">ğŸš˜ ì¹´ì¹´ì˜¤ë„¤ë¹„ ì‹œì‘</button>
            <button class="btn" onclick="capturePhoto('${d.id}','${d.address}')">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜Â·ì „ì†¡</button>
            <button class="btn gray" onclick="closeCard()">ë‹«ê¸°</button>
          </div>
        </div>
      `;
      card.classList.add("active");
    }
    function closeCard(){ document.getElementById("customerCard").classList.remove("active"); }

    /* =========================
       7) ì‚¬ì§„ ì´¬ì˜/ì „ì†¡ â†’ ë§ˆì»¤ ë°˜íˆ¬ëª… ì²˜ë¦¬
    ==========================*/
    function capturePhoto(id, address){
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.capture = "environment"; // í›„ë©´ì¹´ë©”ë¼ ìš°ì„ 
      input.onchange = (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        alert(`ğŸ“¸ ì‚¬ì§„ ì „ì†¡ ì™„ë£Œ\nÂ· ì£¼ì†Œ: ${address}\nÂ· ìš´ì†¡ì¥: ${id}`);
        const mk = markerById[id];
        if (mk) { mk.getContent().style.opacity = "0.4"; } // ì™„ë£Œ í‘œì‹œ
        closeCard();
      };
      input.click();
    }

    /* =========================
       8) ì¹´ì¹´ì˜¤ë„¤ë¹„/ì§€ë„ ê¸¸ì•ˆë‚´ ì—°ë™ (ëª¨ë°”ì¼)
          - ì¹´ì¹´ì˜¤ë§µ ì•±ì´ ìˆìœ¼ë©´ ì•±ìœ¼ë¡œ,
            ì—†ìœ¼ë©´ ì›¹ì§€ë„ ê¸¸ì°¾ê¸° ì—´ë¦¬ë„ë¡ ë§í¬ ì‚¬ìš©
    ==========================*/
    function startKakaoNavi(lat, lng, encodedName){
      // 1) ì¹´ì¹´ì˜¤ë§µ ê¸¸ì°¾ê¸° ë§í¬ (ì•±/ì›¹ ìë™ ì—°ê²°)
      //    https://map.kakao.com/link/to/ì¥ì†Œëª…,ìœ„ë„,ê²½ë„
      const url = `https://map.kakao.com/link/to/${encodedName},${lat},${lng}`;
      window.location.href = url;
    }

    // ì „ì—­ ë°”ì¸ë”©
    window.capturePhoto = capturePhoto;
    window.closeCard = closeCard;
    window.startKakaoNavi = startKakaoNavi;
  </script>
</body>
</html>
