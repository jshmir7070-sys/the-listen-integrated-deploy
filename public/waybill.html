<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ìš´ì†¡ì¥ ìŠ¤ìº”/ì…ë ¥ - The Listen</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
  :root{--brand:#007bff;--bg:#f7f9fc;--card:#fff;--muted:#6b7280;--border:#e5e7eb}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
  .wrap{max-width:520px;margin:0 auto;padding:12px}
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
  .btn{border:none;border-radius:10px;padding:12px 14px;font-weight:800;color:#fff;background:var(--brand);cursor:pointer}
  .btn.full{width:100%} .btn.gray{background:#6b7280} .btn.green{background:#10b981} .btn.orange{background:#f59e0b}
  .stack{display:flex;gap:8px;flex-wrap:wrap}
  input[type="text"]{flex:1;padding:12px;border:1px solid var(--border);border-radius:10px}
  video{width:100%;border-radius:12px;background:#000}
  .list{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px}
  .item{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px}
  .muted{color:#6b7280}
  .row{display:flex;gap:8px}
  .col{flex:1}
  a.tel{color:#007bff;text-decoration:none}
</style>
</head>
<body>
<header>ğŸ“¦ ìš´ì†¡ì¥ ìŠ¤ìº”/ì…ë ¥</header>
<div class="wrap">

  <div class="card">
    <video id="preview" playsinline muted></video>
    <div class="stack" style="margin-top:8px">
      <button class="btn" id="btnStart">ğŸ“¸ í›„ë©´ì¹´ë©”ë¼</button>
      <input id="wbInput" type="text" inputmode="numeric" placeholder="ìš´ì†¡ì¥ ë²ˆí˜¸ ì…ë ¥" />
      <button class="btn green" id="btnAdd">ì¶”ê°€</button>
    </div>
    <div class="muted" style="margin-top:6px">â€» ìŠ¤ìº”/ìˆ˜ê¸° ì…ë ¥ ì‹œ ê³ ê° ë°ì´í„°ê°€ ìë™ ìƒì„±/ë³‘í•©ë©ë‹ˆë‹¤.</div>
  </div>

  <div class="card">
    <b>ìŠ¤í…Œì´ì§• ê³ ê°</b>
    <div id="list" class="list" style="margin-top:8px"></div>
    <div class="stack" style="margin-top:8px">
      <button class="btn gray full" onclick="location.href='depart.html'">â¬…ï¸ ì¶œë°œ ëŒ€ì‹œë³´ë“œë¡œ</button>
    </div>
  </div>
</div>

<script>
const STAGING_KEY = 'stagingDeliveries';
let customers = [];     // [{ name, phone, address, lat, lng, waybills:[code,...], order? }]

function load(){ try{ customers = JSON.parse(localStorage.getItem(STAGING_KEY)||'[]'); }catch{ customers=[]; } }
function save(){ localStorage.setItem(STAGING_KEY, JSON.stringify(customers)); }

function randomGeoNear(){
  const baseLat=37.3795, baseLng=126.806;
  return { lat: baseLat+(Math.random()-0.5)*0.008, lng: baseLng+(Math.random()-0.5)*0.008 };
}
function mockCustomerFor(code){
  const n = Math.floor(Math.random()*20)+101;  // 101~120ë™
  const h = 100 + Math.floor(Math.random()*50);
  const geo = randomGeoNear();
  // ê°€ì§œ í™”ë¬¼ ì •ë³´ (ìš´ì†¡ì¥ ìƒì„¸ìš©)
  const product = ["ë”¸ê¸°","ìš°ìœ ","ìƒëŸ¬ë“œ","ë‘ë¶€","ìš”ê±°íŠ¸"][Math.floor(Math.random()*5)];
  return {
    name: `ì¡°ë‚¨ê³ ê°${n}`,
    phone: `010-33${n}-${h}22`,
    address: `ê²½ê¸° ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${n}ë™ ${h}í˜¸`,
    lat: geo.lat, lng: geo.lng,
    waybills: [{
      code,
      productName: product,
      fragile: Math.random() < 0.3,
      shipper: "ë” ë¦¬ìŠ¨ ë¬¼ë¥˜ì„¼í„°",
      recipient: `ì¡°ë‚¨ê³ ê°${n}`,
      status: "ì§‘í•˜ì™„ë£Œ"
    }]
  };
}

function mergeByIdentity(base, added){
  // ê¸°ì¤€: ì´ë¦„+ì „í™”+ì£¼ì†Œ ë™ì¼
  const hit = customers.find(c => c.name===base.name && c.phone===base.phone && c.address===base.address);
  if(hit){
    const newWB = added.waybills[0];
    if(!hit.waybills.some(w=>w.code===newWB.code)) hit.waybills.push(newWB);
    // ì¢Œí‘œê°€ ì—†ìœ¼ë©´ ì±„ì›€
    if(!hit.lat) hit.lat = added.lat;
    if(!hit.lng) hit.lng = added.lng;
  }else{
    customers.push({...base});
  }
}

function render(){
  const box = document.getElementById('list');
  if(!customers.length){ box.innerHTML = '<div class="muted">ìŠ¤í…Œì´ì§• ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤. ìš´ì†¡ì¥ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.</div>'; return;}
  box.innerHTML = customers.map((c,i)=>`
    <div class="item">
      <div><b>${i+1}. ${c.name}</b></div>
      <div class="muted">${c.address}</div>
      <div>ğŸ“ <a class="tel" href="tel:${c.phone}">${c.phone}</a> Â· ğŸ“¦ ${c.waybills.length}ê°œ</div>
      <div class="muted">ìš´ì†¡ì¥: ${c.waybills.map(w=>w.code).join(', ')}</div>
    </div>
  `).join('');
}

function addWaybill(code){
  if(!code) return;
  const candidate = mockCustomerFor(code);   // ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„  ê²€ìƒ‰/ì…ë ¥ í¼ìœ¼ë¡œ ëŒ€ì²´
  mergeByIdentity(candidate, candidate);
  save(); render();
}

document.getElementById('btnAdd').onclick=()=>{
  const v = document.getElementById('wbInput').value.trim();
  if(v){ addWaybill(v); document.getElementById('wbInput').value=''; }
};
document.getElementById('wbInput').addEventListener('keydown',e=>{
  if(e.key==='Enter') document.getElementById('btnAdd').click();
});

const reader = new ZXing.BrowserMultiFormatReader();
document.getElementById('btnStart').onclick=()=>{
  const video = document.getElementById('preview');
  reader.decodeFromVideoDevice(null, video, (res,err)=>{
    if(res){ addWaybill(res.text); }
  });
};

load(); render();
</script>
</body>
</html>
