<!DOCTYPE html>
<html lang="ko">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ìš´ì†¡ì¥ ì…ë ¥ - The Listen</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
body{margin:0;background:#f7f9fc;font-family:"Noto Sans KR",sans-serif}
header{background:#007bff;color:#fff;text-align:center;padding:12px;font-weight:900}
.wrap{max-width:520px;margin:auto;padding:14px}
.input-group{display:flex;gap:8px;margin-bottom:8px}
input[type=number]{flex:1;padding:12px;font-size:18px;border:1px solid #e5e7eb;border-radius:10px}
.btn{padding:12px;border:none;border-radius:10px;background:#007bff;color:#fff;font-weight:700;cursor:pointer}
.icon{font-size:22px}
.list{border:1px solid #e5e7eb;border-radius:12px;max-height:60vh;overflow:auto;background:#fff;padding:8px}
.item{padding:8px;border-bottom:1px solid #e5e7eb}
</style></head>
<body>
<header>ğŸ“¦ ìš´ì†¡ì¥ ì…ë ¥</header>
<div class="wrap">
  <div class="input-group">
    <input id="num" type="number" inputmode="numeric" placeholder="ìš´ì†¡ì¥ ë²ˆí˜¸ ì…ë ¥">
    <button class="btn icon" id="cam">ğŸ“·</button>
  </div>
  <div class="input-group">
    <button class="btn" id="add" style="flex:1">ì¶”ê°€</button>
    <button class="btn" style="flex:1;background:#6b7280" onclick="location.href='depart.html'">ë’¤ë¡œê°€ê¸°</button>
  </div>
  <div class="list" id="list"></div>
</div>
<script>
const reader=new ZXing.BrowserMultiFormatReader();
let list=JSON.parse(localStorage.getItem("waybills")||"[]");
let details=JSON.parse(localStorage.getItem("waybillDetails")||"{}");
let customers=JSON.parse(localStorage.getItem("customers")||"[]");
function render(){listDiv.innerHTML=list.map((x,i)=>`<div class="item">${i+1}. ${x.code}</div>`).join('')||'<div class="item">ë“±ë¡ ì—†ìŒ</div>';}
const listDiv=document.getElementById("list");
document.getElementById("add").onclick=()=>{
  const v=num.value.trim(); if(!v) return;
  ding(); add(v,"manual"); num.value=""; render();
};
document.getElementById("cam").onclick=()=>{
  const ov=document.createElement('div');
  ov.style.cssText="position:fixed;inset:0;background:#000a;display:flex;justify-content:center;align-items:center;z-index:99";
  const v=document.createElement('video');v.setAttribute('playsinline','');v.style.cssText="width:90%;border-radius:12px";
  const b=document.createElement('button');b.textContent='ë‹«ê¸°';b.className='btn';b.style.cssText='position:fixed;bottom:20px';
  ov.append(v,b);document.body.appendChild(ov);
  reader.decodeFromVideoDevice(null,v,(res,err)=>{if(res){add(res.text,"camera");reader.reset();document.body.removeChild(ov);ding();render();}});
  b.onclick=()=>{reader.reset();document.body.removeChild(ov);};
};
function add(code,src){
  if(!details[code]){
    const i=Object.keys(details).length+1;
    details[code]={waybill:code,sender:{name:`ë°œì†¡${i}`},receiver:{name:`ê³ ê°${i}`,phone:`010-22${i}3-${4000+i}`,address:`ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${100+(i%4)}ë™ ${500+i}í˜¸`},product:{name:`ìƒí’ˆ${i}`},route:{hub:"ì‹œí¥HUB"},scannedAt:new Date().toISOString()};
  }
  localStorage.setItem("waybillDetails",JSON.stringify(details));
  list.push({code,time:new Date().toISOString(),src});localStorage.setItem("waybills",JSON.stringify(list));
  const r=details[code].receiver;
  const n={id:code,name:r.name,phone:r.phone,address:r.address,boxes:1,lat:37.379+(Math.random()-0.5)*0.01,lng:126.806+(Math.random()-0.5)*0.01};
  merge(n);
}
function merge(n){
  const s=(a,b)=>['name','phone','address'].reduce((c,k)=>c+(a[k]&&b[k]&&a[k]===b[k]?1:0),0);
  const i=customers.findIndex(c=>s(c,n)>=2);
  if(i>=0)customers[i].boxes+=n.boxes;else customers.push(n);
  localStorage.setItem("customers",JSON.stringify(customers));
}
function ding(){new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg").play();}
render();
</script>
</body></html>
