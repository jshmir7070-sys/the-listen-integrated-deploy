<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ìš´ì†¡ì¥ ì…ë ¥ - The Listen</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
  :root{--brand:#007bff;--bg:#f7f9fc;--card:#fff;--muted:#6b7280;--border:#e5e7eb;}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
  .wrap{max-width:520px;margin:auto;padding:14px}
  .input-group{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  input[type="number"]{flex:1;padding:12px;font-size:18px;border:1px solid var(--border);border-radius:10px}
  .btn{padding:12px 14px;border:none;border-radius:10px;background:#007bff;color:#fff;font-weight:700;cursor:pointer}
  .btn.gray{background:#6b7280}
  .icon-btn{background:#007bff;color:#fff;border:none;border-radius:10px;padding:12px 14px;font-size:18px;cursor:pointer}
  .list{margin-top:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;max-height:60vh;overflow:auto}
  .item{padding:10px 12px;border-bottom:1px solid var(--border)}
  .item:last-child{border-bottom:none}
</style>
</head>
<body>
<header>ğŸ“¦ ìš´ì†¡ì¥ ì…ë ¥ (The Listen)</header>
<div class="wrap">
  <div class="input-group">
    <input id="waybill" type="number" inputmode="numeric" placeholder="ìš´ì†¡ì¥ ë²ˆí˜¸ ì…ë ¥" />
    <button class="icon-btn" id="cameraBtn" title="í›„ë©´ ì¹´ë©”ë¼">ğŸ“·</button>
  </div>
  <div class="input-group">
    <button class="btn" id="addBtn" style="flex:1">ì¶”ê°€</button>
    <button class="btn gray" id="backBtn" style="flex:1">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
  </div>

  <div class="list" id="wbList"></div>
</div>

<script>
const reader=new ZXing.BrowserMultiFormatReader();
let list=JSON.parse(localStorage.getItem("waybills")||"[]");
let customers=JSON.parse(localStorage.getItem("customers")||"[]");
let details=JSON.parse(localStorage.getItem("waybillDetails")||"{}");

function render(){
  const wbList=document.getElementById("wbList");
  wbList.innerHTML=list.slice().reverse().map((x,i)=>`
    <div class="item">#${list.length-i} Â· ${x.code} <span style="color:#6b7280">(${new Date(x.time).toLocaleString()})</span></div>
  `).join('') || `<div class="item" style="color:#6b7280">ì•„ì§ ë“±ë¡ëœ ìš´ì†¡ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
}

document.getElementById("addBtn").onclick=()=>{
  const v=document.getElementById("waybill").value.trim();
  if(!v) return alert("ìš´ì†¡ì¥ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  ding();
  addWaybill(v,"waybill-page");
  document.getElementById("waybill").value="";
  render();
};
document.getElementById("backBtn").onclick=()=>location.href="depart.html";

// ì¹´ë©”ë¼ ì•„ì´ì½˜ â†’ í›„ë©´ ì¹´ë©”ë¼ ìŠ¤ìº” ì˜¤ë²„ë ˆì´(ê°„ë‹¨)
document.getElementById("cameraBtn").onclick=()=>{
  const overlay=document.createElement('div');
  overlay.style.cssText="position:fixed;inset:0;background:#000A;display:flex;align-items:center;justify-content:center;z-index:9999";
  const video=document.createElement('video'); video.setAttribute('playsinline',''); video.style.cssText="width:92%;max-width:520px;border-radius:12px;background:#000";
  const close=document.createElement('button'); close.textContent='ë‹«ê¸°'; close.className='btn'; close.style.cssText='position:fixed;bottom:20px';
  overlay.appendChild(video); overlay.appendChild(close); document.body.appendChild(overlay);
  reader.decodeFromVideoDevice(null,video,(res,err)=>{ if(res){ addWaybill(res.text,"waybill-camera"); ding(); reader.reset(); document.body.removeChild(overlay); render(); } });
  close.onclick=()=>{ reader.reset(); document.body.removeChild(overlay); };
};

function addWaybill(waybill, source){
  // ìƒì„¸ ìƒì„±(ìƒ˜í”Œ) + ìµœì†Œì •ë³´ ë³‘í•©
  if(!details[waybill]){
    const idx=Object.keys(details).length+1;
    details[waybill]={
      waybill,
      sender:{name:`ë°œì†¡ì¸${idx}`, phone:`02-1000-${String(1000+idx)}`},
      receiver:{name:`ë°›ëŠ”ë¶„${idx}`, phone:`010-9000-${String(1000+idx)}`, address:`ê²½ê¸° ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${100+(idx%8)}ë™ ${400+idx}í˜¸`},
      product:{name:`ìƒí’ˆ${idx}`},
      route:{hub:"ì‹œí¥HUB", path:["ì§‘í•˜","í—ˆë¸Œ","ë°°ì†¡"]},
      scannedAt:new Date().toISOString()
    };
  }
  localStorage.setItem("waybillDetails",JSON.stringify(details));
  list.push({code:waybill, time:new Date().toISOString(), source});
  localStorage.setItem("waybills",JSON.stringify(list));

  const r=details[waybill].receiver;
  const minimal={id:waybill,name:r.name,phone:r.phone,address:r.address,boxes:1,lat:37.379+(Math.random()-0.5)*0.01,lng:126.806+(Math.random()-0.5)*0.01,order:null};
  mergeCustomer(minimal);
}

function mergeCustomer(newC){
  // departì™€ ë™ì¼: 2ê°œ ì´ìƒ ì¼ì¹˜
  const score=(a,b)=>['name','phone','address'].reduce((s,k)=>s + (a[k]&&b[k]&&a[k]===b[k]?1:0),0);
  const idx=customers.findIndex(c=>score(c,newC)>=2);
  if(idx>=0){ customers[idx].boxes += newC.boxes; }
  else{ customers.push(newC); }
  localStorage.setItem("customers",JSON.stringify(customers));
}

function ding(){ const a=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"); a.play(); }

render();
</script>
</body>
</html>
