<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - The Listen</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
  :root{--brand:#007bff;--bg:#f7f9fc;--card:#fff;--muted:#6b7280;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
  .wrap{max-width:480px;margin:0 auto;padding:12px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border:none;border-radius:10px;padding:12px 14px;
       font-weight:800;color:#fff;background:var(--brand);cursor:pointer}
  .btn.full{width:100%}.btn.gray{background:#6b7280}.btn.green{background:#10b981}.btn.orange{background:#f59e0b}
  .stack{display:flex;gap:8px;flex-wrap:wrap}
  input[type="text"]{flex:1;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px}
  video{width:100%;border-radius:12px;background:#000}
  .muted{color:var(--muted);font-size:.9rem;margin:6px 0}
  .list{max-height:180px;overflow:auto;border:1px solid #eef2f7;border-radius:10px;padding:8px}
  .cards{max-height:420px;overflow:auto;border:1px solid #eef2f7;border-radius:12px;padding:8px}
  .citem{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-bottom:8px}
  .crow{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .order{min-width:36px;height:36px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;
         justify-content:center;font-weight:900}
  .addr{font-size:.95rem}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ (The Listen ìš´ì†¡ì¥ ë¶„ë¦¬í˜•)</header>
<div class="wrap">

  <!-- ìŠ¤ìº” / ìˆ˜ê¸° ì…ë ¥ -->
  <div class="card">
    <video id="preview" playsinline muted></video>
    <div class="stack">
      <button class="btn" id="btnStart">ğŸ“¸ í›„ë©´ì¹´ë©”ë¼</button>
      <input id="scanInput" type="text" placeholder="ìš´ì†¡ì¥ ì…ë ¥ ë˜ëŠ” ìŠ¤ìºë„ˆ ì…ë ¥" />
      <button class="btn green" id="btnAdd">ì¶”ê°€</button>
    </div>
    <div class="muted">í›„ë©´ ì¹´ë©”ë¼ ìŠ¤ìº” + HID(ë¸”ë£¨íˆ¬ìŠ¤/ìœ ì„ ) ì…ë ¥ ì§€ì›</div>
  </div>

  <!-- ê³ ê° ì¹´ë“œ ëª©ë¡ -->
  <div class="card">
    <div class="stack" style="margin-bottom:8px;">
      <button class="btn orange full" id="btnOptimize">ğŸ§­ ê²½ë¡œ ìµœì í™”</button>
      <button class="btn full" id="btnDispatch">ğŸš€ ì¶œë°œ ì „ì†¡ â†’ ì§€ë„</button>
    </div>
    <div class="cards" id="cards"></div>
  </div>
</div>

<script>
/* ====== ê¸°ë³¸ ë³€ìˆ˜ ====== */
const reader=new ZXing.BrowserMultiFormatReader();
const video=document.getElementById("preview");
let customers=[];

/* ====== ì„ì‹œ í…ŒìŠ¤íŠ¸ìš© ëœë¤ ê³ ê° (ì£¼ì†Œ ê¸°ë°˜) ====== */
function randomCustomer(code){
  const baseLat=37.3795+(Math.random()-0.5)*0.01;
  const baseLng=126.806+(Math.random()-0.5)*0.01;
  const dong=100+Math.floor(Math.random()*20);
  const ho=100+Math.floor(Math.random()*50);
  return {
    id:`${code}`,
    name:`ì¡°ë‚¨ê³ ê°${dong}`,
    phone:`010-33${dong}-${ho}22`,
    address:`ê²½ê¸°ë„ ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${dong}ë™ ${ho}í˜¸`,
    lat:baseLat,lng:baseLng,
    waybills:[code]
  };
}

/* ====== ìŠ¤ìº” / ì…ë ¥ ====== */
document.getElementById('btnStart').onclick=()=>{
  reader.decodeFromVideoDevice(null,video,(res,err)=>{
    if(res){ addWaybill(res.text); }
  });
};
document.getElementById('btnAdd').onclick=()=>{
  const v=document.getElementById('scanInput').value.trim();
  if(v){ addWaybill(v); document.getElementById('scanInput').value=''; }
};
document.getElementById('scanInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'){document.getElementById('btnAdd').click();}
});

/* ====== ìš´ì†¡ì¥ ì¶”ê°€ ë° ë³‘í•© ====== */
function addWaybill(code){
  // ìƒˆ ê³ ê° ìƒì„±
  const c=randomCustomer(code);

  // ë™ì¼ ê³ ê°(ì£¼ì†Œ/ì „í™”/ì´ë¦„ ë§¤ì¹­) ì¡´ì¬ í™•ì¸
  const exist=customers.find(x=>x.phone===c.phone && x.address===c.address && x.name===c.name);
  if(exist){
    if(!exist.waybills.includes(code)) exist.waybills.push(code);
  }else{
    customers.push(c);
  }
  renderCards();
}

/* ====== ì¹´ë“œ ë Œë”ë§ ====== */
function renderCards(){
  const cards=document.getElementById('cards');
  cards.innerHTML=customers.map((c,i)=>`
    <div class="citem">
      <div class="crow">
        <div class="order">${i+1}</div>
        <div style="flex:1">
          <div><b>${c.name}</b> Â· <span class="addr">${c.address}</span></div>
          <div>ğŸ“ <a href="tel:${c.phone}" style="color:#007bff;text-decoration:none;">${c.phone}</a></div>
          <div>ğŸ“¦ ë°•ìŠ¤ ${c.waybills.length}ê°œ</div>
          <div class="muted">ìš´ì†¡ì¥: ${c.waybills.join(', ')}</div>
        </div>
      </div>
    </div>
  `).join('');
}

/* ====== GPS ê¸°ë°˜ ê²½ë¡œ ìµœì í™” ====== */
function optimize(){
  if(!navigator.geolocation) return alert('GPS ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    const dist=(a,b)=>Math.hypot(a.lat-latitude,a.lng-longitude);
    customers.sort((a,b)=>dist(a,b)-dist(b,a));
    alert('ğŸ§­ GPS ê¸°ì¤€ìœ¼ë¡œ ìˆœì„œê°€ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    renderCards();
  });
}

/* ====== ì¶œë°œ ì „ì†¡ (ì§€ë„ ì—°ë™) ====== */
function dispatch(){
  localStorage.setItem('deliveriesJSON',JSON.stringify(customers));
  localStorage.setItem('startDispatch','1');
  localStorage.setItem('optimizeByGPS','1');
  alert('ğŸš€ ì¶œë°œ ì „ì†¡ ì™„ë£Œ! map.htmlë¡œ ì´ë™í•©ë‹ˆë‹¤.');
  location.href='map.html';
}

/* ====== ì´ë²¤íŠ¸ ì—°ê²° ====== */
document.getElementById('btnOptimize').onclick=optimize;
document.getElementById('btnDispatch').onclick=dispatch;
</script>
</body>
</html>
