<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - The Listen</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
  :root{--brand:#007bff;--bg:#f7f9fc;--card:#fff;--muted:#6b7280;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
  .wrap{max-width:520px;margin:0 auto;padding:12px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border:none;border-radius:10px;padding:12px 14px;font-weight:800;color:#fff;background:var(--brand);cursor:pointer}
  .btn.full{width:100%}
  .btn.gray{background:#6b7280}
  .btn.green{background:#10b981}
  .btn.orange{background:#f59e0b}
  .stack{display:flex;gap:8px}
  .stack.col{flex-direction:column}
  input[type="text"],input[type="number"]{flex:1;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px}
  video{width:100%;border-radius:12px;background:#000}
  .kpi{display:flex;justify-content:space-between;margin:8px 0 2px;font-weight:900}
  .muted{color:var(--muted);font-size:.9rem;margin:6px 0}
  .pill{display:inline-block;background:#eef4ff;color:#3563ff;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:14px}
  .list{max-height:180px;overflow:auto;border:1px solid #eef2f7;border-radius:10px;padding:8px}
  .cards{max-height:480px;overflow:auto;border:1px solid #eef2f7;border-radius:12px;padding:8px}
  .citem{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-bottom:8px}
  .crow{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .order{min-width:36px;height:36px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900}
  .addr{font-size:.95rem}
  .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .tag{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;font-size:12px}
  .danger{color:#ef4444}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ (The Listen)</header>
<div class="wrap">

  <!-- ìŠ¤ìº”/ìˆ˜ê¸° ì…ë ¥ -->
  <div class="card">
    <div class="stack col">
      <video id="preview" playsinline muted></video>
      <div class="stack">
        <button class="btn" id="btnStart">ğŸ“¸ í›„ë©´ì¹´ë©”ë¼</button>
        <input id="scanInput" type="text" inputmode="numeric" placeholder="ìš´ì†¡ì¥ ë²ˆí˜¸ ìˆ˜ê¸° ì…ë ¥ ë˜ëŠ” ìŠ¤ìºë„ˆ Enter" />
        <button class="btn green" id="btnAdd">ì¶”ê°€</button>
      </div>
      <div class="muted">1ë°•ìŠ¤=1ìš´ì†¡ì¥. ê°™ì€ <b>ì´ë¦„/ì „í™”/ìƒì„¸ì£¼ì†Œ</b>ëŠ” <b>í•œ ê³ ê°ì¹´ë“œ</b>ë¡œ ë¬¶ì´ê³ , ìš´ì†¡ì¥ì€ ë°°ì—´ë¡œ í•©ì³ì§‘ë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ìŠ¤ìº” ëª©ë¡ -->
  <div class="card">
    <div class="kpi"><span>ìŠ¤ìº” ìˆ˜ëŸ‰</span><span id="scanCount">0</span></div>
    <div class="list" id="scanList" aria-label="ìŠ¤ìº” ëª©ë¡"></div>
  </div>

  <!-- ê³ ê°ì¹´ë“œ (ë¬¶ìŒ) -->
  <div class="card">
    <div class="kpi"><span>ê³ ê° ì¹´ë“œ</span><span id="custCount">0</span></div>
    <div class="stack" style="gap:6px;margin-bottom:8px;">
      <button class="btn orange full" id="btnOptimize">ğŸ§­ ìµœì  ê²½ë¡œ(ìˆœë²ˆ ë¶€ì—¬)</button>
      <button class="btn full" id="btnDispatch">ğŸš€ ì¶œë°œ ì „ì†¡ â†’ ì§€ë„</button>
      <button class="btn gray full" id="btnClear">ğŸ§¹ ì´ˆê¸°í™”(í…ŒìŠ¤íŠ¸ìš©)</button>
    </div>
    <div class="cards" id="cards"></div>
    <div class="muted">Â· ë°•ìŠ¤ìˆ˜ëŸ‰=ìš´ì†¡ì¥ ë°°ì—´ ê¸¸ì´. Â· ê³ ê°€í’ˆì€ <span class="danger">ë¶‰ì€ í‘œì‹œ</span>ë¡œ ê°•ì¡°(ìƒ˜í”Œ ê·œì¹™).</div>
  </div>

</div>

<script>
/** ìƒíƒœ **/
const reader = new ZXing.BrowserMultiFormatReader();
const video  = document.getElementById("preview");
const scanListDiv = document.getElementById("scanList");
const cardsDiv    = document.getElementById("cards");
let scanList = JSON.parse(localStorage.getItem("scanList")||"[]");

/** ê³ ê° ê°ì²´ ìŠ¤í‚¤ë§ˆ (í•©ì³ì§„ í˜•íƒœ)
 * {
 *   id: 'CUST-í•´ì‹œ', name, phone, address, lat, lng,
 *   waybills: [ 'WB-1', 'WB-2', ... ],
 *   products: { 'WB-1': {sender:'', item:'', highValue:false}, ...},
 *   order: null|number
 * }
 */
let customers = JSON.parse(localStorage.getItem("dep_customers")||"[]");

/** ìŠ¤ìº” UI **/
function renderScan(){
  scanListDiv.innerHTML = scanList.map(s=>`<span class="pill">${s}</span>`).join('') || '<div class="muted">ìŠ¤ìº” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  document.getElementById('scanCount').textContent = scanList.length;
  localStorage.setItem("scanList", JSON.stringify(scanList));
}
document.getElementById('btnStart').onclick = ()=>{
  reader.decodeFromVideoDevice(null, video, (res,err)=>{ if(res){ onScan(res.text); }});
};
document.getElementById('btnAdd').onclick = ()=>{
  const v = scanInput.value.trim(); if(!v) return;
  onScan(v); scanInput.value='';
};
scanInput.addEventListener('keydown',e=>{ if(e.key==='Enter'){ document.getElementById('btnAdd').click(); }});

/** ê³ ê° 50ëª… ìƒ˜í”Œ ì‹œë“œ (ì²˜ìŒ ë¹„ì–´ìˆì„ ë•Œë§Œ) **/
function seedIfEmpty(){
  if(customers.length) return;
  const baseLat=37.3795, baseLng=126.8060;
  for(let i=1;i<=10;i++){
    const lat = baseLat+(Math.random()-0.5)*0.01;
    const lng = baseLng+(Math.random()-0.5)*0.01;
    const name = `ì¡°ë‚¨ê³ ê°${i}`;
    const phone = `010-${String(1000+i).padStart(4,'0')}-${String(2000+i).padStart(4,'0')}`;
    const dong = 100 + (i%10);
    const ho   = 100 + i;
    const address = `ê²½ê¸°ë„ ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${dong}ë™ ${ho}í˜¸`;
    const wb = `WB-${dong}-${ho}`;
    customers.push({
      id: `CUST-${dong}-${ho}`,
      name, phone, address, lat, lng,
      waybills: [wb],
      products: { [wb]: { sender:'í…ŒìŠ¤íŠ¸í™”ì£¼', item:`ìƒí’ˆ${i}`, highValue: (i%7===0) }},
      order: null
    });
  }
}

/** ë™ì¼ ê³ ê°(ì´ë¦„/ì „í™”/ì£¼ì†Œ) ë§¤ì¹­ í›„ ë³‘í•© **/
function upsertCustomerByKey({waybill, name, phone, address, lat, lng, product}){
  const key = `${name}__${phone}__${address}`;
  let hit = customers.find(c=>`${c.name}__${c.phone}__${c.address}`===key);
  if(!hit){
    hit = {
      id: `CUST-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,
      name, phone, address, lat, lng,
      waybills: [],
      products: {},
      order: null
    };
    customers.push(hit);
  }
  if(!hit.waybills.includes(waybill)){
    hit.waybills.push(waybill);
    hit.products[waybill] = product || {sender:'ë¯¸ìƒ', item:'ì¼ë°˜ìƒí’ˆ', highValue:false};
  }
}

/** ìŠ¤ìº” ì²˜ë¦¬ â†’ ê³ ê°ì¹´ë“œ í™œì„±í™”(ë¬¶ìŒ) **/
function onScan(code){
  scanList.unshift(code);
  renderScan();

  // ì‹¤ì œì—ì„  ìš´ì†¡ì¥ìœ¼ë¡œ ê³ ê°/ìƒí’ˆì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤. (ì—¬ê¸°ì„  ë°ëª¨ë¡œ ëœë¤ ìƒì„±)
  const mock = makeMockByWaybill(code);
  upsertCustomerByKey(mock);

  renderCards(mock.customerId); // ê°•ì¡° ìŠ¤í¬ë¡¤ìš© IDê°€ ìˆë‹¤ë©´ ì‚¬ìš©
  localStorage.setItem("dep_customers", JSON.stringify(customers));
}

/** ìš´ì†¡ì¥ â†’ ë°ëª¨ ê³ ê°/ìƒí’ˆ ìƒì„±ê¸° (ì‹¤ì„œë¹„ìŠ¤ì—ì„  API ì—°ë™) **/
function makeMockByWaybill(wb){
  const baseLat=37.3795, baseLng=126.8060;
  const lat = baseLat+(Math.random()-0.5)*0.01;
  const lng = baseLng+(Math.random()-0.5)*0.01;
  const name = `ì¡°ë‚¨ê³ ê°${Math.floor(Math.random()*8)+1}`;
  const phone = `010-${Math.floor(1000+Math.random()*9000)}-${Math.floor(1000+Math.random()*9000)}`;
  const dong = 100 + Math.floor(Math.random()*20);
  const ho   = 100 + Math.floor(Math.random()*500);
  const address = `ê²½ê¸°ë„ ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${dong}ë™ ${ho}í˜¸`;
  const product = { sender:'ìƒ˜í”Œí™”ì£¼', item:`ìƒ˜í”Œìƒí’ˆ-${wb.slice(-3)}`, highValue: (wb.length%5===0) };
  return { waybill: wb, name, phone, address, lat, lng, product, customerId:`CUST-${dong}-${ho}` };
}

/** ê³ ê° ì¹´ë“œ ë Œë” (ë¬¶ìŒ) **/
function renderCards(focusId=null){
  document.getElementById('custCount').textContent = customers.length;
  cardsDiv.innerHTML = customers.map(c=>{
    const count = c.waybills.length;
    const hv = Object.values(c.products).some(p=>p?.highValue);
    return `
      <div class="citem" id="row-${c.id}">
        <div class="crow">
          <div class="order">${c.order??'-'}</div>
          <div style="flex:1">
            <div><b>${c.name}</b> Â· ${c.phone}</div>
            <div class="addr">${c.address}</div>
            <div class="tags">
              <span class="tag">ë°•ìŠ¤ ${count}ê°œ</span>
              ${hv?'<span class="tag danger">ê³ ê°€í’ˆ í¬í•¨</span>':''}
              <span class="tag">ìš´ì†¡ì¥: ${c.waybills.slice(-3).join(', ')}${c.waybills.length>3?' ì™¸':''}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  if(focusId){
    const el=document.getElementById(`row-${focusId}`);
    if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
  }
}

/** ìµœì ê²½ë¡œ(ìˆœë²ˆ) â€” í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ ê·¼ì ‘ì •ë ¬ **/
function optimize(){
  if(!navigator.geolocation) return alert('GPS ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
  navigator.geolocation.getCurrentPosition(pos=>{
    const [a,b]=[pos.coords.latitude,pos.coords.longitude];
    const dist=(x1,y1)=>Math.hypot(x1-a,y1-b);
    customers.sort((x,y)=>dist(x.lat,x.lng)-dist(y.lat,y.lng));
    customers.forEach((c,i)=>c.order=i+1);
    localStorage.setItem('dep_customers', JSON.stringify(customers));
    alert('ğŸ§­ GPS ê¸°ì¤€ìœ¼ë¡œ ë°°ì†¡ ìˆœì„œ(1~N)ê°€ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    renderCards();
  },()=>alert('GPS ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
}

/** ì¶œë°œ ì „ì†¡ â†’ map.html
 *  ì „ë‹¬ ìŠ¤í‚¤ë§ˆ: deliveriesJSON = [{ id,name,phone,address,lat,lng, order, boxes, waybills, products }]
 *  boxes = waybills.length
 */
function dispatchToMap(){
  const payload = customers.map(c=>({
    id: c.id, name: c.name, phone: c.phone, address: c.address,
    lat: c.lat, lng: c.lng, order: c.order||0,
    boxes: c.waybills.length,
    waybills: c.waybills,
    products: c.products
  }));
  localStorage.setItem('deliveriesJSON', JSON.stringify(payload));
  localStorage.setItem('startDispatch','1');
  localStorage.setItem('totalDeliveries', String(payload.length));
  alert('ğŸš€ ì¶œë°œ ì „ì†¡ ì™„ë£Œ â†’ ì§€ë„ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
  location.href='map.html';
}

/** ì´ˆê¸°í™”(í…ŒìŠ¤íŠ¸ìš©) **/
function clearAll(){
  if(!confirm('ë¡œì»¬ ìŠ¤ìº”/ê³ ê° ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
  scanList=[]; customers=[];
  localStorage.removeItem('scanList');
  localStorage.removeItem('dep_customers');
  renderScan(); renderCards();
}

/** ì´ë²¤íŠ¸ & ì´ˆê¸° ë¶€íŠ¸ **/
document.getElementById('btnOptimize').onclick = optimize;
document.getElementById('btnDispatch').onclick = dispatchToMap;
document.getElementById('btnClear').onclick    = clearAll;

(function init(){
  renderScan();
  if(!customers.length) seedIfEmpty();
  renderCards();
})();
</script>
</body>
</html>
