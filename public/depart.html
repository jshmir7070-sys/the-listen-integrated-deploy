<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - The Listen</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
  :root{--brand:#007bff;--bg:#f7f9fc;--card:#fff;--muted:#6b7280;--border:#e5e7eb;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
  .wrap{max-width:520px;margin:0 auto;padding:12px}
  .topbar{display:flex;gap:8px;margin-bottom:12px}
  .btn{flex:1;text-align:center;padding:12px 0;font-weight:800;border:none;border-radius:10px;color:#fff;cursor:pointer}
  .btn.orange{background:#f59e0b}.btn.green{background:#10b981}.btn.blue{background:#007bff}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
  .kpi{display:flex;justify-content:space-between;font-weight:900;margin-bottom:6px}
  .cards{max-height:64vh;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px}
  .citem{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px}
  .crow{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .order{min-width:36px;height:36px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900}
  .muted{color:var(--muted);font-size:.9rem}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ (The Listen)</header>

<div class="wrap">
  <!-- ìƒë‹¨ ëŒ€ì¹­ 3ë²„íŠ¼ -->
  <div class="topbar">
    <button class="btn orange" id="btnScan">ğŸ“¦ ìš´ì†¡ì¥ ìŠ¤ìº”</button>
    <button class="btn green"  id="btnOptimize">ğŸ§­ ìµœì  ê²½ë¡œ</button>
    <button class="btn blue"   id="btnDispatch">ğŸš€ ì¶œë°œ ì „ì†¡</button>
  </div>

  <!-- ê³ ê° ì¹´ë“œ -->
  <div class="card">
    <div class="kpi"><span>ì´ ê³ ê°</span><span id="custCount">0</span></div>
    <div class="cards" id="cards"></div>
    <div class="muted">â€» ë™ì¼ ê³ ê°(ì´ë¦„Â·ì „í™”Â·ì£¼ì†Œ ì¤‘ 2ê°œ ì´ìƒ ì¼ì¹˜)ì€ ìë™ ë³‘í•©ë˜ë©°, ë°•ìŠ¤ ìˆ˜ëŸ‰ë§Œ í•©ì‚°/í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>
</div>

<script>
/* ================= ìƒíƒœ ================= */
const cardsDiv = document.getElementById("cards");
let customers = JSON.parse(localStorage.getItem("customers")||"[]");       // ì‘ì—… ì¤‘ ê³ ê°(ìµœì†Œí•„ë“œ)
let waybillDetails = JSON.parse(localStorage.getItem("waybillDetails")||"{}"); // ìš´ì†¡ì¥ ìƒì„¸ ë”•ì…”ë„ˆë¦¬ {waybill:{...}}
let scanEvents = JSON.parse(localStorage.getItem("scanEvents")||"[]");     // í™”ë¬¼ì¶”ì ìš© ìŠ¤ìº” ë¡œê·¸
let buffered = ""; // HID ìŠ¤ìºë„ˆ ë²„í¼

/* ================= ë Œë” ================= */
function render(){
  document.getElementById('custCount').textContent = customers.length;
  cardsDiv.innerHTML = customers.map(c=>`
    <div class="citem">
      <div class="crow">
        <div class="order">${c.order??'-'}</div>
        <div style="flex:1">
          <div><b>${c.name}</b></div>
          <div>${c.address}</div>
          <div class="muted">ğŸ“¦ ${c.boxes}ë°•ìŠ¤</div>
        </div>
      </div>
    </div>
  `).join('');
}

/* ================= ìŠ¤ìºë„ˆ/ì…ë ¥ ================= */
// waybill ì…ë ¥ ì „ìš© í˜ì´ì§€ë¡œ ì´ë™(ìˆ«ì í‚¤íŒ¨ë“œ + ì¹´ë©”ë¼ ì•„ì´ì½˜)
document.getElementById("btnScan").onclick = ()=> location.href="waybill.html";

// HID ìŠ¤ìºë„ˆ(ì—”í„°ë¡œ ì¢…ë£Œ)
window.addEventListener("keydown",(e)=>{
  if(e.key === "Enter"){
    const code = buffered.trim();
    if(code){
      handleWaybill(code,"depart-hid");
    }
    buffered = "";
  }else{
    // ì¼ë°˜ íƒ€ì´í•‘ê³¼ êµ¬ë¶„ì€ ì–´ë µì§€ë§Œ, ì‹¤ì œ ìŠ¤ìºë„ˆëŠ” ë§¤ìš° ë¹ ë¥´ê²Œ ì…ë ¥í•˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë²„í¼ë§
    buffered += e.key;
  }
});

/* ================= ìš´ì†¡ì¥ ì²˜ë¦¬ ================= */
// ìš´ì†¡ì¥ â†’ ìƒì„¸ ìƒì„±(ì‹œë®¬ë ˆì´ì…˜) + ê³ ê° ë³‘í•© + ë¡œê·¸ ê¸°ë¡
function handleWaybill(waybill, source){
  playDing();
  // (ì˜ˆì‹œ) ìš´ì†¡ì¥ ìƒì„¸ ìƒ˜í”Œ ìƒì„±. ì‹¤ì œì—ì„  ì„œë²„/DBì—ì„œ ë°›ì€ DTOë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ë©´ ë¨.
  if(!waybillDetails[waybill]){
    const i = Object.keys(waybillDetails).length + 1;
    waybillDetails[waybill] = {
      waybill,
      sender:{name:`ë°œì†¡ì¸${i}`, phone:`02-1234-${String(1000+i)}`},
      receiver:{name:`ë°›ëŠ”ë¶„${i}`, phone:`010-5555-${String(1000+i)}`, address:`ê²½ê¸° ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${100+(i%7)}ë™ ${300+i}í˜¸`},
      product:{name:`ìƒí’ˆ${i}`, fragile: (i%5===0)},
      route:{hub:"ì‹œí¥HUB", path:["ì§‘í•˜","í—ˆë¸Œ","ë°°ì†¡"]},
      scannedAt:new Date().toISOString()
    };
  }
  // í™”ë¬¼ì¶”ì  ë¡œê·¸
  scanEvents.push({code:waybill, time:new Date().toISOString(), source});
  localStorage.setItem("scanEvents", JSON.stringify(scanEvents));
  localStorage.setItem("waybillDetails", JSON.stringify(waybillDetails));

  // ê³ ê°(ìµœì†Œì •ë³´) ë³‘í•©
  const d = waybillDetails[waybill].receiver;
  const minimal = {
    id: waybill,
    name: d.name,
    phone: d.phone,
    address: d.address,
    boxes: 1,
    lat: 37.3795 + (Math.random()-0.5)*0.01, // ìƒ˜í”Œ ì¢Œí‘œ
    lng: 126.8060 + (Math.random()-0.5)*0.01,
    order: null
  };
  mergeCustomer(minimal);
  render();
}

/* ì´ë¦„/ì „í™”/ì£¼ì†Œ ì¼ì¹˜ 2ê°œ ì´ìƒì´ë©´ ë™ì¼ ê³ ê°ìœ¼ë¡œ ë³‘í•© */
function matchScore(a,b){
  let s=0;
  if(a.name && b.name && a.name===b.name) s++;
  if(a.phone&& b.phone&&a.phone===b.phone) s++;
  if(a.address&&b.address&&a.address===b.address) s++;
  return s;
}
function mergeCustomer(newC){
  let idx = customers.findIndex(c => matchScore(c,newC)>=2);
  if(idx>=0){
    customers[idx].boxes += newC.boxes;
    // ìš´ì†¡ì¥ ì‹ë³„ì ì—°ê²°ì„ ìœ„í•´ id ëª©ë¡í™”ë¥¼ ì›í•˜ë©´ ì•„ë˜ì²˜ëŸ¼ í™•ì¥ ê°€ëŠ¥:
    // customers[idx].waybills = [...new Set([...(customers[idx].waybills||[]), newC.id])]
  }else{
    customers.push(newC);
  }
  localStorage.setItem("customers", JSON.stringify(customers));
}

/* ================= ìµœì  ê²½ë¡œ ================= */
function optimize(){
  if(!navigator.geolocation) return alert("GPS ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
  navigator.geolocation.getCurrentPosition(pos=>{
    const [a,b]=[pos.coords.latitude,pos.coords.longitude];
    const dist=(x1,y1)=>Math.hypot(x1-a,y1-b);
    customers.sort((x,y)=>dist(x.lat,x.lng)-dist(y.lat,ylng));
  },err=>{}, {enableHighAccuracy:true});

  // ìœ„ì¹˜ë¯¸í—ˆìš©/í…ŒìŠ¤íŠ¸ ëŒ€ë¹„: ë°•ìŠ¤ ë§ì€ ìˆœ â†’ ì´ë¦„ìˆœ ë“± ì„ì‹œ ê·œì¹™
  if(!customers.length) return;
  customers.forEach((c,i)=>c.order=i+1);
  localStorage.setItem("customers", JSON.stringify(customers));
  alert("ğŸ§­ ìµœì  ê²½ë¡œ ì •ë ¬ ì™„ë£Œ");
  render();
}

/* ================= ì¶œë°œ ì „ì†¡ ================= */
function dispatch(){
  if(!customers.length) return alert("ì „ì†¡í•  ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.");
  // ìµœì†Œì •ë³´ payload
  const payload = customers.map(c=>({
    id: c.id,           // (ë³‘í•© ìš´ì†¡ì¥ ëŒ€í‘œê°’)
    name: c.name,
    phone: c.phone,
    address: c.address,
    boxes: c.boxes,
    lat: c.lat, lng: c.lng,
    order: c.order
  }));
  localStorage.setItem("deliveriesJSON", JSON.stringify(payload));
  localStorage.setItem("startDispatch","1");

  // depart ì‘ì—… ê³µê°„ ì •ë¦¬: ì „ì†¡ëœ ê³ ê° ì‚­ì œ, ìŠ¤ìº” ë¡œê·¸ ìœ ì§€
  localStorage.removeItem("customers");
  alert("ğŸš€ ì¶œë°œ ë°ì´í„°ê°€ map.htmlë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
  location.href="map.html";
}

/* ================= íš¨ê³¼ìŒ ================= */
function playDing(){
  const a=new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"); a.play();
}

/* ================= ì´ë²¤íŠ¸ ë°”ì¸ë”© ================= */
document.getElementById("btnOptimize").onclick=optimize;
document.getElementById("btnDispatch").onclick=dispatch;

/* ================= ì´ˆê¸° ë Œë” ================= */
render();
</script>
</body>
</html>
