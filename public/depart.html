<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - The Listen</title>

<!-- ZXing (ë¸Œë¼ìš°ì €ìš© ë°”ì½”ë“œ ìŠ¤ìºë„ˆ) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<style>
  :root{
    --brand:#007bff; --ink:#0f172a; --muted:#6b7280; --bg:#f7f9fc; --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif;color:var(--ink)}
  header{
    background:var(--brand);color:#fff;text-align:center;padding:12px 10px;
    font-weight:900;letter-spacing:.2px
  }

  /* ë¹„ëŒ€ì¹­ ë ˆì´ì•„ì›ƒ: ì¢Œ(65%) ì¹´ë©”ë¼ / ìš°(35%) ì»¨íŠ¸ë¡¤ */
  .wrap{max-width:1200px;margin:14px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:minmax(480px, 1.4fr) minmax(320px, .8fr);gap:16px}

  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.06);padding:16px}
  h3{margin:4px 0 10px}
  .muted{color:var(--muted);font-size:.92rem}

  /* ì¹´ë©”ë¼ í”„ë¦¬ë·° */
  .camWrap{position:relative;border-radius:14px;overflow:hidden;background:#000;min-height:280px}
  video{width:100%;height:auto;display:block}
  /* ì–‡ì€ ì¸ì‹ ê°€ì´ë“œ ë¼ì¸ */
  .guide{
    position:absolute;left:6%;right:6%;top:50%;transform:translateY(-50%);
    height:2px;background:rgba(0,123,255,.95);box-shadow:0 0 12px rgba(0,123,255,.55)
  }
  .camBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:800}
  .btn.gray{background:#64748b}
  .btn.green{background:#10b981}
  .btn.orange{background:#f59e0b}
  .btn:disabled{opacity:.4;cursor:not-allowed}

  /* ìš°ì¸¡ íŒ¨ë„ */
  .kpiBox{
    display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px
  }
  .kpi{background:#f2f6ff;border-radius:12px;padding:10px 12px}
  .kpi .label{color:#3563ff;font-size:.85rem}
  .kpi .val{font-size:22px;font-weight:900}

  .list{max-height:46vh;overflow:auto;border:1px dashed #e5e7eb;border-radius:12px;padding:8px;background:#fff}
  .row{display:flex;gap:8px;margin:8px 0}
  input[type="text"]{flex:1;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0}
  .pill b{font-weight:800}
  .pill .x{background:#ef4444;color:#fff;border:none;border-radius:8px;padding:2px 6px;cursor:pointer}

  /* ê³ ê°ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸° (ì¡°ë‚¨ë™ 50ëª…) */
  details{margin-top:12px}
  details summary{cursor:pointer;font-weight:800}
  .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;max-height:32vh;overflow:auto}
  .cardMini{border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .cardMini .ttl{font-weight:900}
  .badge{display:inline-block;background:#eef4ff;color:#3563ff;padding:2px 8px;border-radius:999px;font-size:.8rem;margin-left:6px}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ Â· ì¹´ë©”ë¼ ìŠ¤ìº” + HID ìŠ¤ìºë„ˆ Â· ìµœì ê²½ë¡œ Â· ì¶œë°œì „ì†¡</header>

<div class="wrap">
  <div class="grid">
    <!-- ì¢Œ: ì¹´ë©”ë¼(í¬ê²Œ) -->
    <section class="card">
      <h3>ğŸ“¸ í›„ë©´ ì¹´ë©”ë¼ ë°”ì½”ë“œ ìŠ¤ìº”</h3>
      <div class="camWrap">
        <video id="preview" muted playsinline></video>
        <div class="guide"></div>
      </div>
      <div class="camBtns">
        <button class="btn" id="btnStart">ì¹´ë©”ë¼ ì‹œì‘(í›„ë©´)</button>
        <button class="btn gray" id="btnStop">ì •ì§€</button>
        <button class="btn" id="btnTorch" style="display:none;">í”Œë˜ì‹œ í† ê¸€</button>
      </div>
      <p class="muted">ê°€ì´ë“œ ë¼ì¸ ìœ„ë¡œ ë°”ì½”ë“œë¥¼ ì–‡ê²Œ ë§ì¶”ë©´ ì¸ì‹ë¥ ì´ ê°€ì¥ ì¢‹ìŠµë‹ˆë‹¤.</p>
    </section>

    <!-- ìš°: ì»¨íŠ¸ë¡¤ (ì¢ê²Œ) -->
    <aside class="card">
      <h3>ğŸ”¢ ìŠ¤ìº”/ìŠ¤ìºë„ˆ ì…ë ¥ <span id="scanCount" style="font-weight:900">0</span> ê±´</h3>

      <div class="kpiBox">
        <div class="kpi"><div class="label">ìŠ¤ìº” ìˆ˜ëŸ‰</div><div class="val" id="kpiScan">0</div></div>
        <div class="kpi"><div class="label">í…ŒìŠ¤íŠ¸ ê³ ê°</div><div class="val" id="kpiCust">0</div></div>
      </div>

      <div class="row">
        <input id="scanInput" type="text" placeholder="HID ìŠ¤ìºë„ˆ/ìˆ˜ê¸° ì…ë ¥(ì—”í„°)" />
        <button class="btn" id="btnAdd">ì¶”ê°€</button>
      </div>

      <div class="row">
        <!-- ì´ˆê¸°í™” ë²„íŠ¼ ë¹„í™œì„±í™”(ìš”ì²­ì‚¬í•­) -->
        <button class="btn gray" id="btnClear" disabled title="ìš´ì˜ ì•ˆì „ì„ ìœ„í•´ ë¹„í™œì„±í™”ë¨">ì´ˆê¸°í™”(ë¹„í™œì„±)</button>
        <button class="btn green" id="btnOptimize">ğŸ§­ ê²½ë¡œ ìµœì í™”</button>
        <button class="btn orange" id="btnDispatch">ğŸš€ ì¶œë°œ ì „ì†¡(ì§€ë„ë¡œ ì´ë™)</button>
      </div>

      <div class="list" id="pillList" aria-label="ìŠ¤ìº” ëª©ë¡"></div>

      <details id="custDetails" open>
        <summary>ğŸ‘¥ ì¡°ë‚¨ë™ í…ŒìŠ¤íŠ¸ ê³ ê° 50ëª… (ë¯¸ë¦¬ë³´ê¸°)</summary>
        <div class="row">
          <button class="btn" id="btnSeed">í…ŒìŠ¤íŠ¸ ê³ ê° 50ëª… ë‹¤ì‹œ ìƒì„±</button>
          <button class="btn gray" id="btnShuffle">ì„ê¸°</button>
        </div>
        <div class="cards" id="custCards"></div>
      </details>

      <p class="muted">ê²½ë¡œ ìµœì í™” ì‹œ í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ê³ ê°ì¹´ë“œì— <b>ë°°ì†¡ ìˆœì„œ ë²ˆí˜¸</b>ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤. â€œì¶œë°œ ì „ì†¡â€ì„ ëˆ„ë¥´ë©´ <b>map.html</b>ì´ ì´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ë§ˆì»¤ì™€ ê³ ê°ì¹´ë“œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</p>
    </aside>
  </div>
</div>

<script>
/* ===========================
   ìƒíƒœ ì €ì¥ì†Œ (localStorage)
   - scanList        : ìŠ¤ìº” ìš´ì†¡ì¥ ë°°ì—´
   - scanned         : ìŠ¤ìº” ê°œìˆ˜(ëŒ€ì‹œë³´ë“œ ì—°ë™)
   - deliveriesJSON  : ì§€ë„ì—ì„œ ì‚¬ìš©í•  ê³ ê° ë°ì´í„°(ìœ„ê²½ë„ í¬í•¨)
   - optimizeByGPS   : '1'ì´ë©´ ì§€ë„ì—ì„œ GPS ê¸°ì¤€ ì •ë ¬
   - startDispatch   : '1'ì´ë©´ ì§€ë„ì—ì„œ ì¶œë°œ ëª¨ë“œë¡œ ì§„ì…
   =========================== */
const $scanInput = document.getElementById('scanInput');
const $scanCount = document.getElementById('scanCount');
const $kpiScan   = document.getElementById('kpiScan');
const $kpiCust   = document.getElementById('kpiCust');
const $pillList  = document.getElementById('pillList');
const $custCards = document.getElementById('custCards');

let scanList = JSON.parse(localStorage.getItem('scanList') || '[]');
let customers = [];   // ì¡°ë‚¨ë™ 50ëª… (ìœ„ê²½ë„ í¬í•¨)
let optimized = false;

/* ==============
   ë„ìš°ë¯¸ í•¨ìˆ˜
   ============== */
function saveScan(){
  localStorage.setItem('scanList', JSON.stringify(scanList));
  localStorage.setItem('scanned', String(scanList.length));
}
function renderScan(){
  $pillList.innerHTML = scanList.map((code, i)=>`
     <span class="pill"><b>${code}</b> <button class="x" onclick="rmScan(${i})">X</button></span>
  `).join('') || '<div class="muted">ìŠ¤ìº” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  $scanCount.textContent = scanList.length;
  $kpiScan.textContent   = scanList.length;
  saveScan();
}
function addScan(v){
  v=(v||'').trim();
  if(!v) return;
  scanList.unshift(v);
  renderScan();
}
function rmScan(i){
  scanList.splice(i,1);
  renderScan();
}

/* ===========================
   1) ZXing ì¹´ë©”ë¼ ìŠ¤ìº”
   =========================== */
const codeReader = new ZXing.BrowserMultiFormatReader();
let currentStream=null, torchOn=false;

async function startCamera(){
  try{
    const devices=await ZXing.BrowserCodeReader.listVideoInputDevices();
    const backId = devices.find(d=>/back|í›„ë©´|environment/i.test(d.label))?.deviceId || devices?.[devices.length-1]?.deviceId;
    const v=document.getElementById('preview');
    await codeReader.decodeFromVideoDevice(backId, v, (result, err)=>{
      if(result){ addScan(result.getText()); }
    });
    currentStream=v.srcObject;
    const track=currentStream?.getVideoTracks?.()[0];
    document.getElementById('btnTorch').style.display = (track?.getCapabilities?.().torch ? 'inline-block' : 'none');
  }catch(e){
    console.warn(e);
    alert('ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
  }
}
function stopCamera(){
  codeReader.reset();
  const v=document.getElementById('preview');
  const s=v.srcObject; if(s){ s.getTracks().forEach(t=>t.stop()); v.srcObject=null; }
  currentStream=null;
}
function toggleTorch(){
  const track=currentStream?.getVideoTracks?.()[0]; if(!track) return;
  const caps=track.getCapabilities?.(); if(!caps?.torch) return;
  torchOn=!torchOn; track.applyConstraints({advanced:[{torch:torchOn}]});
}

/* ===========================
   2) ì¡°ë‚¨ë™ 50ëª… í…ŒìŠ¤íŠ¸ ê³ ê°
   - ìœ„ê²½ë„ í¬í•¨(ë¬´ì‘ìœ„ ë¶„í¬)
   - ìµœì´ˆ ì§„ì… ì‹œ ìë™ ìƒì„±
   =========================== */
function randomAround(lat, lng, meter){
  // meter ë°˜ê²½ ë‚´ ë¬´ì‘ìœ„ ì¢Œí‘œ
  const r = meter/111300; // â‰ˆ m to deg
  const u = Math.random(); const v = Math.random();
  const w = r * Math.sqrt(u);
  const t = 2 * Math.PI * v;
  const latOff = w * Math.cos(t);
  const lngOff = w * Math.sin(t) / Math.cos(lat * Math.PI/180);
  return [lat+latOff, lng+lngOff];
}
// ì¡°ë‚¨ë™ ì¤‘ì‹¬(ì‹œí¥ ì¥í˜„ì§€êµ¬ ê·¼ë°© ëŒ€ëµê°’)
const JONAM_CENTER = { lat: 37.3795, lng: 126.8060 };

function seedCustomers(count=50){
  const list=[];
  for(let i=1;i<=count;i++){
    const dong = 100 + Math.floor(Math.random()*6);   // 100~105ë™ ëŠë‚Œ
    const ho   = 101 + Math.floor(Math.random()*1500); // ì„ì˜ í˜¸ìˆ˜
    const [lat,lng] = randomAround(JONAM_CENTER.lat, JONAM_CENTER.lng, 600); // 600m ë°˜ê²½
    list.push({
      id:`JONAM-${dong}-${ho}`,
      name:`ì¡°ë‚¨ê³ ê°${i}`,
      phone:`010-${String(1000+i).padStart(4,'0')}-${String(2000+i).padStart(4,'0')}`,
      address:`ê²½ê¸°ë„ ì‹œí¥ì‹œ ì¡°ë‚¨ë™ (í…ŒìŠ¤íŠ¸) ${dong}ë™ ${ho}í˜¸`,
      boxes: 1 + (i%3),
      lat, lng,
      order: null // ìµœì í™” í›„ ë¶€ì—¬
    });
  }
  return list;
}
function renderCustomerPreview(){
  $kpiCust.textContent = customers.length;
  $custCards.innerHTML = customers.slice(0,12).map(c=>`
    <div class="cardMini">
      <div class="ttl">${c.name} <span class="badge">${c.address.match(/(\d+ë™ \d+í˜¸)/)?.[1]||''}</span></div>
      <div class="muted">ìš´ì†¡ì¥: ${c.id}</div>
      <div class="muted">ì¢Œí‘œ: ${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}</div>
      <div class="muted">ë°•ìŠ¤: ${c.boxes}ê°œ</div>
      <div class="muted">ìˆœë²ˆ: ${c.order??'-'}</div>
    </div>
  `).join('') || '<div class="muted">ê³ ê° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
}
function initCustomers(){
  const cached = localStorage.getItem('deliveriesJSON');
  if(cached){
    try{
      customers = JSON.parse(cached);
      // ì¢Œí‘œê°€ ì—†ëŠ” ì´ì „ í˜•ì‹ì´ë©´ ìƒˆë¡œ ì‹œë“œ
      if(!Array.isArray(customers) || !customers[0]?.lat){ customers = seedCustomers(50); }
    }catch{ customers = seedCustomers(50); }
  }else{
    customers = seedCustomers(50);
  }
  renderCustomerPreview();
}

/* ===========================
   3) ê²½ë¡œ ìµœì í™” (Haversine)
   - í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ ê°€ê¹Œìš´ ìˆœìœ¼ë¡œ order ë¶€ì—¬
   =========================== */
function distKm(a,b,c,d){
  const R=6371, dLat=(c-a)*Math.PI/180, dLng=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
}
function optimizeByGPS(){
  if(!navigator.geolocation){
    alert('GPSê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.');
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const myLat=pos.coords.latitude, myLng=pos.coords.longitude;
    customers.sort((a,b)=>distKm(myLat,myLng,a.lat,a.lng)-distKm(myLat,myLng,b.lat,b.lng));
    customers.forEach((c,idx)=>c.order = idx+1);
    optimized = true;
    alert('ğŸ§­ í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ë°°ì†¡ ìˆœì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
    renderCustomerPreview();
  }, err=>{
    console.warn(err);
    alert('GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
  }, {enableHighAccuracy:true});
}

/* ===========================
   4) ì¶œë°œ ì „ì†¡ â†’ map.html ì—°ë™
   - deliveriesJSON ì €ì¥
   - optimizeByGPS, startDispatch í”Œë˜ê·¸ ì„¤ì •
   =========================== */
function dispatchToMap(){
  // ìŠ¤ìº” ìˆ˜ëŸ‰ ë°˜ì˜
  localStorage.setItem('scanned', String(scanList.length));
  // ê³ ê° ë°ì´í„° ì €ì¥
  localStorage.setItem('deliveriesJSON', JSON.stringify(customers));
  // ì§€ë„ì—ì„œ GPS ì •ë ¬ ì‚¬ìš©ì—¬ë¶€
  localStorage.setItem('optimizeByGPS', optimized ? '1' : '0');
  // ì¶œë°œ ëª¨ë“œ
  localStorage.setItem('startDispatch', '1');
  // ì´ ê±´ìˆ˜(ëŒ€ì‹œë³´ë“œìš©)
  localStorage.setItem('totalDeliveries', String(customers.length));

  alert('ğŸš€ ì¶œë°œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ë„ í™”ë©´ì—ì„œ ê²½ë¡œ/ê³ ê°ì¹´ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
  location.href = 'map.html';
}

/* ===========================
   ì´ë²¤íŠ¸ ë°”ì¸ë”© / ì´ˆê¸°í™”
   =========================== */
document.getElementById('btnStart').onclick  = startCamera;
document.getElementById('btnStop').onclick   = stopCamera;
document.getElementById('btnTorch').onclick  = toggleTorch;

document.getElementById('btnAdd').onclick    = ()=>{ addScan($scanInput.value); $scanInput.value=''; $scanInput.focus(); };
$scanInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ addScan($scanInput.value); $scanInput.value=''; }});

document.getElementById('btnOptimize').onclick = optimizeByGPS;
document.getElementById('btnDispatch').onclick = dispatchToMap;

document.getElementById('btnSeed').onclick = ()=>{
  customers = seedCustomers(50);
  optimized = false;
  renderCustomerPreview();
  alert('ì¡°ë‚¨ë™ í…ŒìŠ¤íŠ¸ ê³ ê° 50ëª…ì´ ìƒˆë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
};
document.getElementById('btnShuffle').onclick = ()=>{
  customers.sort(()=>Math.random()-0.5);
  customers.forEach(c=>c.order=null);
  optimized=false;
  renderCustomerPreview();
};

function boot(){
  renderScan();
  initCustomers();
  // HID ìŠ¤ìºë„ˆ í¬ì»¤ìŠ¤ ìœ ì§€(ì‚¬ìš©ì í¸ì˜)
  setInterval(()=>{ if(document.activeElement!==$scanInput) $scanInput.focus(); }, 1500);
}
boot();

// ì „ì—­ ì œê±°ìš©(í•„ìš” ì‹œ ë””ë²„ê¹…)
// window._dump = ()=>({scanList, customers});
</script>
</body>
</html>
