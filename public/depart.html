<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - The Listen</title>
<style>
  :root{--brand:#007bff;--bg:#f7f9fc;--card:#fff;--muted:#6b7280;--border:#e5e7eb}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
  .wrap{max-width:520px;margin:0 auto;padding:12px}
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
  .btn{border:none;border-radius:10px;padding:12px 14px;font-weight:800;color:#fff;background:var(--brand);cursor:pointer}
  .btn.full{width:100%} .btn.gray{background:#6b7280} .btn.green{background:#10b981} .btn.orange{background:#f59e0b}
  .stack{display:flex;gap:8px;flex-wrap:wrap}
  .list{max-height:440px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px}
  .item{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px}
  .muted{color:var(--muted)}
  .row{display:flex;align-items:center;gap:10px}
  .order{min-width:36px;height:36px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900}
  a.tel{color:#007bff;text-decoration:none}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ (ëŒ€ì‹œë³´ë“œ)</header>
<div class="wrap">

  <div class="card">
    <div class="stack">
      <button class="btn orange full" onclick="location.href='waybill.html'">ğŸ“¸ ìš´ì†¡ì¥ ìŠ¤ìº”/ì…ë ¥ (ì´ë™)</button>
      <button class="btn green full" id="btnOptimize">ğŸ§­ GPS ìµœì  ê²½ë¡œ ì •ë ¬</button>
      <button class="btn full" id="btnDispatch">ğŸš€ ì¶œë°œ ì „ì†¡ â†’ ì§€ë„</button>
    </div>
    <div class="muted" style="margin-top:8px">â€» ìš´ì†¡ì¥ ìŠ¤ìº”/ìˆ˜ê¸°ëŠ” waybill.htmlì—ì„œë§Œ ì§„í–‰í•©ë‹ˆë‹¤.</div>
  </div>

  <div class="card">
    <b>ê³ ê° ëª©ë¡(ìŠ¤í…Œì´ì§•)</b>
    <div id="list" class="list" style="margin-top:8px"></div>
  </div>
</div>

<script>
const STAGING_KEY = 'stagingDeliveries';    // waybill.htmlì´ ì—¬ê¸°ì— ìŒ“ìŒ
const FINAL_KEY   = 'deliveriesJSON';       // map.htmlì´ ì½ìŒ

let customers = [];
function load(){ try{ customers = JSON.parse(localStorage.getItem(STAGING_KEY)||'[]'); }catch{ customers=[]; } }
function save(){ localStorage.setItem(STAGING_KEY, JSON.stringify(customers)); }

function render(){
  const box = document.getElementById('list');
  if(!customers.length){ box.innerHTML = '<div class="muted">ìŠ¤í…Œì´ì§•ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìš´ì†¡ì¥ ìŠ¤ìº”/ì…ë ¥ì„ ì§„í–‰í•˜ì„¸ìš”.</div>'; return; }
  box.innerHTML = customers.map((c,i)=>`
    <div class="item">
      <div class="row">
        <div class="order">${c.order ?? i+1}</div>
        <div style="flex:1">
          <div><b>${c.name||'-'}</b> Â· ${c.address||'-'}</div>
          <div>ğŸ“ <a class="tel" href="tel:${c.phone||''}">${c.phone||'-'}</a> Â· ğŸ“¦ ${Array.isArray(c.waybills)?c.waybills.length:0}ê°œ</div>
          <div class="muted">ìš´ì†¡ì¥: ${(c.waybills||[]).join(', ')||'-'}</div>
        </div>
      </div>
    </div>
  `).join('');
}

function optimize(){
  if(!navigator.geolocation) return alert('GPS ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    customers.sort((a,b)=>{
      const da = Math.hypot((a.lat||0)-latitude, (a.lng||0)-longitude);
      const db = Math.hypot((b.lat||0)-latitude, (b.lng||0)-longitude);
      return da - db;
    });
    customers.forEach((c,i)=>c.order=i+1);
    save(); render();
    alert('ğŸ§­ GPS ê¸°ì¤€ìœ¼ë¡œ ìˆœì„œê°€ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }, ()=>alert('GPS ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
}

function dispatch(){
  if(!customers.length) return alert('ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
  localStorage.setItem(FINAL_KEY, JSON.stringify(customers));    // ìµœì¢… ì„¸íŠ¸
  localStorage.setItem('startDispatch','1');
  localStorage.setItem('optimizeByGPS','1');
  alert('ğŸš€ ì¶œë°œ ì „ì†¡ ì™„ë£Œ! ì§€ë„ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
  location.href='map.html';
}

document.getElementById('btnOptimize').onclick=optimize;
document.getElementById('btnDispatch').onclick=dispatch;

load(); render();
</script>
</body>
</html>
