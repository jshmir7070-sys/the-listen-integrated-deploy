<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - The Listen</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
:root{--brand:#007bff;--gray:#6b7280;--green:#10b981;--orange:#f59e0b;--red:#ef4444;}
body{margin:0;font-family:"Noto Sans KR",sans-serif;background:#f7f9fc}
header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
.wrap{max-width:480px;margin:auto;padding:12px}
.card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
.btn{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:6px;
  border:none;border-radius:10px;padding:12px 10px;font-weight:800;color:#fff;cursor:pointer}
.btn.orange{background:var(--orange)}
.btn.green{background:var(--green)}
.btn.blue{background:var(--brand)}
.cards{max-height:440px;overflow:auto;border:1px solid #eef2f7;border-radius:10px;padding:8px}
.citem{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-bottom:8px}
.crow{display:flex;justify-content:space-between;align-items:center;gap:6px}
.order{min-width:36px;height:36px;border-radius:50%;background:#007bff;color:#fff;
  display:flex;align-items:center;justify-content:center;font-weight:900}
.phone{color:#007bff;text-decoration:none;font-weight:700}
.high{border:2px solid var(--red);background:#fff0f0}
.kpi{display:flex;justify-content:space-between;margin-bottom:6px;font-weight:900}
.footer{display:flex;gap:8px;margin-top:10px}
.muted{color:#6b7280;font-size:.9rem;text-align:center}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ (The Listen)</header>

<div class="wrap">

  <!-- ìƒë‹¨ ë²„íŠ¼ 3ê°œ ëŒ€ì¹­ -->
  <div class="card">
    <div class="footer">
      <button class="btn orange" id="btnWaybill">ğŸ“¦ ìš´ì†¡ì¥ ì…ë ¥</button>
      <button class="btn green" id="btnOptimize">ğŸ§­ ìµœì  ê²½ë¡œ</button>
      <button class="btn blue" id="btnDispatch">ğŸš€ ì¶œë°œ ì „ì†¡</button>
    </div>
  </div>

  <!-- ê³ ê° ì¹´ë“œ -->
  <div class="card">
    <div class="kpi"><span>ê³ ê° ì¹´ë“œ(ì¡°ë‚¨ë™)</span><span id="custCount">0</span></div>
    <div id="cards" class="cards"></div>
    <div class="muted">â€» ê³ ê°€í’ˆì€ <span style="color:#ef4444;">ë¹¨ê°„ í…Œë‘ë¦¬</span>ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>

</div>

<script>
let customers=[];

// ğŸ§© ê³ ê° 50ëª… ìë™ ìƒì„± (ê³ ê°€í’ˆ 10%)
function seedCustomers(n=50){
  const arr=[], baseLat=37.3795, baseLng=126.8060;
  for(let i=1;i<=n;i++){
    const lat=baseLat+(Math.random()-0.5)*0.01;
    const lng=baseLng+(Math.random()-0.5)*0.01;
    const dong=100+(i%20), ho=100+i;
    const highValue=Math.random()<0.1; // 10% ê³ ê°€í’ˆ
    arr.push({
      id:`JONAM-${dong}-${ho}`,
      name:`ì¡°ë‚¨ê³ ê°${i}`,
      phone:`010-${String(1000+i).padStart(4,'0')}-${String(2000+i).padStart(4,'0')}`,
      address:`ê²½ê¸°ë„ ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${dong}ë™ ${ho}í˜¸`,
      boxes:1+(i%3), highValue, lat,lng,order:null
    });
  }
  return arr;
}

function renderCards(){
  document.getElementById('custCount').textContent=customers.length;
  document.getElementById('cards').innerHTML=customers.map(c=>`
    <div class="citem ${c.highValue?'high':''}">
      <div class="crow">
        <div class="order">${c.order??'-'}</div>
        <div>
          <div><b>${c.name}</b> ${c.highValue?'ğŸ”´':''}</div>
          <div>${c.address}</div>
          <div>ğŸ“¦ ${c.boxes}ê°œ Â· <a href="tel:${c.phone}" class="phone">ğŸ“</a></div>
        </div>
      </div>
    </div>
  `).join('');
}

// ğŸš¦ ê²½ë¡œ ìµœì í™”
function optimize(){
  if(!navigator.geolocation)return alert('GPS ê¶Œí•œ í—ˆìš© í•„ìš”');
  navigator.geolocation.getCurrentPosition(pos=>{
    const [a,b]=[pos.coords.latitude,pos.coords.longitude];
    const dist=(x1,y1)=>Math.hypot(x1-a,y1-b);
    customers.sort((x,y)=>dist(x.lat,x.lng)-dist(y.lat,y.lng));
    customers.forEach((c,i)=>c.order=i+1);
    localStorage.setItem('deliveriesJSON',JSON.stringify(customers));
    localStorage.setItem('optimizeByGPS','1');
    alert('ğŸ§­ GPS ê¸°ì¤€ìœ¼ë¡œ ìˆœë²ˆì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    voiceGuide();
    renderCards();
  });
}

// ğŸ—£ï¸ ìˆœë²ˆ ìŒì„± ì•ˆë‚´
function voiceGuide(){
  if('speechSynthesis' in window){
    const msg=new SpeechSynthesisUtterance('ë°°ì†¡ ìˆœì„œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. 1ë²ˆ ê³ ê°ë¶€í„° ì‹œì‘í•˜ì„¸ìš”.');
    msg.lang='ko-KR';
    speechSynthesis.speak(msg);
  }
}

// ğŸš€ ì¶œë°œ ì „ì†¡
function dispatch(){
  const notSent=customers.filter(c=>!c.sent);
  const sent=JSON.parse(localStorage.getItem('sentCustomers')||'[]');
  localStorage.setItem('sentCustomers',JSON.stringify(sent.concat(notSent)));
  localStorage.setItem('deliveriesJSON',JSON.stringify(customers));
  localStorage.setItem('startDispatch','1');
  alert(`ğŸš€ ${notSent.length}ê±´ ì¶œë°œ ì „ì†¡ ì™„ë£Œ`);
  location.href='map.html';
  // depart/waybill ë°ì´í„° ì´ˆê¸°í™”
  localStorage.removeItem('scanList');
  localStorage.removeItem('waybillCustomers');
}

// ğŸ“¦ ìš´ì†¡ì¥ í˜ì´ì§€ë¡œ ì´ë™
document.getElementById('btnWaybill').onclick=()=>location.href='waybill.html';
document.getElementById('btnOptimize').onclick=optimize;
document.getElementById('btnDispatch').onclick=dispatch;

(function init(){
  const saved=JSON.parse(localStorage.getItem('waybillCustomers')||'[]');
  customers=saved.length?saved:seedCustomers(50);
  renderCards();
})();
</script>
</body>
</html>
