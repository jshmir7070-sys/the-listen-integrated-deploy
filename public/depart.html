<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - The Listen</title>
<style>
  :root{--brand:#007bff;--bg:#f7f9fc;--card:#fff;--muted:#6b7280;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
  .wrap{max-width:520px;margin:0 auto;padding:12px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border:none;border-radius:10px;padding:12px 14px;font-weight:800;color:#fff;background:var(--brand);cursor:pointer}
  .btn.full{width:100%}
  .btn.gray{background:#6b7280}
  .btn.green{background:#10b981}
  .btn.orange{background:#f59e0b}
  .row{display:flex;gap:8px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kpi{display:flex;justify-content:space-between;margin:8px 0 2px;font-weight:900}
  .cards{max-height:520px;overflow:auto;border:1px solid #eef2f7;border-radius:12px;padding:8px}
  .citem{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-bottom:8px}
  .top{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .order{min-width:36px;height:36px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900}
  .addr{font-size:.95rem}
  .muted{color:#6b7280}
  .tile{border:2px dashed #c7d2fe;border-radius:12px;padding:12px;text-align:center;background:#eef2ff;cursor:pointer;font-weight:900}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ (The Listen)</header>
<div class="wrap">

  <!-- ìµœì ê²½ë¡œ: í„°ì¹˜ íƒ€ì¼ -->
  <div class="grid2" style="margin-bottom:10px;">
    <div class="tile" id="tileOptimize">ğŸ§­ ìµœì ê²½ë¡œ ì„¤ì •</div>
    <div class="tile" id="tileScanner">ğŸ“¸ ìŠ¤ìºë„ˆ/ìˆ˜ê¸°ì…ë ¥</div>
  </div>

  <!-- ê³ ê°ì¹´ë“œ -->
  <div class="card">
    <div class="kpi"><span>ê³ ê° ì¹´ë“œ</span><span id="custCount">0</span></div>
    <div class="cards" id="cards"></div>
    <div class="muted" style="margin-top:8px;">â€» ê³ ê°ì¹´ë“œëŠ” ìš´ì†¡ì¥/ì´ë¦„/ì£¼ì†Œë§Œ ë…¸ì¶œë©ë‹ˆë‹¤. ì „í™”ëŠ” ì•„ì´ì½˜ìœ¼ë¡œë§Œ ì—°ê²°ë©ë‹ˆë‹¤.</div>
  </div>

  <!-- í•˜ë‹¨ ë²„íŠ¼: ê°™ì€ ì¤„ ì¬ë°°ì¹˜ -->
  <div class="row">
    <button class="btn orange" style="flex:1" id="btnScanner">ğŸ“¸ ìŠ¤ìºë„ˆ/ì…ë ¥</button>
    <button class="btn green" style="flex:1" id="btnDispatch">ğŸš€ ì¶œë°œ ì „ì†¡ â†’ ì§€ë„</button>
  </div>
</div>

<script>
let customers=[];

// waybill & deliveries ë³‘í•©
function loadCustomers(){
  const wb=JSON.parse(localStorage.getItem('waybillCustomers')||'[]'); // waybill ì „ìš©
  const del=JSON.parse(localStorage.getItem('deliveriesJSON')||'[]');  // depart/map ê³µìš©
  // merge by id (waybill ìš°ì„ )
  const map=new Map();
  del.forEach(d=>map.set(d.id, d));
  wb.forEach(w=>{
    if(map.has(w.id)){
      const old=map.get(w.id);
      map.set(w.id, {...old, ...w}); // waybill í•„ë“œ ë®ì–´ì“°ê¸°
    } else {
      // ì¢Œí‘œ ì—†ìœ¼ë©´ ì„ì‹œ ì¢Œí‘œ í• ë‹¹
      map.set(w.id, {...w,
        lat: 37.3795+(Math.random()-0.5)*0.01,
        lng: 126.806+(Math.random()-0.5)*0.01,
        order: null
      });
    }
  });
  customers=[...map.values()];
}

// ë Œë” (ìš´ì†¡ì¥/ì´ë¦„/ì£¼ì†Œ + ì „í™” ì•„ì´ì½˜)
function render(){
  document.getElementById('custCount').textContent=customers.length;
  const maskPhone=(p)=>p? (p.slice(0,3)+'-****-'+p.slice(-4)) : '';
  const rows=customers.map((c,i)=>`
    <div class="citem">
      <div class="top">
        <div class="order">${c.order??'-'}</div>
        <div style="flex:1">
          <div><b>${c.name||'ê³ ê°'}</b> Â· <span class="addr">${c.address||''}</span></div>
          <div class="muted">ğŸ“¦ ${c.id||''}</div>
        </div>
        ${c.phone?`<a href="tel:${c.phone}" title="ì „í™”ê±¸ê¸°" style="text-decoration:none;font-size:20px">ğŸ“</a>`:''}
      </div>
    </div>
  `).join('');
  document.getElementById('cards').innerHTML=rows || '<div class="muted">ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ ë˜ëŠ” í•˜ë‹¨ì˜ ìŠ¤ìºë„ˆ/ì…ë ¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”.</div>';
}

// ìµœì ê²½ë¡œ(ìˆœë²ˆ ë¶€ì—¬)
function optimize(){
  if(!navigator.geolocation) return alert('GPS ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
  navigator.geolocation.getCurrentPosition(pos=>{
    const [a,b]=[pos.coords.latitude,pos.coords.longitude];
    const dist=(x1,y1)=>Math.hypot(x1-a,y1-b);
    customers.sort((x,y)=>dist(x.lat,x.lng)-dist(y.lat,y.lng));
    customers.forEach((c,i)=>c.order=i+1);
    localStorage.setItem('deliveriesJSON', JSON.stringify(customers));
    alert('ğŸ§­ GPS ê¸°ì¤€ìœ¼ë¡œ ë°°ì†¡ ìˆœì„œê°€ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    render();
  },()=>alert('GPS ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
}

// ì¶œë°œ ì „ì†¡ â†’ map.html
function dispatch(){
  localStorage.setItem('deliveriesJSON', JSON.stringify(customers));
  localStorage.setItem('startDispatch','1');
  localStorage.setItem('totalDeliveries', String(customers.length));
  location.href='map.html';
}

// ì´ë²¤íŠ¸
document.getElementById('tileOptimize').onclick=optimize;
document.getElementById('tileScanner').onclick=()=>location.href='waybill.html';
document.getElementById('btnScanner').onclick=()=>location.href='waybill.html';
document.getElementById('btnDispatch').onclick=dispatch;

// ì´ˆê¸°í™”
(function init(){
  loadCustomers();
  render();
})();
</script>
</body>
</html>
