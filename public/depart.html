<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - The Listen</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
  :root{--brand:#007bff;--bg:#f7f9fc;--card:#fff;--muted:#6b7280;--border:#e5e7eb;}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
  .wrap{max-width:520px;margin:0 auto;padding:12px}
  .topbar{display:flex;gap:8px;margin-bottom:12px}
  .btn{flex:1;text-align:center;padding:12px 0;font-weight:800;border:none;border-radius:10px;color:#fff;cursor:pointer}
  .btn.orange{background:#f59e0b}.btn.green{background:#10b981}.btn.blue{background:#007bff}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
  .kpi{display:flex;justify-content:space-between;font-weight:900;margin-bottom:6px}
  .cards{max-height:64vh;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px}
  .citem{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px}
  .crow{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .order{min-width:36px;height:36px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900}
  .muted{color:var(--muted);font-size:.9rem}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ (The Listen)</header>
<div class="wrap">

  <!-- ìƒë‹¨ ëŒ€ì¹­ 3ë²„íŠ¼ -->
  <div class="topbar">
    <button class="btn orange" id="btnScan">ğŸ“¦ ìš´ì†¡ì¥ ìŠ¤ìº”</button>
    <button class="btn green"  id="btnOptimize">ğŸ§­ ìµœì  ê²½ë¡œ</button>
    <button class="btn blue"   id="btnDispatch">ğŸš€ ì¶œë°œ ì „ì†¡</button>
  </div>

  <div class="card">
    <div class="kpi"><span>ì´ ê³ ê°</span><span id="custCount">0</span></div>
    <div class="cards" id="cards"></div>
    <div class="muted">â€» ë™ì¼ ê³ ê°(ì´ë¦„Â·ì „í™”Â·ì£¼ì†Œ ì¤‘ 2ê°œ ì´ìƒ ì¼ì¹˜)ì€ ìë™ ë³‘í•©ë˜ë©°, ë°•ìŠ¤ ìˆ˜ëŸ‰ë§Œ í•©ì‚°/í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>
</div>

<script>
const cardsDiv=document.getElementById("cards");
let customers=JSON.parse(localStorage.getItem("customers")||"[]");
let waybillDetails=JSON.parse(localStorage.getItem("waybillDetails")||"{}");
let scanEvents=JSON.parse(localStorage.getItem("scanEvents")||"[]");
let buffer="";

/* ë Œë” */
function render(){
  document.getElementById('custCount').textContent=customers.length;
  cardsDiv.innerHTML=customers.map(c=>`
    <div class="citem">
      <div class="crow">
        <div class="order">${c.order??'-'}</div>
        <div style="flex:1">
          <div><b>${c.name}</b></div>
          <div>${c.address}</div>
          <div class="muted">ğŸ“¦ ${c.boxes}ë°•ìŠ¤</div>
        </div>
      </div>
    </div>`).join('');
}

/* ìŠ¤ìºë„ˆ ì…ë ¥ */
window.addEventListener("keydown",e=>{
  if(e.key==="Enter"){ if(buffer.trim()) handleScan(buffer.trim(),"hid"); buffer=""; }
  else buffer+=e.key;
});

/* ìˆ˜ë™ ì´ë™ */
document.getElementById("btnScan").onclick=()=>location.href="waybill.html";

/* ìš´ì†¡ì¥ ì²˜ë¦¬ */
function handleScan(code,src){
  playDing();
  if(!waybillDetails[code]){
    const i=Object.keys(waybillDetails).length+1;
    waybillDetails[code]={
      waybill:code,
      sender:{name:`ë°œì†¡ì¸${i}`,phone:`02-1${i}34-${1000+i}`},
      receiver:{name:`ê³ ê°${i}`,phone:`010-55${i}5-${2000+i}`,address:`ê²½ê¸° ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${100+(i%6)}ë™ ${300+i}í˜¸`},
      product:{name:`ìƒí’ˆ${i}`},
      route:{hub:"ì‹œí¥HUB",path:["ì§‘í•˜","í—ˆë¸Œ","ë°°ì†¡"]},
      scannedAt:new Date().toISOString()
    };
  }
  scanEvents.push({code,time:new Date().toISOString(),src});
  localStorage.setItem("scanEvents",JSON.stringify(scanEvents));
  localStorage.setItem("waybillDetails",JSON.stringify(waybillDetails));
  const r=waybillDetails[code].receiver;
  mergeCustomer({id:code,name:r.name,phone:r.phone,address:r.address,boxes:1,lat:37.3795+(Math.random()-0.5)*0.01,lng:126.806+(Math.random()-0.5)*0.01});
  render();
}

/* ê³ ê° ë³‘í•© (2ê°œ ì´ìƒ ì¼ì¹˜) */
function mergeCustomer(n){
  const score=(a,b)=>['name','phone','address'].reduce((s,k)=>s+(a[k]&&b[k]&&a[k]===b[k]?1:0),0);
  const i=customers.findIndex(c=>score(c,n)>=2);
  if(i>=0) customers[i].boxes+=n.boxes; else customers.push(n);
  localStorage.setItem("customers",JSON.stringify(customers));
}

/* ìµœì  ê²½ë¡œ */
function optimize(){
  if(!customers.length) return alert("ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.");
  customers.forEach((c,i)=>c.order=i+1);
  localStorage.setItem("customers",JSON.stringify(customers));
  alert("ğŸ§­ ìµœì ê²½ë¡œ ì •ë ¬ ì™„ë£Œ");
  render();
}

/* ì¶œë°œ ì „ì†¡ */
function dispatch(){
  if(!customers.length) return alert("ì „ì†¡í•  ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.");
  localStorage.setItem("deliveriesJSON",JSON.stringify(customers));
  localStorage.setItem("startDispatch","1");
  alert("ğŸš€ ì¶œë°œ ë°ì´í„°ê°€ map.htmlë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
  localStorage.removeItem("customers");
  location.href="map.html";
}

/* íš¨ê³¼ìŒ */
function playDing(){new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();}
document.getElementById("btnOptimize").onclick=optimize;
document.getElementById("btnDispatch").onclick=dispatch;
render();
</script>
</body>
</html>
