<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - The Listen</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
  :root{--brand:#007bff;--bg:#f7f9fc;--card:#fff;--muted:#6b7280;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
  .wrap{max-width:480px;margin:0 auto;padding:12px}
  .topbar{display:flex;justify-content:space-between;gap:8px;margin-bottom:12px}
  .btn{flex:1;text-align:center;padding:12px 0;font-weight:800;border:none;border-radius:10px;color:#fff;background:var(--brand);cursor:pointer}
  .btn.orange{background:#f59e0b}
  .btn.green{background:#10b981}
  .btn.blue{background:#007bff}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
  .kpi{display:flex;justify-content:space-between;font-weight:900;margin-bottom:6px}
  .cards{max-height:420px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:8px}
  .citem{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-bottom:8px}
  .crow{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .order{min-width:36px;height:36px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900}
  .muted{color:#6b7280;font-size:.9rem}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ (The Listen)</header>
<div class="wrap">
  <div class="topbar">
    <button class="btn orange" id="btnScan">ğŸ“¦ ìš´ì†¡ì¥ ìŠ¤ìºë„ˆ</button>
    <button class="btn green" id="btnOptimize">ğŸ§­ ìµœì ê²½ë¡œ</button>
    <button class="btn blue" id="btnDispatch">ğŸš€ ì¶œë°œì „ì†¡</button>
  </div>

  <div class="card">
    <div class="kpi"><span>ì´ ê³ ê°</span><span id="custCount">0</span></div>
    <div class="cards" id="cards"></div>
    <div class="muted">â€» ë™ì¼ ê³ ê°(ì´ë¦„Â·ì£¼ì†ŒÂ·ì „í™”)ì´ë©´ ìë™ ë³‘í•©ë©ë‹ˆë‹¤.</div>
  </div>
</div>

<script>
/* ===== ê¸°ë³¸ ì„¤ì • ===== */
const reader=new ZXing.BrowserMultiFormatReader();
const cardsDiv=document.getElementById("cards");
let customers=JSON.parse(localStorage.getItem("customers")||"[]");
let scannedList=JSON.parse(localStorage.getItem("waybills")||"[]");

/* ===== ê³ ê°ì¹´ë“œ ë Œë” ===== */
function render(){
  document.getElementById('custCount').textContent=customers.length;
  cardsDiv.innerHTML=customers.map(c=>`
    <div class="citem">
      <div class="crow">
        <div class="order">${c.order??'-'}</div>
        <div style="flex:1">
          <div><b>${c.name}</b> Â· ${c.address}</div>
          <div class="muted">ğŸ“ ${c.phone}</div>
          <div class="muted">ğŸ“¦ ${c.boxes}ë°•ìŠ¤</div>
        </div>
      </div>
    </div>`).join('');
}

/* ===== ìŠ¤ìºë„ˆ/ì…ë ¥ ===== */
document.getElementById("btnScan").onclick=()=>location.href="waybill.html";

/* ë¸”ë£¨íˆ¬ìŠ¤ ìŠ¤ìºë„ˆ ì§ì ‘ ì…ë ¥ */
window.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&window._scanBuf){
    onScan(window._scanBuf.trim());
    window._scanBuf="";
  } else {
    window._scanBuf=(window._scanBuf||"")+e.key;
  }
});

function onScan(code){
  playDing();
  scannedList.push({code,time:new Date().toISOString()});
  localStorage.setItem("waybills",JSON.stringify(scannedList));
  const fake=getFakeCustomer(code);
  mergeCustomer(fake);
  render();
}

/* ===== ê°€ì§œ ê³ ê° ìƒì„± (í…ŒìŠ¤íŠ¸ìš©) ===== */
function getFakeCustomer(code){
  const i=customers.length+1;
  return {
    id:code,
    name:"ê³ ê°"+i,
    phone:"010-1111-"+String(1000+i),
    address:`ê²½ê¸°ë„ ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${100+Math.floor(i%5)}ë™ ${i+100}í˜¸`,
    boxes:1,
    lat:37.38+(Math.random()-0.5)*0.01,
    lng:126.80+(Math.random()-0.5)*0.01,
    order:null
  };
}

/* ===== ë³‘í•© ë¡œì§ ===== */
function mergeCustomer(newC){
  let same=customers.find(c=>
    (c.address===newC.address && (c.phone===newC.phone || c.name===newC.name)));
  if(same){same.boxes+=newC.boxes;}
  else{customers.push(newC);}
  localStorage.setItem("customers",JSON.stringify(customers));
}

/* ===== ìµœì  ê²½ë¡œ ===== */
function optimize(){
  if(!navigator.geolocation) return alert("GPS í—ˆìš© í•„ìš”");
  navigator.geolocation.getCurrentPosition(pos=>{
    const [a,b]=[pos.coords.latitude,pos.coords.longitude];
    const dist=(x1,y1)=>Math.hypot(x1-a,y1-b);
    customers.sort((x,y)=>dist(x.lat,x.lng)-dist(y.lat,y.lng));
    customers.forEach((c,i)=>c.order=i+1);
    alert("ğŸ§­ ìµœì ê²½ë¡œ ì„¤ì • ì™„ë£Œ");
    render();
  });
}

/* ===== ì¶œë°œ ì „ì†¡ ===== */
function dispatch(){
  localStorage.setItem("deliveriesJSON",JSON.stringify(customers));
  localStorage.setItem("startDispatch","1");
  localStorage.removeItem("customers");
  alert("ğŸš€ map.htmlë¡œ ì „ì†¡ ì™„ë£Œ");
  location.href="map.html";
}

/* ===== Ding ì‚¬ìš´ë“œ ===== */
function playDing(){
  const a=new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  a.play();
}

/* ===== ì´ë²¤íŠ¸ ===== */
document.getElementById("btnOptimize").onclick=optimize;
document.getElementById("btnDispatch").onclick=dispatch;

/* ===== ì´ˆê¸°í™” ===== */
render();
</script>
</body>
</html>
