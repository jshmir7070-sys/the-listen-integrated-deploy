<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - The Listen</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
  :root{--brand:#007bff;--bg:#f7f9fc;--card:#fff;}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
  .wrap{max-width:420px;margin:auto;padding:10px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.1);padding:14px;margin-bottom:10px}
  .btn{display:block;width:100%;border:none;border-radius:10px;padding:12px;font-size:15px;font-weight:700;color:#fff;background:var(--brand);margin-top:8px;cursor:pointer}
  .btn.green{background:#10b981}
  .btn.orange{background:#f59e0b}
  input[type="text"]{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:15px}
  video{width:100%;border-radius:10px;background:#000}
  .list{max-height:180px;overflow:auto;margin-top:10px;border:1px solid #eee;border-radius:10px;padding:6px}
  .pill{display:inline-block;background:#eef4ff;color:#007bff;border-radius:999px;padding:6px 10px;margin:4px;font-size:14px}
  .kpi{display:flex;justify-content:space-between;margin:10px 0;font-weight:800}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ (The Listen)</header>
<div class="wrap">
  <div class="card">
    <video id="preview" playsinline muted></video>
    <button class="btn" id="btnStart">ğŸ“¸ ì¹´ë©”ë¼ ì‹¤í–‰ (í›„ë©´)</button>
    <button class="btn orange" id="btnBack">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
  </div>

  <div class="card">
    <div class="kpi"><span>ìŠ¤ìº” ìˆ˜ëŸ‰</span><span id="scanCount">0</span></div>
    <input id="scanInput" type="text" placeholder="ìš´ì†¡ì¥ ì…ë ¥ ë˜ëŠ” ìŠ¤ìºë„ˆ ì…ë ¥" />
    <button class="btn green" id="btnAdd">ì¶”ê°€</button>
    <div class="list" id="scanList"></div>
  </div>

  <div class="card">
    <button class="btn orange" id="btnOptimize">ğŸ§­ ê²½ë¡œ ìµœì í™”</button>
    <button class="btn green" id="btnDispatch">ğŸš€ ì¶œë°œ ì „ì†¡ (ì§€ë„ ì´ë™)</button>
  </div>
</div>

<script>
const reader=new ZXing.BrowserMultiFormatReader();
const video=document.getElementById("preview");
const scanListDiv=document.getElementById("scanList");
let scanList=JSON.parse(localStorage.getItem("scanList")||"[]");

function renderList(){
  scanListDiv.innerHTML=scanList.map(s=>`<span class='pill'>${s}</span>`).join('');
  document.getElementById('scanCount').textContent=scanList.length;
  localStorage.setItem("scanList",JSON.stringify(scanList));
  localStorage.setItem("scanned",String(scanList.length));
}
document.getElementById('btnStart').onclick=()=>{
  reader.decodeFromVideoDevice(null,video,(res,err)=>{
    if(res){scanList.unshift(res.text);renderList();}
  });
};
document.getElementById('btnAdd').onclick=()=>{
  const v=scanInput.value.trim();
  if(v){scanList.unshift(v);renderList();scanInput.value='';}
};
scanInput.addEventListener('keydown',e=>{if(e.key==='Enter'){document.getElementById('btnAdd').click();}});
document.getElementById('btnBack').onclick=()=>{history.back();};

// í…ŒìŠ¤íŠ¸ ê³ ê° 50ëª… ìƒì„±
function makeCustomers(){
  const baseLat=37.3795, baseLng=126.8060; const arr=[];
  for(let i=1;i<=50;i++){
    const [lat,lng]=[baseLat+(Math.random()-0.5)*0.01, baseLng+(Math.random()-0.5)*0.01];
    arr.push({
      id:"JONAM"+i, name:"ì¡°ë‚¨ê³ ê°"+i,
      phone:"010-"+String(1000+i).padStart(4,'0')+"-"+String(2000+i).padStart(4,'0'),
      address:`ê²½ê¸°ë„ ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${100+Math.floor(i/10)}ë™ ${100+i}í˜¸`,
      boxes:1+(i%3), lat,lng
    });
  }
  return arr;
}
let customers=makeCustomers();

function optimize(){
  if(!navigator.geolocation) return alert('GPS ë¶ˆê°€');
  navigator.geolocation.getCurrentPosition(pos=>{
    const [a,b]=[pos.coords.latitude,pos.coords.longitude];
    const dist=(x1,y1)=>Math.hypot(x1-a,y1-b);
    customers.sort((x,y)=>dist(x.lat,x.lng)-dist(y.lat,y.lng));
    customers.forEach((c,i)=>c.order=i+1);
    localStorage.setItem('deliveriesJSON',JSON.stringify(customers));
    localStorage.setItem('optimizeByGPS','1');
    alert('ğŸ§­ GPS ê¸°ì¤€ ê²½ë¡œ ìµœì í™” ì™„ë£Œ');
  });
}
document.getElementById('btnOptimize').onclick=optimize;
document.getElementById('btnDispatch').onclick=()=>{
  localStorage.setItem('deliveriesJSON',JSON.stringify(customers));
  localStorage.setItem('startDispatch','1');
  alert('ğŸš€ ì¶œë°œ ì „ì†¡ ì™„ë£Œ â†’ ì§€ë„ í˜ì´ì§€ë¡œ ì´ë™');
  location.href='map.html';
};
renderList();
</script>
</body>
</html>
