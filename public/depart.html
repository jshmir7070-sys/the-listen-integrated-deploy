<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - The Listen</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
  :root{--brand:#007bff;--bg:#f7f9fc;--card:#fff;--muted:#6b7280;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:"Noto Sans KR",sans-serif}
  header{background:var(--brand);color:#fff;text-align:center;padding:12px;font-weight:900}
  .wrap{max-width:480px;margin:0 auto;padding:12px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border:none;border-radius:10px;padding:12px 14px;font-weight:800;color:#fff;background:var(--brand);cursor:pointer}
  .btn.full{width:100%}
  .btn.gray{background:#6b7280}
  .btn.green{background:#10b981}
  .btn.orange{background:#f59e0b}
  .stack{display:flex;gap:8px}
  .stack.col{flex-direction:column}
  input[type="text"]{flex:1;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px}
  video{width:100%;border-radius:12px;background:#000}
  .kpi{display:flex;justify-content:space-between;margin:8px 0 2px;font-weight:900}
  .muted{color:var(--muted);font-size:.9rem;margin:6px 0}
  .pill{display:inline-block;background:#eef4ff;color:#3563ff;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:14px}
  .list{max-height:180px;overflow:auto;border:1px solid #eef2f7;border-radius:10px;padding:8px}
  .cards{max-height:420px;overflow:auto;border:1px solid #eef2f7;border-radius:12px;padding:8px}
  .citem{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-bottom:8px}
  .crow{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .order{min-width:36px;height:36px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900}
  .addr{font-size:.95rem}
  .hit{outline:2px solid #10b981;box-shadow:0 0 0 4px rgba(16,185,129,.15)}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ (The Listen)</header>
<div class="wrap">

  <!-- ì¹´ë©”ë¼ + ì…ë ¥ + ì¶”ê°€ (í•˜ë‚˜ì˜ UI ê·¸ë£¹) -->
  <div class="card">
    <div class="stack col">
      <video id="preview" playsinline muted></video>
      <div class="stack">
        <button class="btn" id="btnStart">ğŸ“¸ í›„ë©´ì¹´ë©”ë¼</button>
        <input id="scanInput" type="text" placeholder="ìš´ì†¡ì¥ ì…ë ¥ ë˜ëŠ” ìŠ¤ìºë„ˆ(Enter)" />
        <button class="btn green" id="btnAdd">ì¶”ê°€</button>
      </div>
      <div class="muted">í›„ë©´ ì¹´ë©”ë¼ ì¸ì‹ + HID ìŠ¤ìºë„ˆ ì…ë ¥ì„ ì§€ì›í•©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ìŠ¤ìº” ëª©ë¡ -->
  <div class="card">
    <div class="kpi"><span>ìŠ¤ìº” ìˆ˜ëŸ‰</span><span id="scanCount">0</span></div>
    <div class="list" id="scanList" aria-label="ìŠ¤ìº” ëª©ë¡"></div>
  </div>

  <!-- ê³ ê°ì¹´ë“œ(ìµœëŒ€ 1000ê°œ ìŠ¤í¬ë¡¤) -->
  <div class="card">
    <div class="kpi"><span>ê³ ê° ì¹´ë“œ(ì¡°ë‚¨ë™)</span><span id="custCount">0</span></div>
    <div class="stack" style="gap:6px;margin-bottom:8px;">
      <button class="btn orange full" id="btnOptimize">ğŸ§­ ê²½ë¡œ ìµœì í™”(ìˆœë²ˆ ë¶€ì—¬)</button>
      <button class="btn full" id="btnDispatch">ğŸš€ ì¶œë°œ ì „ì†¡ â†’ ì§€ë„</button>
      <button class="btn gray full" id="btnBack">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>
    <div class="cards" id="cards"></div>
    <div class="muted">â€» ìˆœë²ˆì€ GPS ê±°ë¦¬ ê¸°ì¤€ì…ë‹ˆë‹¤. ì¶œë°œ ì „ì†¡ ì‹œ map.htmlì— ê·¸ëŒ€ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
  </div>

</div>

<script>
/* ========== ìƒíƒœ ========== */
const reader=new ZXing.BrowserMultiFormatReader();
const video=document.getElementById("preview");
const scanListDiv=document.getElementById("scanList");
const cardsDiv=document.getElementById("cards");
let scanList=JSON.parse(localStorage.getItem("scanList")||"[]");
let customers=[];

/* ========== ìŠ¤ìº” UI ========== */
function renderScan(){
  scanListDiv.innerHTML=scanList.map(s=>`<span class="pill">${s}</span>`).join('') || '<div class="muted">ìŠ¤ìº” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  document.getElementById('scanCount').textContent=scanList.length;
  localStorage.setItem("scanList",JSON.stringify(scanList));
  localStorage.setItem("scanned",String(scanList.length));
}
document.getElementById('btnStart').onclick=()=>{
  reader.decodeFromVideoDevice(null,video,(res,err)=>{
    if(res){ onScan(res.text); }
  });
};
document.getElementById('btnAdd').onclick=()=>{
  const v=scanInput.value.trim(); if(!v) return;
  onScan(v); scanInput.value='';
};
scanInput.addEventListener('keydown',e=>{if(e.key==='Enter'){document.getElementById('btnAdd').click();}});

/* ========== ê³ ê° 50ëª… ìë™ ìƒì„±(ì¡°ë‚¨ë™) ========== */
function seedCustomers(n=50){
  const baseLat=37.3795, baseLng=126.8060;
  const arr=[];
  for(let i=1;i<=n;i++){
    const lat=baseLat+(Math.random()-0.5)*0.01;
    const lng=baseLng+(Math.random()-0.5)*0.01;
    const dong=100+Math.floor(i%20); // 100~119ë™ ëŠë‚Œ
    const ho=100+i;
    arr.push({
      id:`JONAM-${dong}-${ho}`,
      name:`ì¡°ë‚¨ê³ ê°${i}`,
      phone:`010-${String(1000+i).padStart(4,'0')}-${String(2000+i).padStart(4,'0')}`,
      address:`ê²½ê¸°ë„ ì‹œí¥ì‹œ ì¡°ë‚¨ë™ ${dong}ë™ ${ho}í˜¸`,
      boxes:1+(i%3),
      lat,lng,
      order:null
    });
  }
  return arr;
}
function renderCards(focusId=null){
  document.getElementById('custCount').textContent=customers.length;
  cardsDiv.innerHTML=customers.map(c=>`
    <div class="citem ${focusId&&focusId===c.id?'hit':''}" id="row-${c.id}">
      <div class="crow">
        <div class="order">${c.order??'-'}</div>
        <div style="flex:1">
          <div><b>${c.name}</b> Â· <span class="addr">${c.address}</span></div>
          <div class="muted">ìš´ì†¡ì¥: ${c.id} Â· ğŸ“ ${c.phone} Â· ğŸ“¦ ${c.boxes}ê°œ</div>
        </div>
      </div>
    </div>
  `).join('');
  if(focusId){
    const el=document.getElementById(`row-${focusId}`);
    if(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); }
  }
}
function bootCustomers(){
  customers=seedCustomers(50); // ìµœì´ˆ 50ëª…
  renderCards();
}

/* ========== ìŠ¤ìº” ì²˜ë¦¬: ê³ ê°ì¹´ë“œ ë§¤ì¹­/í™œì„±í™” ========== */
function onScan(code){
  scanList.unshift(code);
  renderScan();
  // ìš´ì†¡ì¥ìœ¼ë¡œ ê³ ê° ì°¾ê¸° (ì •í™• ì¼ì¹˜, ì—†ìœ¼ë©´ ì¼ë¶€ ë§¤ì¹­)
  let hit = customers.find(c=>c.id===code);
  if(!hit){
    const part = code.split('-').slice(0,3).join('-');
    hit = customers.find(c=>c.id.includes(part));
  }
  if(hit){
    // ê°•ì¡° + ë§¨ ìœ„ë¡œ ì˜¬ë¦¬ê¸°(ì˜µì…˜)
    customers = customers
      .filter(c=>c.id!==hit.id)
      .map(c=>({...c})) // ë³µì œ
    customers.unshift(hit);
    renderCards(hit.id);
  } else {
    alert(`ê³ ê°ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n(ìš´ì†¡ì¥: ${code})`);
  }
}

/* ========== ê²½ë¡œ ìµœì í™”(ìˆœë²ˆ ë¶€ì—¬) ========== */
function optimize(){
  if(!navigator.geolocation) return alert('GPS ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
  navigator.geolocation.getCurrentPosition(pos=>{
    const [a,b]=[pos.coords.latitude,pos.coords.longitude];
    const dist=(x1,y1)=>Math.hypot(x1-a,y1-b);
    customers.sort((x,y)=>dist(x.lat,x.lng)-dist(y.lat,y.lng));
    customers.forEach((c,i)=>c.order=i+1);
    localStorage.setItem('deliveriesJSON',JSON.stringify(customers));
    localStorage.setItem('optimizeByGPS','1');
    alert('ğŸ§­ GPS ê¸°ì¤€ìœ¼ë¡œ ë°°ì†¡ ìˆœì„œ(1~N)ê°€ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    renderCards();
  },()=>alert('GPS ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
}

/* ========== ì¶œë°œ ì „ì†¡(ì§€ë„ ì—°ë™) ========== */
function dispatchToMap(){
  localStorage.setItem('deliveriesJSON',JSON.stringify(customers));
  localStorage.setItem('startDispatch','1');
  localStorage.setItem('totalDeliveries', String(customers.length));
  alert('ğŸš€ ì¶œë°œ ì „ì†¡ ì™„ë£Œ â†’ ì§€ë„ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
  location.href='map.html';
}

/* ========== ë’¤ë¡œê°€ê¸° ========== */
document.getElementById('btnOptimize').onclick=optimize;
document.getElementById('btnDispatch').onclick=dispatchToMap;
document.getElementById('btnBack').onclick=()=>history.back();

/* ========== ì´ˆê¸°í™” ========== */
(function init(){
  renderScan();
  bootCustomers();
})();
</script>
</body>
</html>
