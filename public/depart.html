<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°°ì†¡ì¶œë°œ - ë°”ì½”ë“œ ìŠ¤ìº” Â· ìŠ¤ìºë„ˆ ì—°ë™</title>

<!-- ZXing ë°”ì½”ë“œ ìŠ¤ìºë„ˆ (ë¸Œë¼ìš°ì €ìš©) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<style>
  body{margin:0;background:#f7f9fc;font-family:"Noto Sans KR",sans-serif}
  header{background:#007bff;color:#fff;text-align:center;padding:12px;font-weight:800}
  .wrap{max-width:920px;margin:14px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .card{background:#fff;border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.06);padding:14px}
  h3{margin:8px 0 10px}
  .row{margin:8px 0}
  input[type="text"]{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px}
  .btn{background:#007bff;color:#fff;border:none;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:700}
  .btn.gray{background:#6b7280}
  .btn.red{background:#ef4444}
  .btnRow{display:flex;gap:8px;flex-wrap:wrap}
  .list{max-height:48vh;overflow:auto;border:1px solid #eef2f7;border-radius:12px;padding:8px}
  .item{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #f1f5f9;padding:8px 4px}
  .muted{color:#6b7280;font-size:.9rem}
  .count{font-weight:900;font-size:18px}
  /* ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸° */
  .camWrap{position:relative;border-radius:12px;overflow:hidden;background:#000}
  video{width:100%;height:auto;display:block}
  /* ì–‡ì€ ë°”ì½”ë“œ ì¸ì‹ ê°€ì´ë“œ ë¼ì¸ */
  .guide{
    position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);
    height:2px;background:rgba(0,123,255,.9);
    box-shadow:0 0 12px rgba(0,123,255,.6);
  }
  .tip{color:#64748b;font-size:.9rem}
</style>
</head>
<body>
<header>ğŸšš ë°°ì†¡ì¶œë°œ Â· ë°”ì½”ë“œ ìŠ¤ìº” / ìŠ¤ìºë„ˆ ì—°ë™</header>

<div class="wrap">
  <div class="grid">
    <!-- ì¢Œì¸¡: ì¹´ë©”ë¼ ìŠ¤ìº” -->
    <div class="card">
      <h3>ğŸ“¸ ì¹´ë©”ë¼ ë°”ì½”ë“œ ìŠ¤ìº”</h3>
      <div class="camWrap">
        <video id="preview" muted playsinline></video>
        <div class="guide"></div>
      </div>
      <div class="row btnRow" style="margin-top:10px;">
        <button class="btn" id="btnStart">ì¹´ë©”ë¼ ì‹œì‘(í›„ë©´)</button>
        <button class="btn gray" id="btnStop">ì •ì§€</button>
        <button class="btn" id="btnTorch" style="display:none;">í”Œë˜ì‹œ í† ê¸€</button>
      </div>
      <div class="tip" style="margin-top:8px;">ê°€ì´ë“œ ë¼ì¸ ìœ„ë¡œ ë°”ì½”ë“œë¥¼ ì–‡ê²Œ ë§ì¶°ì£¼ì„¸ìš”.</div>
    </div>

    <!-- ìš°ì¸¡: ìŠ¤ìº”/ìŠ¤ìºë„ˆ ì…ë ¥ ë¦¬ìŠ¤íŠ¸ -->
    <div class="card">
      <h3>ğŸ”¢ ìŠ¤ìº” ëª©ë¡ <span class="count" id="scanCount">0</span> ê±´</h3>
      <div class="row">
        <input id="scanInput" type="text" placeholder="ìŠ¤ìºë„ˆ/ìˆ˜ê¸° ì…ë ¥ í¬ì»¤ìŠ¤(ì—”í„°ë¡œ ì¶”ê°€) â€” HID ìŠ¤ìºë„ˆ ëŒ€ì‘" />
      </div>
      <div class="btnRow">
        <button class="btn" id="btnAdd">ì¶”ê°€</button>
        <button class="btn gray" id="btnClear">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
      <div class="list" id="list"></div>

      <div class="row" style="margin-top:12px;border-top:1px dashed #e5e7eb;padding-top:12px;">
        <div class="btnRow">
          <button class="btn" id="btnOptimize">ğŸ§­ ìµœì  ê²½ë¡œ ì„¤ì •</button>
          <button class="btn" onclick="location.href='map.html'">í˜„ì¬ ì§€ë„ë³´ê¸° ì—°ê²°</button>
          <button class="btn gray" onclick="location.href='dashboard.html'">ëŒ€ì‹œë³´ë“œë¡œ</button>
        </div>
        <div class="tip" style="margin-top:8px;">
          â€¢ ë¸”ë£¨íˆ¬ìŠ¤/ìœ ì„  ìŠ¤ìºë„ˆëŠ” ëŒ€ë¶€ë¶„ <b>í‚¤ë³´ë“œ(HID) ì¥ì¹˜</b>ë¡œ ë™ì‘í•©ë‹ˆë‹¤. ì…ë ¥ì°½ í¬ì»¤ìŠ¤ë¥¼ ìœ ì§€í•˜ë©´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.<br/>
          â€¢ â€˜ìµœì  ê²½ë¡œ ì„¤ì •â€™ì„ ëˆ„ë¥´ë©´ í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ ì •ë ¬ í”Œë˜ê·¸ê°€ ì €ì¥ë˜ê³  <b>map.html</b>ì—ì„œ ë°˜ì˜ë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/** ===========================
 *  1) ìŠ¤ìº” ëª©ë¡ ìƒíƒœ ê´€ë¦¬
 * ========================== */
const $scanInput = document.getElementById('scanInput');
const $scanCount = document.getElementById('scanCount');
const $list = document.getElementById('list');
let scanList = JSON.parse(localStorage.getItem('scanList') || '[]');

function renderList(){
  $list.innerHTML = scanList.map((code, idx)=>`
    <div class="item">
      <div>
        <div><b>${code}</b></div>
        <div class="muted">ìš´ì†¡ì¥ ë²ˆí˜¸</div>
      </div>
      <button class="btn red" onclick="removeAt(${idx})">ì‚­ì œ</button>
    </div>
  `).join('');
  $scanCount.textContent = scanList.length;
  localStorage.setItem('scanList', JSON.stringify(scanList));
  localStorage.setItem('scanned', String(scanList.length)); // ëŒ€ì‹œë³´ë“œ ì—°ë™
}
function addCode(code){
  code = (code||'').trim();
  if(!code) return;
  // ì¤‘ë³µ ë°©ì§€(ì˜µì…˜) â€” í•„ìš”ì‹œ ì£¼ì„ í•´ì œ
  // if(scanList.includes(code)) return;
  scanList.unshift(code);
  renderList();
}
function removeAt(i){
  scanList.splice(i,1);
  renderList();
}
function clearAll(){
  scanList = [];
  renderList();
}
window.removeAt = removeAt;

// ì´ˆê¸° ë Œë”
renderList();
// ì…ë ¥ í¬ì»¤ìŠ¤ ìœ ì§€ â†’ ìŠ¤ìºë„ˆ ìë™ ì…ë ¥ìš©
$scanInput.focus();
setInterval(()=>{ if(document.activeElement!==$scanInput) $scanInput.focus(); }, 1500);

// ìˆ˜ê¸°/ìŠ¤ìºë„ˆ ì…ë ¥
document.getElementById('btnAdd').onclick = ()=> addCode($scanInput.value), $scanInput.value='';
$scanInput.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    addCode($scanInput.value);
    $scanInput.value='';
  }
});
document.getElementById('btnClear').onclick = clearAll;

/** ===========================
 *  2) ZXing ì¹´ë©”ë¼ ë°”ì½”ë“œ ìŠ¤ìº”
 * ========================== */
const codeReader = new ZXing.BrowserMultiFormatReader();
let currentStream = null;
let torchOn = false;

// ì¹´ë©”ë¼ ì‹œì‘(í›„ë©´ ìš°ì„ )
async function startCamera(){
  try{
    // í›„ë©´ì¹´ë©”ë¼ ìš°ì„ 
    const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
    let backCamId = devices.find(d => /back|í›„ë©´|environment/i.test(d.label))?.deviceId || devices?.[devices.length-1]?.deviceId;

    const preview = document.getElementById('preview');
    await codeReader.decodeFromVideoDevice(backCamId, preview, (result, err) => {
      if (result) {
        addCode(result.getText());
      }
    });

    // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì €ì¥ & í”Œë˜ì‹œ ì§€ì› ë²„íŠ¼ í‘œì‹œ
    currentStream = preview.srcObject;
    const track = currentStream?.getVideoTracks?.()[0];
    if (track && track.getCapabilities && track.getCapabilities().torch) {
      document.getElementById('btnTorch').style.display = 'inline-block';
    } else {
      document.getElementById('btnTorch').style.display = 'none';
    }
  }catch(e){
    console.warn(e);
    alert('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
  }
}

function stopCamera(){
  codeReader.reset();
  const preview = document.getElementById('preview');
  const stream = preview.srcObject;
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    preview.srcObject = null;
  }
  currentStream = null;
}

function toggleTorch(){
  const track = currentStream?.getVideoTracks?.()[0];
  if(!track) return;
  const caps = track.getCapabilities();
  if(!caps || !caps.torch) return;
  torchOn = !torchOn;
  track.applyConstraints({ advanced: [{ torch: torchOn }] }).catch(()=>{});
}

document.getElementById('btnStart').onclick = startCamera;
document.getElementById('btnStop').onclick  = stopCamera;
document.getElementById('btnTorch').onclick = toggleTorch;

/** ===========================
 *  3) ìµœì  ê²½ë¡œ ì„¤ì • â†’ map.html
 *     (ë°ëª¨: ì •ë ¬ í”Œë˜ê·¸ ì €ì¥)
 * ========================== */
document.getElementById('btnOptimize').onclick = ()=>{
  // í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ ì •ë ¬ í”Œë˜ê·¸
  localStorage.setItem('optimizeByGPS', '1');
  alert('í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ ìµœì  ê²½ë¡œ ì •ë ¬ì„ ì ìš©í•©ë‹ˆë‹¤. ì§€ë„ í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”.');
  location.href = 'map.html';
};
</script>
</body>
</html>

